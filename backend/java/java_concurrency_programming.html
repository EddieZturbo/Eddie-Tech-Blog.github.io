<!DOCTYPE html>
<html lang="en-US" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.60" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://mister-hope.github.io/backend/java/java_concurrency_programming.html"><meta property="og:site_name" content="Eddie-Tech-Blog"><meta property="og:title" content="Java Concurrency Programming"><meta property="og:description" content="ç†è®ºåŸºç¡€ CPU ç¼“å­˜æ¨¡å‹ CPU Cache ç¼“å­˜çš„æ˜¯å†…å­˜æ•°æ®ç”¨äºè§£å†³ CPU å¤„ç†é€Ÿåº¦å’Œå†…å­˜ä¸åŒ¹é…çš„é—®é¢˜(CPU å¤„ç†é€Ÿåº¦å’Œå†…å­˜å¤„ç†é€Ÿåº¦ä¸å¯¹ç­‰)ï¼Œ å†…å­˜ç¼“å­˜çš„æ˜¯ç¡¬ç›˜æ•°æ®ç”¨äºè§£å†³ç¡¬ç›˜è®¿é—®é€Ÿåº¦è¿‡æ…¢çš„é—®é¢˜ !image-20230412004416756 (https://eddie-typora-image.oss-cn-shenzhen.ali..."><meta property="og:type" content="article"><meta property="og:locale" content="en-US"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Java Concurrency Programming","image":[""],"dateModified":null,"author":[]}</script><title>Java Concurrency Programming | Eddie-Tech-Blog</title><meta name="description" content="ç†è®ºåŸºç¡€ CPU ç¼“å­˜æ¨¡å‹ CPU Cache ç¼“å­˜çš„æ˜¯å†…å­˜æ•°æ®ç”¨äºè§£å†³ CPU å¤„ç†é€Ÿåº¦å’Œå†…å­˜ä¸åŒ¹é…çš„é—®é¢˜(CPU å¤„ç†é€Ÿåº¦å’Œå†…å­˜å¤„ç†é€Ÿåº¦ä¸å¯¹ç­‰)ï¼Œ å†…å­˜ç¼“å­˜çš„æ˜¯ç¡¬ç›˜æ•°æ®ç”¨äºè§£å†³ç¡¬ç›˜è®¿é—®é€Ÿåº¦è¿‡æ…¢çš„é—®é¢˜ !image-20230412004416756 (https://eddie-typora-image.oss-cn-shenzhen.ali...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-71862533.css" as="style"><link rel="stylesheet" href="/assets/style-71862533.css">
    <link rel="modulepreload" href="/assets/app-7117916c.js"><link rel="modulepreload" href="/assets/framework-e28ace55.js"><link rel="modulepreload" href="/assets/java_concurrency_programming.html-8befd8c0.js"><link rel="modulepreload" href="/assets/java_concurrency_programming.html-1cc32300.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to main content</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header class="navbar" id="navbar"><div class="navbar-start"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><img class="logo" src="/logo.png" alt="Eddie-Tech-Blog"><!----><span class="site-name hide-in-pad">Eddie-Tech-Blog</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/" class="nav-link" aria-label="Home"><span class="font-icon icon iconfont icon-home" style=""></span>Home<!----></a></div><div class="nav-item hide-in-mobile"><a href="/eddie/" class="nav-link" aria-label="Expoler"><span class="font-icon icon iconfont icon-discover" style=""></span>Expoler<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Backend-Dev"><span class="title"><span class="font-icon icon iconfont icon-edit" style=""></span>Backend-Dev</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Java</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/backend/java/jvm.html" class="nav-link" aria-label="JVM"><span class="font-icon icon iconfont icon-edit" style=""></span>JVM<!----></a></li><li class="dropdown-subitem"><a href="/backend/java/java8.html" class="nav-link" aria-label="Java8"><span class="font-icon icon iconfont icon-edit" style=""></span>Java8<!----></a></li><li class="dropdown-subitem"><a aria-current="page" href="/backend/java/java_concurrency_programming.html" class="router-link-active router-link-exact-active nav-link active" aria-label="Java Concurrency Programming"><span class="font-icon icon iconfont icon-edit" style=""></span>Java Concurrency Programming<!----></a></li><li class="dropdown-subitem"><a href="/backend/java/Java.html" class="nav-link" aria-label="Java"><span class="font-icon icon iconfont icon-edit" style=""></span>Java<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Database</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/backend/database/mysql.html" class="nav-link" aria-label="MySQL  Basic --- advanced"><span class="font-icon icon iconfont icon-edit" style=""></span>MySQL  Basic --- advanced<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Dev-FrameWork</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/backend/dev_framework/SpringBoot.html" class="nav-link" aria-label="Spring Boot"><span class="font-icon icon iconfont icon-edit" style=""></span>Spring Boot<!----></a></li><li class="dropdown-subitem"><a href="/backend/dev_framework/SpringMVC.html" class="nav-link" aria-label="SpringMVC"><span class="font-icon icon iconfont icon-edit" style=""></span>SpringMVC<!----></a></li><li class="dropdown-subitem"><a href="/backend/dev_framework/Spring5.html" class="nav-link" aria-label="Spring5"><span class="font-icon icon iconfont icon-edit" style=""></span>Spring5<!----></a></li><li class="dropdown-subitem"><a href="/backend/dev_framework/Mybatis.html" class="nav-link" aria-label="Mybatis"><span class="font-icon icon iconfont icon-edit" style=""></span>Mybatis<!----></a></li><li class="dropdown-subitem"><a href="/backend/dev_framework/MybatisPlus.html" class="nav-link" aria-label="MybatisPlus"><span class="font-icon icon iconfont icon-edit" style=""></span>MybatisPlus<!----></a></li><li class="dropdown-subitem"><a href="/backend/dev_framework/SpringCloud.html" class="nav-link" aria-label="SpringCloud &amp; ~Aibaba"><span class="font-icon icon iconfont icon-edit" style=""></span>SpringCloud &amp; ~Aibaba<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Middleware</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/backend/middleware/MQ.html" class="nav-link" aria-label="MQ"><span class="font-icon icon iconfont icon-edit" style=""></span>MQ<!----></a></li><li class="dropdown-subitem"><a href="/backend/middleware/Redis.html" class="nav-link" aria-label="Redis"><span class="font-icon icon iconfont icon-edit" style=""></span>Redis<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Skills</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/backend/skills/DataStructureAlgorithm.html" class="nav-link" aria-label="DataStructureAlgorithm"><span class="font-icon icon iconfont icon-edit" style=""></span>DataStructureAlgorithm<!----></a></li><li class="dropdown-subitem"><a href="/backend/skills/ComputerNetwork.html" class="nav-link" aria-label="ComputerNetwork"><span class="font-icon icon iconfont icon-edit" style=""></span>ComputerNetwork<!----></a></li><li class="dropdown-subitem"><a href="/backend/skills/OperatingSystem.html" class="nav-link" aria-label="OperatingSystem"><span class="font-icon icon iconfont icon-edit" style=""></span>OperatingSystem<!----></a></li><li class="dropdown-subitem"><a href="/backend/skills/Methodology.html" class="nav-link" aria-label="Methodology"><span class="font-icon icon iconfont icon-edit" style=""></span>Methodology<!----></a></li><li class="dropdown-subitem"><a href="/backend/skills/IO.html" class="nav-link" aria-label="IO"><span class="font-icon icon iconfont icon-edit" style=""></span>IO<!----></a></li><li class="dropdown-subitem"><a href="/backend/skills/Netty.html" class="nav-link" aria-label="Netty"><span class="font-icon icon iconfont icon-edit" style=""></span>Netty<!----></a></li><li class="dropdown-subitem"><a href="/backend/skills/Linux.html" class="nav-link" aria-label="Linux"><span class="font-icon icon iconfont icon-edit" style=""></span>Linux<!----></a></li><li class="dropdown-subitem"><a href="/backend/skills/Dubbo.html" class="nav-link" aria-label="Dubbo"><span class="font-icon icon iconfont icon-edit" style=""></span>Dubbo<!----></a></li><li class="dropdown-subitem"><a href="/backend/skills/Zookeeper.html" class="nav-link" aria-label="Zookeeper"><span class="font-icon icon iconfont icon-edit" style=""></span>Zookeeper<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Tools</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/backend/tools/Docker.html" class="nav-link" aria-label="Docker"><span class="font-icon icon iconfont icon-edit" style=""></span>Docker<!----></a></li><li class="dropdown-subitem"><a href="/backend/tools/Git.html" class="nav-link" aria-label="Git"><span class="font-icon icon iconfont icon-edit" style=""></span>Git<!----></a></li><li class="dropdown-subitem"><a href="/backend/tools/Maven.html" class="nav-link" aria-label="Maven"><span class="font-icon icon iconfont icon-edit" style=""></span>Maven<!----></a></li><li class="dropdown-subitem"><a href="/backend/tools/Nginx.html" class="nav-link" aria-label="Nginx"><span class="font-icon icon iconfont icon-edit" style=""></span>Nginx<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a href="/article-papper/" class="nav-link" aria-label="Article &amp; Papper"><span class="font-icon icon iconfont icon-note" style=""></span>Article &amp; Papper<!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-end"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/EddieZturbo/Eddie-Tech-Blog.github.io" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside class="sidebar" id="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><a href="/" class="nav-link sidebar-link sidebar-page" aria-label="Home"><span class="font-icon icon iconfont icon-home" style=""></span>Home<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><section class="sidebar-group"><p class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-discover" style=""></span><a href="/eddie/" class="title">Eddie</a><!----></p><ul class="sidebar-links"></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading active"><span class="font-icon icon iconfont icon-note" style=""></span><span class="title">Backend-Dev</span><!----></p><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Database</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Dev Framework</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><!----><span class="title">Java</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a aria-current="page" href="/backend/java/java_concurrency_programming.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="Java Concurrency Programming"><!---->Java Concurrency Programming<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#ç†è®ºåŸºç¡€" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ç†è®ºåŸºç¡€"><!---->ç†è®ºåŸºç¡€<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#cpu-ç¼“å­˜æ¨¡å‹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="CPU ç¼“å­˜æ¨¡å‹"><!---->CPU ç¼“å­˜æ¨¡å‹<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#æŒ‡ä»¤é‡æ’åº" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="æŒ‡ä»¤é‡æ’åº"><!---->æŒ‡ä»¤é‡æ’åº<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#ä¸Šä¸‹æ–‡åˆ‡æ¢" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ä¸Šä¸‹æ–‡åˆ‡æ¢"><!---->ä¸Šä¸‹æ–‡åˆ‡æ¢<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#å¹¶å‘ä¸‰è¦ç´ " class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="å¹¶å‘ä¸‰è¦ç´ "><!---->å¹¶å‘ä¸‰è¦ç´ <!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#çº¿ç¨‹å®‰å…¨çš„å®ç°æ–¹æ³•" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="çº¿ç¨‹å®‰å…¨çš„å®ç°æ–¹æ³•"><!---->çº¿ç¨‹å®‰å…¨çš„å®ç°æ–¹æ³•<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#çº¿ç¨‹åŸºç¡€" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="çº¿ç¨‹åŸºç¡€"><!---->çº¿ç¨‹åŸºç¡€<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#javaå¹¶å‘æœºåˆ¶çš„åº•å±‚å®ç°åŸç†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Javaå¹¶å‘æœºåˆ¶çš„åº•å±‚å®ç°åŸç†"><!---->Javaå¹¶å‘æœºåˆ¶çš„åº•å±‚å®ç°åŸç†<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#java-object-memory-layout" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Java Object Memory Layout"><!---->Java Object Memory Layout<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#jmm-java-å†…å­˜æ¨¡å‹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="JMM(Java å†…å­˜æ¨¡å‹)"><!---->JMM(Java å†…å­˜æ¨¡å‹)<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#memory-barrier" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Memory Barrier"><!---->Memory Barrier<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#monitor" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Monitor"><!---->Monitor<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#synchronized" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="synchronized"><!---->synchronized<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#volatile" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="volatile"><!---->volatile<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#threadlocal" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ThreadLocal"><!---->ThreadLocal<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#juc-java-util-concurrency" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="JUC(Java Util Concurrency)"><!---->JUC(Java Util Concurrency)<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#abstractqueuedsynchronizer" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="AbstractQueuedSynchronizer"><!---->AbstractQueuedSynchronizer<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#java-çº¿ç¨‹æ± " class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Java çº¿ç¨‹æ± "><!---->Java çº¿ç¨‹æ± <!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#çº¿ç¨‹æ± åŸç†åˆ†æ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="çº¿ç¨‹æ± åŸç†åˆ†æ"><!---->çº¿ç¨‹æ± åŸç†åˆ†æ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#executor-æ¡†æ¶" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Executor æ¡†æ¶"><!---->Executor æ¡†æ¶<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#threadpoolexecutorâ˜…" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ThreadPoolExecutorâ˜…"><!---->ThreadPoolExecutorâ˜…<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#completablefutureå¼‚æ­¥ç¼–ç¨‹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="CompletableFutureå¼‚æ­¥ç¼–ç¨‹"><!---->CompletableFutureå¼‚æ­¥ç¼–ç¨‹<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a href="/backend/java/Java.html" class="nav-link sidebar-link sidebar-page" aria-label="Java Start"><!---->Java Start<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/backend/java/jvm.html" class="nav-link sidebar-link sidebar-page" aria-label="Java Virtual Machine"><!---->Java Virtual Machine<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/backend/java/java8.html" class="nav-link sidebar-link sidebar-page" aria-label="Java8å‡½æ•°å¼ç¼–ç¨‹"><!---->Java8å‡½æ•°å¼ç¼–ç¨‹<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Middleware</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Skills</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Tools</span><span class="arrow end"></span></button><!----></section></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-note" style=""></span><span class="title">Article &amp; Papper</span><!----></p><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Article</span><span class="arrow end"></span></button><!----></section></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->Java Concurrency Programming</h1><div class="page-info"><span class="page-author-info" aria-label="AuthorğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://github.com/EddieZturbo" target="_blank" rel="noopener noreferrer">EddieZ</a></span><span property="author" content="EddieZ"></span></span><!----><!----><!----><span class="page-reading-time-info" aria-label="Reading TimeâŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>About 56 min</span><meta property="timeRequired" content="PT56M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">On This Page<button class="print-button" title="print"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#ç†è®ºåŸºç¡€" class="router-link-active router-link-exact-active toc-link level2">ç†è®ºåŸºç¡€</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#cpu-ç¼“å­˜æ¨¡å‹" class="router-link-active router-link-exact-active toc-link level3">CPU ç¼“å­˜æ¨¡å‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#æŒ‡ä»¤é‡æ’åº" class="router-link-active router-link-exact-active toc-link level3">æŒ‡ä»¤é‡æ’åº</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#ä¸Šä¸‹æ–‡åˆ‡æ¢" class="router-link-active router-link-exact-active toc-link level3">ä¸Šä¸‹æ–‡åˆ‡æ¢</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#å¹¶å‘ä¸‰è¦ç´ " class="router-link-active router-link-exact-active toc-link level3">å¹¶å‘ä¸‰è¦ç´ </a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#çº¿ç¨‹å®‰å…¨çš„å®ç°æ–¹æ³•" class="router-link-active router-link-exact-active toc-link level3">çº¿ç¨‹å®‰å…¨çš„å®ç°æ–¹æ³•</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#çº¿ç¨‹åŸºç¡€" class="router-link-active router-link-exact-active toc-link level2">çº¿ç¨‹åŸºç¡€</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#javaå¹¶å‘æœºåˆ¶çš„åº•å±‚å®ç°åŸç†" class="router-link-active router-link-exact-active toc-link level2">Javaå¹¶å‘æœºåˆ¶çš„åº•å±‚å®ç°åŸç†</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#java-object-memory-layout" class="router-link-active router-link-exact-active toc-link level3">Java Object Memory Layout</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#jmm-java-å†…å­˜æ¨¡å‹" class="router-link-active router-link-exact-active toc-link level3">JMM(Java å†…å­˜æ¨¡å‹)</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#memory-barrier" class="router-link-active router-link-exact-active toc-link level3">Memory Barrier</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#monitor" class="router-link-active router-link-exact-active toc-link level3">Monitor</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#synchronized" class="router-link-active router-link-exact-active toc-link level3">synchronized</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#volatile" class="router-link-active router-link-exact-active toc-link level3">volatile</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#threadlocal" class="router-link-active router-link-exact-active toc-link level3">ThreadLocal</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#juc-java-util-concurrency" class="router-link-active router-link-exact-active toc-link level2">JUC(Java Util Concurrency)</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#abstractqueuedsynchronizer" class="router-link-active router-link-exact-active toc-link level3">AbstractQueuedSynchronizer</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#java-çº¿ç¨‹æ± " class="router-link-active router-link-exact-active toc-link level3">Java çº¿ç¨‹æ± </a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#çº¿ç¨‹æ± åŸç†åˆ†æ" class="router-link-active router-link-exact-active toc-link level3">çº¿ç¨‹æ± åŸç†åˆ†æ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#executor-æ¡†æ¶" class="router-link-active router-link-exact-active toc-link level3">Executor æ¡†æ¶</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#threadpoolexecutorâ˜…" class="router-link-active router-link-exact-active toc-link level3">ThreadPoolExecutorâ˜…</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/backend/java/java_concurrency_programming.html#completablefutureå¼‚æ­¥ç¼–ç¨‹" class="router-link-active router-link-exact-active toc-link level3">CompletableFutureå¼‚æ­¥ç¼–ç¨‹</a></li><!----><!--]--></ul><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="java-concurrency-programming" tabindex="-1"><a class="header-anchor" href="#java-concurrency-programming" aria-hidden="true">#</a> Java Concurrency Programming</h1><h2 id="ç†è®ºåŸºç¡€" tabindex="-1"><a class="header-anchor" href="#ç†è®ºåŸºç¡€" aria-hidden="true">#</a> ç†è®ºåŸºç¡€</h2><h3 id="cpu-ç¼“å­˜æ¨¡å‹" tabindex="-1"><a class="header-anchor" href="#cpu-ç¼“å­˜æ¨¡å‹" aria-hidden="true">#</a> CPU ç¼“å­˜æ¨¡å‹</h3><blockquote><p><strong>CPU Cache ç¼“å­˜çš„æ˜¯å†…å­˜æ•°æ®ç”¨äºè§£å†³ CPU å¤„ç†é€Ÿåº¦å’Œå†…å­˜ä¸åŒ¹é…çš„é—®é¢˜(CPU å¤„ç†é€Ÿåº¦å’Œå†…å­˜å¤„ç†é€Ÿåº¦ä¸å¯¹ç­‰)ï¼Œ</strong></p><p>å†…å­˜ç¼“å­˜çš„æ˜¯ç¡¬ç›˜æ•°æ®ç”¨äºè§£å†³ç¡¬ç›˜è®¿é—®é€Ÿåº¦è¿‡æ…¢çš„é—®é¢˜</p><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230412004416756.png" alt="image-20230412004416756"></p></blockquote><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230211100635374.png" alt="image-20230211100635374"></p><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230211095448065.png" alt="image-20230211095448065"></p><h3 id="æŒ‡ä»¤é‡æ’åº" tabindex="-1"><a class="header-anchor" href="#æŒ‡ä»¤é‡æ’åº" aria-hidden="true">#</a> <strong>æŒ‡ä»¤é‡æ’åº</strong></h3><blockquote><p>==æŒ‡ä»¤é‡æ’==:ä¸ºäº†æå‡æ‰§è¡Œé€Ÿåº¦/æ€§èƒ½ï¼Œè®¡ç®—æœºåœ¨æ‰§è¡Œç¨‹åºä»£ç çš„æ—¶å€™ï¼Œä¼šå¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åº.æŒ‡ä»¤é‡æ’çš„å‰ææ˜¯ï¼Œé‡æ’æŒ‡ä»¤ä¸èƒ½å½±å“ç»“æœ</p><ul><li><strong>ç¼–è¯‘å™¨ä¼˜åŒ–é‡æ’</strong> ï¼š==ç¼–è¯‘å™¨==ï¼ˆåŒ…æ‹¬ JVMã€JIT ç¼–è¯‘å™¨ç­‰ï¼‰åœ¨ä¸æ”¹å˜å•çº¿ç¨‹ç¨‹åºè¯­ä¹‰çš„å‰æä¸‹ï¼Œé‡æ–°å®‰æ’è¯­å¥çš„æ‰§è¡Œé¡ºåºã€‚</li><li><strong>æŒ‡ä»¤å¹¶è¡Œé‡æ’</strong> ï¼šç°ä»£==å¤„ç†å™¨==é‡‡ç”¨äº†æŒ‡ä»¤çº§å¹¶è¡ŒæŠ€æœ¯(Instruction-Level Parallelismï¼ŒILP)æ¥å°†å¤šæ¡æŒ‡ä»¤é‡å æ‰§è¡Œã€‚å¦‚æœä¸å­˜åœ¨æ•°æ®ä¾èµ–æ€§ï¼Œå¤„ç†å™¨å¯ä»¥æ”¹å˜è¯­å¥å¯¹åº”æœºå™¨æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºã€‚</li></ul><p>Java æºä»£ç ä¼šç»å† <strong>ç¼–è¯‘å™¨ä¼˜åŒ–é‡æ’ â€”&gt; æŒ‡ä»¤å¹¶è¡Œé‡æ’ â€”&gt; å†…å­˜ç³»ç»Ÿé‡æ’</strong> çš„è¿‡ç¨‹ï¼Œæœ€ç»ˆæ‰å˜æˆæ“ä½œç³»ç»Ÿå¯æ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—ã€‚</p></blockquote><blockquote><p>**å¯¹äºç¼–è¯‘å™¨ï¼Œ**é€šè¿‡ç¦æ­¢ç‰¹å®šç±»å‹çš„ç¼–è¯‘å™¨é‡æ’åºçš„æ–¹å¼æ¥ç¦æ­¢é‡æ’åºã€‚</p><p>**å¯¹äºå¤„ç†å™¨ï¼Œ**é€šè¿‡æ’å…¥å†…å­˜å±éšœï¼ˆMemory Barrierï¼Œæˆ–æœ‰æ—¶å«åšå†…å­˜æ …æ ï¼ŒMemory Fenceï¼‰çš„æ–¹å¼æ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„å¤„ç†å™¨é‡æ’åºã€‚æŒ‡ä»¤å¹¶è¡Œé‡æ’å’Œå†…å­˜ç³»ç»Ÿé‡æ’éƒ½å±äºæ˜¯å¤„ç†å™¨çº§åˆ«çš„æŒ‡ä»¤é‡æ’åºã€‚</p><ul><li>å†…å­˜å±éšœï¼ˆMemory Barrierï¼Œæˆ–æœ‰æ—¶å«åšå†…å­˜æ …æ ï¼ŒMemory Fenceï¼‰æ˜¯ä¸€ç§ CPU æŒ‡ä»¤ï¼Œç”¨æ¥ç¦æ­¢å¤„ç†å™¨æŒ‡ä»¤å‘ç”Ÿé‡æ’åºï¼ˆåƒå±éšœä¸€æ ·ï¼‰ï¼Œä»è€Œä¿éšœæŒ‡ä»¤æ‰§è¡Œçš„æœ‰åºæ€§ã€‚å¦å¤–ï¼Œä¸ºäº†è¾¾åˆ°å±éšœçš„æ•ˆæœï¼Œå®ƒä¹Ÿä¼šä½¿å¤„ç†å™¨å†™å…¥ã€è¯»å–å€¼ä¹‹å‰ï¼Œå°†ä¸»å†…å­˜çš„å€¼å†™å…¥é«˜é€Ÿç¼“å­˜ï¼Œæ¸…ç©ºæ— æ•ˆé˜Ÿåˆ—ï¼Œä»è€Œä¿éšœå˜é‡çš„å¯è§æ€§ã€‚</li></ul></blockquote><blockquote><p><strong>æŒ‡ä»¤é‡æ’åºå¯ä»¥ä¿è¯ä¸²è¡Œè¯­ä¹‰ä¸€è‡´ï¼Œä½†æ˜¯æ²¡æœ‰ä¹‰åŠ¡ä¿è¯å¤šçº¿ç¨‹é—´çš„è¯­ä¹‰ä¹Ÿä¸€è‡´</strong> ï¼Œæ‰€ä»¥åœ¨å¤šçº¿ç¨‹ä¸‹ï¼ŒæŒ‡ä»¤é‡æ’åºå¯èƒ½ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ã€‚</p></blockquote><h3 id="ä¸Šä¸‹æ–‡åˆ‡æ¢" tabindex="-1"><a class="header-anchor" href="#ä¸Šä¸‹æ–‡åˆ‡æ¢" aria-hidden="true">#</a> ä¸Šä¸‹æ–‡åˆ‡æ¢</h3><blockquote><p>ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼š</p><p>å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ä¸€èˆ¬çº¿ç¨‹çš„ä¸ªæ•°éƒ½å¤§äº CPU æ ¸å¿ƒçš„ä¸ªæ•°ï¼Œè€Œä¸€ä¸ª CPU æ ¸å¿ƒåœ¨ä»»æ„æ—¶åˆ»åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œä¸ºäº†è®©è¿™äº›çº¿ç¨‹éƒ½èƒ½å¾—åˆ°æœ‰æ•ˆæ‰§è¡Œï¼ŒCPU é‡‡å–çš„ç­–ç•¥æ˜¯ä¸ºæ¯ä¸ªçº¿ç¨‹<strong>åˆ†é…æ—¶é—´ç‰‡</strong>å¹¶<strong>è½®è½¬</strong>çš„å½¢å¼ã€‚å½“ä¸€ä¸ªçº¿ç¨‹çš„æ—¶é—´ç‰‡ç”¨å®Œçš„æ—¶å€™å°±ä¼šé‡æ–°å¤„äºå°±ç»ªçŠ¶æ€è®©ç»™å…¶ä»–çº¿ç¨‹ä½¿ç”¨ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å±äºä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚æ¦‚æ‹¬æ¥è¯´å°±æ˜¯ï¼šå½“å‰ä»»åŠ¡åœ¨æ‰§è¡Œå®Œ CPU æ—¶é—´ç‰‡åˆ‡æ¢åˆ°å¦ä¸€ä¸ªä»»åŠ¡ä¹‹å‰ä¼šå…ˆä¿å­˜è‡ªå·±çš„çŠ¶æ€ï¼Œä»¥ä¾¿ä¸‹æ¬¡å†åˆ‡æ¢å›è¿™ä¸ªä»»åŠ¡æ—¶ï¼Œå¯ä»¥å†åŠ è½½è¿™ä¸ªä»»åŠ¡çš„çŠ¶æ€ã€‚</p><p><strong>ä»»åŠ¡ä»ä¿å­˜åˆ°å†åŠ è½½çš„è¿‡ç¨‹å°±æ˜¯ä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢</strong>ã€‚</p><p><strong>æŒ‚èµ·çº¿ç¨‹</strong>å’Œ<strong>æ¢å¤çº¿ç¨‹</strong>çš„æ“ä½œ<strong>éƒ½éœ€è¦è½¬å…¥å†…æ ¸æ€ä¸­å®Œæˆ</strong>ï¼Œè¿™äº›æ“ä½œå¯¹ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½å¸¦æ¥äº†å¾ˆå¤§çš„å‹åŠ›</p><p>ä¸Šä¸‹æ–‡åˆ‡æ¢é€šå¸¸æ˜¯è®¡ç®—å¯†é›†å‹çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒéœ€è¦ç›¸å½“å¯è§‚çš„å¤„ç†å™¨æ—¶é—´ï¼Œåœ¨æ¯ç§’å‡ åä¸Šç™¾æ¬¡çš„åˆ‡æ¢ä¸­ï¼Œæ¯æ¬¡åˆ‡æ¢éƒ½éœ€è¦çº³ç§’é‡çº§çš„æ—¶é—´ã€‚æ‰€ä»¥ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢å¯¹ç³»ç»Ÿæ¥è¯´æ„å‘³ç€æ¶ˆè€—å¤§é‡çš„ CPU æ—¶é—´ï¼Œäº‹å®ä¸Šï¼Œå¯èƒ½æ˜¯æ“ä½œç³»ç»Ÿä¸­æ—¶é—´æ¶ˆè€—æœ€å¤§çš„æ“ä½œã€‚</p><p>Linux ç›¸æ¯”ä¸å…¶ä»–æ“ä½œç³»ç»Ÿï¼ˆåŒ…æ‹¬å…¶ä»–ç±» Unix ç³»ç»Ÿï¼‰æœ‰å¾ˆå¤šçš„ä¼˜ç‚¹ï¼Œå…¶ä¸­æœ‰ä¸€é¡¹å°±æ˜¯ï¼Œå…¶ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œæ¨¡å¼åˆ‡æ¢çš„æ—¶é—´æ¶ˆè€—éå¸¸å°‘ã€‚</p></blockquote><h3 id="å¹¶å‘ä¸‰è¦ç´ " tabindex="-1"><a class="header-anchor" href="#å¹¶å‘ä¸‰è¦ç´ " aria-hidden="true">#</a> å¹¶å‘ä¸‰è¦ç´ </h3><blockquote><p>==å¯è§æ€§==: <strong>CPUç¼“å­˜</strong>å¼•èµ·å¯è§æ€§ï¼šä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„ä¿®æ”¹ï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿç«‹åˆ»çœ‹åˆ°ã€‚</p><p>==åŸå­æ€§==: <strong>CPUæŒ‰æ—¶é—´ç‰‡åˆ†æ—¶å¤ç”¨</strong>ï¼ˆï¼ˆçº¿ç¨‹åˆ‡æ¢ï¼‰ï¼‰å¼•èµ·åŸå­æ€§ï¼šå³ä¸€ä¸ªæ“ä½œæˆ–è€…å¤šä¸ªæ“ä½œ <strong>è¦ä¹ˆå…¨éƒ¨æ‰§è¡Œ</strong>å¹¶ä¸”ä¸ä¼šè¢«ä»»ä½•å› ç´ æ‰“æ–­ï¼Œ<strong>è¦ä¹ˆå°±éƒ½ä¸æ‰§è¡Œ</strong>ã€‚</p><p>==æœ‰åºæ€§==: <strong>é‡æ’åº</strong>å¼•èµ·æœ‰åºæ€§ï¼šå³ç¨‹åºæ‰§è¡Œçš„é¡ºåºæŒ‰ç…§ä»£ç çš„å…ˆåé¡ºåºæ‰§è¡Œã€‚</p><ul><li>ç¼–è¯‘å™¨ä¼˜åŒ–çš„é‡æ’åºã€‚ç¼–è¯‘å™¨åœ¨ä¸æ”¹å˜å•çº¿ç¨‹ç¨‹åºè¯­ä¹‰çš„å‰æä¸‹ï¼Œå¯ä»¥é‡æ–°å®‰æ’è¯­å¥çš„æ‰§è¡Œé¡ºåºã€‚</li><li>æŒ‡ä»¤çº§å¹¶è¡Œçš„é‡æ’åºã€‚ç°ä»£å¤„ç†å™¨é‡‡ç”¨äº†æŒ‡ä»¤çº§å¹¶è¡ŒæŠ€æœ¯ï¼ˆInstruction-Level Parallelismï¼Œ ILPï¼‰æ¥å°†å¤šæ¡æŒ‡ä»¤é‡å æ‰§è¡Œã€‚å¦‚æœä¸å­˜åœ¨æ•°æ®ä¾èµ–æ€§ï¼Œå¤„ç†å™¨å¯ä»¥æ”¹å˜è¯­å¥å¯¹åº”æœºå™¨æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºã€‚</li><li>å†…å­˜ç³»ç»Ÿçš„é‡æ’åºã€‚ç”±äºå¤„ç†å™¨ä½¿ç”¨ç¼“å­˜å’Œè¯» / å†™ç¼“å†²åŒºï¼Œè¿™ä½¿å¾—åŠ è½½å’Œå­˜å‚¨æ“ä½œçœ‹ä¸Šå»å¯èƒ½æ˜¯åœ¨ä¹±åºæ‰§è¡Œã€‚</li></ul></blockquote><h4 id="å¯è§æ€§" tabindex="-1"><a class="header-anchor" href="#å¯è§æ€§" aria-hidden="true">#</a> å¯è§æ€§</h4><blockquote><p>å½“ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡è¿›è¡Œäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆå¦å¤–çš„çº¿ç¨‹éƒ½æ˜¯ç«‹å³å¯ä»¥çœ‹åˆ°ä¿®æ”¹åçš„æœ€æ–°å€¼ã€‚</p><p>åœ¨ Java ä¸­ï¼Œå¯ä»¥å€ŸåŠ©<code>synchronized</code> ã€<code>volatile</code> ä»¥åŠå„ç§ <code>Lock</code> å®ç°å¯è§æ€§ã€‚</p><p>å¦‚æœæˆ‘ä»¬å°†å˜é‡å£°æ˜ä¸º <code>volatile</code> ï¼Œè¿™å°±æŒ‡ç¤º JVMï¼Œè¿™ä¸ªå˜é‡æ˜¯å…±äº«ä¸”ä¸ç¨³å®šçš„ï¼Œæ¯æ¬¡ä½¿ç”¨å®ƒéƒ½åˆ°ä¸»å­˜ä¸­è¿›è¡Œè¯»å–</p></blockquote><h4 id="åŸå­æ€§" tabindex="-1"><a class="header-anchor" href="#åŸå­æ€§" aria-hidden="true">#</a> åŸå­æ€§</h4><blockquote><p>ä¸€æ¬¡æ“ä½œæˆ–è€…å¤šæ¬¡æ“ä½œï¼Œè¦ä¹ˆæ‰€æœ‰çš„æ“ä½œå…¨éƒ¨<strong>éƒ½å¾—åˆ°æ‰§è¡Œ</strong>å¹¶ä¸”<strong>ä¸ä¼šå—åˆ°ä»»ä½•å› ç´ çš„å¹²æ‰°</strong>è€Œä¸­æ–­ï¼Œè¦ä¹ˆ<strong>éƒ½ä¸æ‰§è¡Œ</strong>ã€‚</p><p>åœ¨ Java ä¸­ï¼Œå¯ä»¥å€ŸåŠ©<code>synchronized</code> ã€å„ç§ <code>Lock</code> ä»¥åŠå„ç§åŸå­ç±»å®ç°åŸå­æ€§ã€‚</p><p><code>synchronized</code> å’Œå„ç§ <code>Lock</code> å¯ä»¥ä¿è¯ä»»ä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®è¯¥ä»£ç å—ï¼Œå› æ­¤å¯ä»¥ä¿éšœåŸå­æ€§ã€‚å„ç§åŸå­ç±»æ˜¯åˆ©ç”¨ CAS (compare and swap) æ“ä½œï¼ˆå¯èƒ½ä¹Ÿä¼šç”¨åˆ° <code>volatile</code>æˆ–è€…<code>final</code>å…³é”®å­—ï¼‰æ¥ä¿è¯åŸå­æ“ä½œã€‚</p></blockquote><h4 id="æœ‰åºæ€§" tabindex="-1"><a class="header-anchor" href="#æœ‰åºæ€§" aria-hidden="true">#</a> æœ‰åºæ€§</h4><blockquote><p>ç”±äºæŒ‡ä»¤é‡æ’åºé—®é¢˜ï¼Œä»£ç çš„æ‰§è¡Œé¡ºåºæœªå¿…å°±æ˜¯ç¼–å†™ä»£ç æ—¶å€™çš„é¡ºåºã€‚</p><p>Java æºä»£ç ä¼šç»å† <strong>ç¼–è¯‘å™¨ä¼˜åŒ–é‡æ’ â€”&gt; æŒ‡ä»¤å¹¶è¡Œé‡æ’ â€”&gt; å†…å­˜ç³»ç»Ÿé‡æ’</strong> çš„è¿‡ç¨‹ï¼Œæœ€ç»ˆæ‰å˜æˆæ“ä½œç³»ç»Ÿå¯æ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—ã€‚</p><p>æˆ‘ä»¬ä¸Šé¢è®²é‡æ’åºçš„æ—¶å€™ä¹Ÿæåˆ°è¿‡ï¼š</p><blockquote><p><strong>æŒ‡ä»¤é‡æ’åºå¯ä»¥ä¿è¯ä¸²è¡Œè¯­ä¹‰ä¸€è‡´ï¼Œä½†æ˜¯æ²¡æœ‰ä¹‰åŠ¡ä¿è¯å¤šçº¿ç¨‹é—´çš„è¯­ä¹‰ä¹Ÿä¸€è‡´</strong> ï¼Œæ‰€ä»¥åœ¨å¤šçº¿ç¨‹ä¸‹ï¼ŒæŒ‡ä»¤é‡æ’åºå¯èƒ½ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ã€‚</p></blockquote><p>åœ¨ Java ä¸­ï¼Œ<code>volatile</code> å…³é”®å­—å¯ä»¥ç¦æ­¢æŒ‡ä»¤è¿›è¡Œé‡æ’åºä¼˜åŒ–ã€‚</p><p>å¯¹äºå¤„ç†å™¨é‡æ’åº,JMMçš„å¤„ç†å™¨é‡æ’åºè§„åˆ™ä¼šè¦æ±‚Javaç¼–è¯‘å™¨åœ¨ç”ŸæˆæŒ‡ä»¤åºåˆ—æ—¶,æ’å…¥ç‰¹å®šç±»å‹çš„å†…å­˜å±éšœ(Memory Barriers,Intelç§°ä¹‹ä¸ºMemory Fence)æŒ‡ä»¤,é€šè¿‡å†…å­˜å±éšœæŒ‡ä»¤æ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„å¤„ç†å™¨é‡æ’åºã€‚</p></blockquote><h3 id="çº¿ç¨‹å®‰å…¨çš„å®ç°æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#çº¿ç¨‹å®‰å…¨çš„å®ç°æ–¹æ³•" aria-hidden="true">#</a> çº¿ç¨‹å®‰å…¨çš„å®ç°æ–¹æ³•</h3><blockquote><p><strong>åŒæ­¥æ–¹æ¡ˆ</strong></p><ul><li><strong>Mutexï¼ˆé˜»å¡ï¼‰åŒæ­¥</strong><ul><li>synchronized</li><li>ReentrantLock...</li></ul></li><li><strong>éé˜»å¡åŒæ­¥</strong><ul><li>CASï¼ˆè½»é‡çº§é”ï¼‰</li><li>AtomicInteter(åŸå­ç±»æ“ä½œ)</li></ul></li></ul><p><strong>æ— åŒæ­¥æ–¹æ¡ˆ</strong></p><ul><li>æ ˆå°é—­</li><li>çº¿ç¨‹æœ¬åœ°å­˜å‚¨(ThreadLocal Storage)</li></ul></blockquote><h2 id="çº¿ç¨‹åŸºç¡€" tabindex="-1"><a class="header-anchor" href="#çº¿ç¨‹åŸºç¡€" aria-hidden="true">#</a> çº¿ç¨‹åŸºç¡€</h2><h2 id="javaå¹¶å‘æœºåˆ¶çš„åº•å±‚å®ç°åŸç†" tabindex="-1"><a class="header-anchor" href="#javaå¹¶å‘æœºåˆ¶çš„åº•å±‚å®ç°åŸç†" aria-hidden="true">#</a> Javaå¹¶å‘æœºåˆ¶çš„åº•å±‚å®ç°åŸç†</h2><h3 id="java-object-memory-layout" tabindex="-1"><a class="header-anchor" href="#java-object-memory-layout" aria-hidden="true">#</a> Java Object Memory Layout</h3><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20221024174142826.png" alt="image-20221024174142826"></p><p>In Hotspot VM, the object layout in the heap can be divided into three parts,</p><ol><li>Header</li><li>Instance Data</li><li>Padding</li></ol><h4 id="header" tabindex="-1"><a class="header-anchor" href="#header" aria-hidden="true">#</a> HeaderğŸ‘€</h4><p>It saves two types of information.</p><ol><li>Save the object self&#39;s runtime information, the officials call it <code>Mark Word</code>, such as HashCode, GC generation age, lock states, the lock that the thread holds, biased thread id, biased timestamp.</li><li>Save the type pointer, that&#39;s the pointer to the meta-type, Java VM used it to determine which type of this object is, this is an optional implementation in the VM. If the object is an array, there is a data in the header to save the array&#39;s length</li></ol><h5 id="mark-word" tabindex="-1"><a class="header-anchor" href="#mark-word" aria-hidden="true">#</a> Mark WordğŸ‘ï¸</h5><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230210154448670.png" alt="image-20230210154448670"></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>ä¸€ä¸ªå¯¹è±¡åˆ›å»ºæ—¶ï¼š
å¦‚æœå¼€å¯äº†åå‘é”ï¼ˆé»˜è®¤å¼€å¯ï¼‰ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ›å»ºåï¼Œmarkword å€¼ä¸º 0x05 å³æœ€å 3 ä½ä¸º 101ï¼Œè¿™æ—¶å®ƒçš„ threadã€epochã€age éƒ½ä¸º 0
åå‘é”æ˜¯é»˜è®¤æ˜¯å»¶è¿Ÿçš„ï¼Œä¸ä¼šåœ¨ç¨‹åºå¯åŠ¨æ—¶ç«‹å³ç”Ÿæ•ˆï¼Œå¦‚æœæƒ³é¿å…å»¶è¿Ÿï¼Œå¯ä»¥åŠ  VM å‚æ•° 
-XX:BiasedLockingStartupDelay=0 æ¥ç¦ç”¨å»¶è¿Ÿ
å¦‚æœæ²¡æœ‰å¼€å¯åå‘é”ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ›å»ºåï¼Œmarkword å€¼ä¸º 0x01 å³æœ€å 3 ä½ä¸º 001ï¼Œè¿™æ—¶å®ƒçš„ hashcodeã€age éƒ½ä¸º 0ï¼Œç¬¬ä¸€æ¬¡ç”¨åˆ° hashcode æ—¶æ‰ä¼šèµ‹å€¼

è½»é‡é”å’Œé‡é‡é”ä¸€ä¸ªä¼šæŠŠhashcodeæ”¾åœ¨æ ˆå¸§çš„é”è®°å½•ï¼Œä¸€ä¸ªä¼šæ”¾åˆ°monitorä¸­ï¼ˆè§£é”çš„æ—¶å€™ä¼šè¿˜åŸå›æ¥ï¼‰
è€Œåå‘é”æ²¡æœ‰é¢å¤–çš„å‚¨å­˜ç©ºé—´ å½“è·å–äº†hashcodeåˆ™ä¼šå¼ƒç”¨åå‘é”ï¼ˆæ¶ˆé™¤åå‘çŠ¶æ€ï¼‰ é‡å†™markword

è°¨è®°åå‘æ˜¯æŒ‡ç±»åå‘ï¼Œè€Œä¸æ˜¯å¯¹è±¡å®ä¾‹åå‘ï¼›ä¸€ä¸ªç±»åªèƒ½æœ‰ä¸€ä¸ªåå‘
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230210154116888.png" alt="image-20230210154116888"></p><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230210145412031.png" alt="image-20230210145412031"></p><p>The 32 bit and 64 bit VM are different.</p><ul><li>32-bit word</li></ul><table><thead><tr><th>Object</th><th>Format</th></tr></thead><tbody><tr><td>normal object</td><td>hash: 25, age: 4, biased_lock: 1, lock: 2</td></tr><tr><td>biased object</td><td>JavaThread*: 23, epoch: 2 age: 4, biased_lock: 1, lock: 2</td></tr><tr><td>CMS free block</td><td>32 bits</td></tr><tr><td>CMS promoted object</td><td>PromotedObject*: 29, promo_bits: 3</td></tr></tbody></table><ul><li>64-bit word</li></ul><table><thead><tr><th>Object</th><th>Format</th></tr></thead><tbody><tr><td>normal object</td><td>unused: 25, hash: 31, unused: 1, age: 4, biased_lock: 1, lock: 2</td></tr><tr><td>biased object</td><td>JavaThread*: 54, epoch: 2, unused: 1, age: 4, biased_lock: 1, lock: 2</td></tr><tr><td>CMS promoted object</td><td>PromotedObject*: 61, promo_bits: 3</td></tr><tr><td>CMS free block</td><td>64 bits</td></tr><tr><td>COOPs &amp;&amp; normal object</td><td>unused: 25, hash: 31, cms_free: 1, age: 4, biased_lock: 1, lock: 2</td></tr><tr><td>COOPs &amp;&amp; biased object</td><td>JavaThread*: 54, epoch: 2, cms_free: 1, age: 4, biased_lock: 1, lock: 2</td></tr><tr><td>COOPs &amp;&amp; CMS promoted object</td><td>narrowOop: 32, unused: 24, cms_free: 1, unused: 4, promo_bits: 3</td></tr><tr><td>COOPs &amp;&amp; CMS free block</td><td>unused: 21, size: 35, cms_free: 1, unused: 7</td></tr></tbody></table><h5 id="class-metadata-address" tabindex="-1"><a class="header-anchor" href="#class-metadata-address" aria-hidden="true">#</a> Class Metadata Address</h5><p>æŒ‡å‘è¯¥å¯¹è±¡çš„æ‰€å±ç±»å‹</p><h5 id="is-array-array-length-nothing" tabindex="-1"><a class="header-anchor" href="#is-array-array-length-nothing" aria-hidden="true">#</a> Is Array ? Array Length : nothing</h5><h4 id="instance-data" tabindex="-1"><a class="header-anchor" href="#instance-data" aria-hidden="true">#</a> Instance Data</h4><p>The instance data saves the variables defined in the class, including the variable defined in the parent class. The store sequence will be impacted by the JVM argument <code>-XX:FieldsAllocationStyle</code> and the sequence defined in the class.</p><blockquote><p>The Hotspot&#39;s default allocation sequence is that,</p><ul><li>longs/doubles</li><li>ints</li><li>shorts/chars</li><li>bytes/booleans</li><li>oops(Ordinary Object Pointers, OOP)</li></ul></blockquote><p>Also, if JVM argument <code>-XX:CompactFields</code> is true(default value), the thinner variable in the child class will be inserted into the gap of parent variables.</p><h4 id="padding" tabindex="-1"><a class="header-anchor" href="#padding" aria-hidden="true">#</a> Padding</h4><p>The HotSpot VM&#39;s auto memory management system requires the starting address of the object must be 8-byte event digits, which means any object&#39;s size muse be 8-byte event digits. So, if an object&#39;s instance data doesn&#39;t align, it needs padding.</p><h3 id="jmm-java-å†…å­˜æ¨¡å‹" tabindex="-1"><a class="header-anchor" href="#jmm-java-å†…å­˜æ¨¡å‹" aria-hidden="true">#</a> JMM(Java å†…å­˜æ¨¡å‹)</h3><blockquote><p>æˆ‘ä»¬çš„ç¨‹åºè¿è¡Œåœ¨æ“ä½œç³»ç»Ÿä¹‹ä¸Šï¼Œæ“ä½œç³»ç»Ÿå±è”½äº†åº•å±‚ç¡¬ä»¶çš„æ“ä½œç»†èŠ‚ï¼Œå°†å„ç§ç¡¬ä»¶èµ„æºè™šæ‹ŸåŒ–ã€‚äºæ˜¯ï¼Œæ“ä½œç³»ç»Ÿä¹Ÿå°±åŒæ ·éœ€è¦è§£å†³å†…å­˜ç¼“å­˜ä¸ä¸€è‡´æ€§é—®é¢˜ã€‚</p><p>æ“ä½œç³»ç»Ÿé€šè¿‡ <strong>å†…å­˜æ¨¡å‹ï¼ˆMemory Modelï¼‰</strong> å®šä¹‰ä¸€ç³»åˆ—è§„èŒƒæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æ— è®ºæ˜¯ Windows ç³»ç»Ÿï¼Œè¿˜æ˜¯ Linux ç³»ç»Ÿï¼Œå®ƒä»¬éƒ½æœ‰ç‰¹å®šçš„å†…å­˜æ¨¡å‹</p><p>Java è¯­è¨€æ˜¯è·¨å¹³å°çš„ï¼Œå®ƒéœ€è¦<strong>Javaè‡ªå·±æä¾›ä¸€å¥—å†…å­˜æ¨¡å‹ä»¥å±è”½ç³»ç»Ÿå·®å¼‚</strong></p><p><strong>å¹¶å‘ç¼–ç¨‹ä¸‹è¦éµå®ˆçš„å¹¶å‘ç›¸å…³çš„åŸåˆ™å’Œè§„èŒƒ</strong></p><p><a href="http://www.cs.umd.edu/~pugh/java/memoryModel/CommunityReview.pdf" target="_blank" rel="noopener noreferrer">ã€ŠJSR-133ï¼šJava Memory Model and Thread Specificationã€‹<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>Javaå†…å­˜æ¨¡å‹ï¼ˆJava Memory Modelï¼Œç®€ç§°JMMï¼‰å®šä¹‰äº†Javaè™šæ‹Ÿæœºå¦‚ä½•ç®¡ç†Javaç¨‹åºä¸­çš„å†…å­˜ï¼Œä»¥åŠçº¿ç¨‹ä¹‹é—´å¦‚ä½•è¿›è¡Œé€šä¿¡ã€‚JMMçš„ç›®æ ‡æ˜¯ä¿è¯Javaç¨‹åºåœ¨ä»»ä½•å¹³å°ä¸Šéƒ½èƒ½å¤Ÿæ­£ç¡®åœ°æ‰§è¡Œï¼Œä¸å—å„ç§ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿçš„å½±å“ã€‚</p><p>Javaå†…å­˜æ¨¡å‹ä¸»è¦ç”±ä»¥ä¸‹ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼š</p><ol><li><strong>å†…å­˜è®¿é—®è§„åˆ™ï¼ˆMemory Access Rulesï¼‰</strong>ï¼šå®šä¹‰äº†Javaç¨‹åºä¸­çš„å˜é‡åœ¨å†…å­˜ä¸­çš„è¯»å–å’Œå†™å…¥è§„åˆ™ï¼Œä»¥åŠè¿™äº›è§„åˆ™çš„å¯è§æ€§å’ŒåŸå­æ€§ã€‚</li><li><strong>çº¿ç¨‹ä¹‹é—´çš„äº¤äº’ï¼ˆThread Interactionï¼‰</strong>ï¼šå®šä¹‰äº†çº¿ç¨‹ä¹‹é—´å¦‚ä½•è¿›è¡Œé€šä¿¡ä»¥åŠå¦‚ä½•åä½œï¼Œä»¥ä¿è¯Javaç¨‹åºçš„æ­£ç¡®æ€§ã€‚</li><li><strong>Happens-Beforeå…³ç³»ï¼ˆHappens-Before Relationshipï¼‰</strong>ï¼šå®šä¹‰äº†Javaç¨‹åºä¸­ä¸åŒæ“ä½œä¹‹é—´çš„å…ˆåå…³ç³»ï¼Œä»¥ä¿è¯Javaç¨‹åºçš„æ­£ç¡®æ€§ã€‚</li></ol><p>åœ¨<strong>Javaå†…å­˜æ¨¡å‹ä¸­</strong>ï¼Œ<strong>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜</strong>ï¼Œçº¿ç¨‹<strong>å¯¹å˜é‡çš„æ“ä½œéƒ½æ˜¯åœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œ</strong>çš„ã€‚<strong>å½“çº¿ç¨‹éœ€è¦è¯»å–å…±äº«å˜é‡çš„å€¼æ—¶ï¼Œéœ€è¦ä»ä¸»å†…å­˜ä¸­è·å–å˜é‡çš„å€¼ï¼Œå½“çº¿ç¨‹éœ€è¦ä¿®æ”¹å…±äº«å˜é‡çš„å€¼æ—¶ï¼Œéœ€è¦å…ˆåœ¨å·¥ä½œå†…å­˜ä¸­ä¿®æ”¹å˜é‡çš„å€¼ï¼Œç„¶åå°†ä¿®æ”¹åçš„å€¼åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­</strong>ã€‚JMMè§„å®šäº†è¯»å–å’Œå†™å…¥æ“ä½œçš„é¡ºåºä»¥åŠå¯è§æ€§å’ŒåŸå­æ€§çš„è¦æ±‚ï¼Œä»¥ä¿è¯å¤šä¸ªçº¿ç¨‹ä¹‹é—´å¯¹å…±äº«å˜é‡çš„æ“ä½œä¸ä¼šäº§ç”Ÿå†²çªå’Œæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚</p><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230401000647251.png" alt="image-20230401000647251"></p><p>Happens-Beforeå…³ç³»æ˜¯Javaå†…å­˜æ¨¡å‹ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªæ¦‚å¿µï¼Œå®ƒç”¨æ¥ä¿è¯Javaç¨‹åºä¸­çš„æ“ä½œæŒ‰ç…§ä¸€å®šçš„é¡ºåºæ‰§è¡Œã€‚å¦‚æœä¸€ä¸ªæ“ä½œhappens-beforeå¦ä¸€ä¸ªæ“ä½œï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªæ“ä½œçš„ç»“æœå¯¹äºç¬¬äºŒä¸ªæ“ä½œæ˜¯å¯è§çš„ã€‚JMMè§„å®šäº†ä¸€äº›æƒ…å†µä¸‹çš„Happens-Beforeå…³ç³»ï¼Œä¾‹å¦‚çº¿ç¨‹çš„å¯åŠ¨å’Œç»“æŸï¼Œsynchronizedå—çš„è¿›å…¥å’Œé€€å‡ºç­‰ç­‰ã€‚è¿™äº›è§„å®šèƒ½å¤Ÿä¿è¯Javaç¨‹åºçš„æ­£ç¡®æ€§ï¼Œé¿å…å‡ºç°ä¸€äº›å¥‡æ€ªçš„å¹¶å‘é—®é¢˜ã€‚</p><p><strong>é€»è¾‘æ—¶é’Ÿå¹¶ä¸åº¦é‡æ—¶é—´æœ¬èº«ï¼Œä»…åŒºåˆ†äº‹ä»¶å‘ç”Ÿçš„å‰åé¡ºåºï¼Œå…¶æœ¬è´¨å°±æ˜¯å®šä¹‰äº†ä¸€ç§ happens-before å…³ç³»ã€‚</strong></p><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230401001125941.png" alt="image-20230401001125941"></p></blockquote><h3 id="memory-barrier" tabindex="-1"><a class="header-anchor" href="#memory-barrier" aria-hidden="true">#</a> Memory Barrier</h3><blockquote><p>åœ¨Javaä¸­ï¼Œå±éšœï¼ˆbarrierï¼‰é€šå¸¸æŒ‡çš„æ˜¯å†…å­˜å±éšœï¼Œå®ƒä»¬ç”¨äºæ§åˆ¶å†…å­˜è®¿é—®çš„é¡ºåºä»¥ç¡®ä¿å¤šçº¿ç¨‹ç¨‹åºçš„æ­£ç¡®æ€§å’Œå¯è§æ€§ã€‚æœ‰è¯»å±éšœã€å†™å±éšœã€é€šç”¨å±éšœå’Œä¼˜åŒ–å±éšœç­‰ä¸åŒç±»å‹çš„å†…å­˜å±éšœã€‚</p><p>è¿™äº›å±éšœåœ¨Javaä¸­é€šå¸¸ç”±ç¼–è¯‘å™¨ã€è™šæ‹Ÿæœºä»¥åŠåº•å±‚ç¡¬ä»¶æ¥å®ç°å’Œç®¡ç†ï¼Œå¼€å‘è€…åœ¨ç¼–å†™å¤šçº¿ç¨‹ç¨‹åºæ—¶é€šå¸¸ä¸éœ€è¦ç›´æ¥æ“ä½œè¿™äº›å±éšœã€‚ç›¸åï¼ŒJavaæä¾›äº†é«˜çº§çš„å¹¶å‘å·¥å…·å’Œå…³é”®å­—ï¼ˆä¾‹å¦‚<code>synchronized</code>å’Œ<code>volatile</code>ï¼‰æ¥å¸®åŠ©å¼€å‘è€…ç¼–å†™çº¿ç¨‹å®‰å…¨çš„ä»£ç ï¼Œè€Œè¿™äº›å·¥å…·ä¼šéšå«åœ°ä½¿ç”¨å†…å­˜å±éšœæ¥ç¡®ä¿æ­£ç¡®çš„å†…å­˜è®¿é—®é¡ºåºå’Œå¯è§æ€§ã€‚</p><p>å¯¹äºå¤„ç†å™¨é‡æ’åº,JMMçš„å¤„ç†å™¨é‡æ’åºè§„åˆ™ä¼šè¦æ±‚Javaç¼–è¯‘å™¨åœ¨ç”ŸæˆæŒ‡ä»¤åºåˆ—æ—¶,æ’å…¥ç‰¹å®šç±»å‹çš„å†…å­˜å±éšœ(Memory Barriers,Intelç§°ä¹‹ä¸ºMemory Fence)æŒ‡ä»¤,é€šè¿‡å†…å­˜å±éšœæŒ‡ä»¤æ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„å¤„ç†å™¨é‡æ’åºã€‚</p></blockquote><blockquote><ol><li>è¯»å±éšœï¼ˆRead Barrierï¼‰ï¼š <ul><li>è¯»å±éšœç¡®ä¿ä¸€ä¸ªçº¿ç¨‹åœ¨è¯»å–å˜é‡çš„å€¼ä¹‹å‰ï¼Œä¼šä»ä¸»å†…å­˜ä¸­è·å–æœ€æ–°çš„å€¼ï¼Œè€Œä¸æ˜¯ä½¿ç”¨æœ¬åœ°ç¼“å­˜ä¸­çš„æ—§å€¼ã€‚</li><li>è¯»å±éšœé€šå¸¸ç”¨äºç¡®ä¿å˜é‡çš„å¯è§æ€§ï¼Œé˜²æ­¢å‡ºç°è„è¯»æˆ–ä¸ä¸€è‡´çš„æ•°æ®è®¿é—®ã€‚</li></ul></li><li>å†™å±éšœï¼ˆWrite Barrierï¼‰ï¼š <ul><li>å†™å±éšœç”¨äºç¡®ä¿ä¸€ä¸ªçº¿ç¨‹åœ¨å†™å…¥å˜é‡çš„å€¼ä¹‹åï¼Œå°†è¿™ä¸ªå†™æ“ä½œåˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ï¼Œä»¥ä¾¿å…¶ä»–çº¿ç¨‹å¯ä»¥çœ‹åˆ°æœ€æ–°çš„å€¼ã€‚</li><li>å†™å±éšœé€šå¸¸ç”¨äºç¡®ä¿å˜é‡çš„å¯è§æ€§ï¼Œé˜²æ­¢å†™å…¥æ“ä½œè¢«é‡æ’åºæˆ–å»¶è¿Ÿã€‚</li></ul></li><li>é€šç”¨å±éšœï¼ˆFull Barrierï¼‰ï¼š <ul><li>é€šç”¨å±éšœæ˜¯è¯»å±éšœå’Œå†™å±éšœçš„ç»„åˆï¼Œå®ƒæ—¢ç¡®ä¿ä¸€ä¸ªçº¿ç¨‹åœ¨è¯»å–å˜é‡ä¹‹å‰è·å–æœ€æ–°å€¼ï¼Œä¹Ÿç¡®ä¿åœ¨å†™å…¥å˜é‡ä¹‹åå°†å†™æ“ä½œåˆ·æ–°åˆ°ä¸»å†…å­˜ã€‚</li><li>é€šç”¨å±éšœç”¨äºæ›´ä¸¥æ ¼çš„å†…å­˜åŒæ­¥éœ€æ±‚ï¼Œä¾‹å¦‚åœ¨å¤šçº¿ç¨‹ä¹‹é—´å»ºç«‹ happens-before å…³ç³»ã€‚</li></ul></li><li>ä¼˜åŒ–å±éšœï¼ˆOptimization Barrierï¼‰ï¼š <ul><li>ä¼˜åŒ–å±éšœé€šå¸¸æ˜¯ä¸€ç§ç¼–è¯‘å™¨æˆ–è¿è¡Œæ—¶ç³»ç»Ÿçš„ä¼˜åŒ–æŠ€æœ¯ï¼Œç”¨äºé˜²æ­¢ç¼–è¯‘å™¨å¯¹æŒ‡ä»¤é‡æ’åºæˆ–ä¼˜åŒ–è¿‡åº¦ï¼Œä»è€Œå½±å“å¤šçº¿ç¨‹ç¨‹åºçš„è¡Œä¸ºã€‚</li><li>ä¼˜åŒ–å±éšœæœ‰åŠ©äºç»´æŠ¤å¤šçº¿ç¨‹ç¨‹åºçš„è¯­ä¹‰ä¸€è‡´æ€§ï¼Œç¡®ä¿ç¨‹åºä¸ä¼šå‡ºç°æ„å¤–çš„ç»“æœã€‚</li></ul></li></ol></blockquote><h3 id="monitor" tabindex="-1"><a class="header-anchor" href="#monitor" aria-hidden="true">#</a> Monitor</h3><blockquote><p><strong>Each object and its class are associated with a monitor.</strong></p></blockquote><blockquote><p>Java&#39;s monitor supports two kinds of thread synchronization: ==<em>mutual exclusion</em>== and ==<em>cooperation</em>==.</p><p>==<em>mutual exclusion</em>==, which is supported in the Java virtual machine via object locks, enables multiple threads to <strong>independently work on shared data without interfering with each other</strong>;<strong>only one thread can &quot;own&quot; at any one time.</strong></p><p>ğŸ”’æ¯ä¸ª Java å¯¹è±¡éƒ½å¯ä»¥å…³è”ä¸€ä¸ª Monitor å¯¹è±¡ï¼Œå¦‚æœä½¿ç”¨ synchronized ç»™å¯¹è±¡ä¸Šé”ï¼ˆé‡é‡çº§ï¼‰ä¹‹åï¼Œè¯¥å¯¹è±¡å¤´çš„Mark Word ä¸­å°±è¢«è®¾ç½®æŒ‡å‘ Monitor å¯¹è±¡çš„æŒ‡é’ˆ</p><p>==<em>cooperation</em>==, which is supported in the Java virtual machine via the ==wait== and ==notify== methods of class <code>Object</code>, <strong>enables threads to work together towards a common goal.</strong></p><table><thead><tr><th>Method</th><th>Description</th></tr></thead><tbody><tr><td><code>void wait();</code></td><td>Enter a monitor&#39;s wait set until notified by another thread<br>This method should <strong>only be called by</strong> a thread that is the <strong>owner of this object&#39;s monitor.</strong></td></tr><tr><td><code>void wait(long timeout); </code></td><td>Enter a monitor&#39;s wait set until notified by another thread or <code>timeout</code> milliseconds elapses</td></tr><tr><td><code>void wait(long timeout, int nanos); </code></td><td>Enter a monitor&#39;s wait set until notified by another thread or <code>timeout</code> milliseconds plus <code>nanos</code> nanoseconds elapses<br><strong>timeout</strong> â€“ the maximum time to wait in milliseconds.<br><strong>nanos</strong> â€“ additional time, in nanoseconds range 0-999999.</td></tr><tr><td><code>void notify();</code></td><td>Wake up one thread waiting in the monitor&#39;s wait set. (If no threads are waiting, do nothing.)</td></tr><tr><td><code>void notifyAll();</code></td><td>Wake up all threads waiting in the monitor&#39;s wait set. (If no threads are waiting, do nothing.)</td></tr></tbody></table></blockquote><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230210222837992.png" alt="image-20230210222837992"></p><blockquote><ul><li>åˆšå¼€å§‹ Monitor ä¸­ Owner ä¸º null</li><li>ï¼ˆ==ä¸Šé”==ï¼‰å½“ Thread-3 æ‰§è¡Œ synchronized(obj) å°±ä¼šå°† Monitor çš„æ‰€æœ‰è€… Owner ç½®ä¸º Thread-3ï¼ŒMonitorä¸­åªèƒ½æœ‰ä¸€ä¸ª Owner</li><li>åœ¨ Thread-3 ä¸Šé”çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœ Thread-4ï¼ŒThread-5ï¼ŒThread-6 ä¹Ÿæ¥æ‰§è¡Œ synchronized(ObjectA)ï¼Œå°±ä¼šè¿›å…¥ EntryList BLOCKED</li><li>ï¼ˆ==è§£é”==ï¼‰Thread-3 æ‰§è¡Œå®ŒåŒæ­¥ä»£ç å—çš„å†…å®¹ä¼šé‡Šæ”¾é”ï¼Œå°†Ownerç½®ä¸ºnullç„¶åå”¤é†’ EntryList ä¸­ç­‰å¾…çš„çº¿ç¨‹æ¥ç«äº‰é”ï¼Œç«äº‰çš„æ—¶æ˜¯éå…¬å¹³çš„</li><li>å›¾ä¸­ WaitSet ä¸­çš„ Thread-1ï¼ŒThread-2 æ˜¯ä¹‹å‰è·å¾—è¿‡é”ï¼Œä½†æ¡ä»¶ä¸æ»¡è¶³è¿›å…¥ WAITING çŠ¶æ€çš„çº¿ç¨‹</li></ul></blockquote><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230210133507494.png" alt="image-20230210133507494"></p><h3 id="synchronized" tabindex="-1"><a class="header-anchor" href="#synchronized" aria-hidden="true">#</a> synchronized</h3><h4 id="synchronizedåº•å±‚å®ç°" tabindex="-1"><a class="header-anchor" href="#synchronizedåº•å±‚å®ç°" aria-hidden="true">#</a> synchronizedåº•å±‚å®ç°</h4><blockquote><p><strong>å½“ä¸€ä¸ªçº¿ç¨‹è¯•å›¾è®¿é—®synchronizedåŒæ­¥ä»£ç å—æˆ–æ–¹æ³•æ—¶</strong>ï¼Œå®ƒé¦–å…ˆ<strong>å¿…é¡»å¾—åˆ°é”</strong>;</p><p><strong>é€€å‡ºæˆ–æŠ›å‡ºå¼‚å¸¸æ—¶å¿…é¡»é‡Šæ”¾é”</strong></p><p>JVMåŸºäºè¿›å…¥å’Œé€€å‡ºMonitorå¯¹è±¡æ¥å®ç°æ–¹æ³•åŒæ­¥å’Œä»£ç å—åŒæ­¥</p><p><strong>ä»£ç å—çº§åˆ«</strong>çš„ JVMä¸­==monitorenter==å’Œ==monitorexit==å­—èŠ‚ç æŒ‡ä»¤ä¾èµ–äºåº•å±‚çš„æ“ä½œç³»ç»Ÿçš„<strong>Mutex Lock</strong>æ¥å®ç°çš„</p><p><strong>æ–¹æ³•çº§åˆ«</strong>çš„ synchronized ä¸ä¼šåœ¨å­—èŠ‚ç æŒ‡ä»¤ä¸­æœ‰æ‰€ä½“ç°</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//--------monitorenter</span>
	<span class="token comment">//critical section</span>
<span class="token punctuation">}</span><span class="token comment">//----------------------------monitorexit</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="synchronizedåº”ç”¨" tabindex="-1"><a class="header-anchor" href="#synchronizedåº”ç”¨" aria-hidden="true">#</a> synchronizedåº”ç”¨</h4><blockquote><p>==å¯¹è±¡é”==</p><p>In the Java virtual machine, <strong>every object and class is logically associated with a ==monitor==.</strong></p><p>==ç±»é”==</p><p>Class locks are actually implemented as object locks. As mentioned in earlier chapters, when the Java virtual machine loads a class file, it creates an instance of <code>class java.lang.Class.</code> When you lock a class, you are actually locking that class&#39;s Class object.</p></blockquote><p>==åº”ç”¨äºæ–¹æ³•ä¸Š==</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//å¯¹è±¡é” é»˜è®¤ä¸ºthiså¯¹è±¡</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">test3</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//ç±»é” é»˜è®¤çš„é”å°±æ˜¯å½“å‰æ‰€åœ¨çš„Classç±»</span>
    <span class="token comment">/*Class locks are actually implemented as object locks. As mentioned in earlier chapters, when the Java virtual machine loads a class file, it creates an instance of class java.lang.Class. When you lock a class, you are actually locking that class&#39;s Class object. */</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>==åº”ç”¨äºä»£ç å—==</p><p>å¯ä»¥æŒ‡å®šä»»æ„å¯¹è±¡ä½œä¸ºé”</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//å¯¹è±¡é”</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//ç±»é”</span>
    <span class="token comment">/*Class locks are actually implemented as object locks. As mentioned in earlier chapters, when the Java virtual machine loads a class file, it creates an instance of class java.lang.Class. When you lock a class, you are actually locking that class&#39;s Class object. */</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="synchronizedé”çš„å‡çº§" tabindex="-1"><a class="header-anchor" href="#synchronizedé”çš„å‡çº§" aria-hidden="true">#</a> synchronizedé”çš„å‡çº§</h4><blockquote><p>Java SE 1.6é‡ŒSynchroniedåŒæ­¥é”ï¼Œä¸€å…±æœ‰å››ç§çŠ¶æ€ï¼š<code>æ— é”</code>ã€<code>åå‘é”</code>ã€<code>è½»é‡çº§é”</code>ã€<code>é‡é‡çº§é”</code>ï¼Œå®ƒä¼š<strong>éšç€ç«äº‰</strong>æƒ…å†µ<strong>é€æ¸å‡çº§</strong>ã€‚é”å¯ä»¥å‡çº§ä½†æ˜¯<strong>ä¸å¯ä»¥é™çº§</strong>ï¼Œ</p><p>ç›®çš„æ˜¯ä¸ºäº†<strong>æé«˜è·å–é”å’Œé‡Šæ”¾é”çš„æ•ˆç‡</strong>ã€‚</p><p>å¯ä»¥é€šè¿‡-XX:-UseBiasedLocking=falseæ¥ç¦ç”¨åå‘é”ã€‚</p><p>é”è†¨èƒ€æ–¹å‘ï¼š æ— é” â†’ åå‘é” â†’ è½»é‡çº§é” â†’ é‡é‡çº§é” (æ­¤è¿‡ç¨‹æ˜¯ä¸å¯é€†çš„)</p></blockquote><table><thead><tr><th>é”</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th><th>ä½¿ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>åå‘é”</td><td>åŠ é”å’Œè§£é”ä¸éœ€è¦CASæ“ä½œï¼Œæ²¡æœ‰é¢å¤–çš„æ€§èƒ½æ¶ˆè€—ï¼Œå’Œæ‰§è¡ŒéåŒæ­¥æ–¹æ³•ç›¸æ¯”ä»…å­˜åœ¨çº³ç§’çº§çš„å·®è·</td><td>å¦‚æœçº¿ç¨‹é—´å­˜åœ¨é”ç«äº‰ï¼Œä¼šå¸¦æ¥é¢å¤–çš„é”æ’¤é”€çš„æ¶ˆè€—</td><td>é€‚ç”¨äºåªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®åŒæ­¥å—çš„åœºæ™¯</td></tr><tr><td>è½»é‡çº§é”</td><td>ç«äº‰çš„çº¿ç¨‹ä¸ä¼šé˜»å¡ï¼Œæé«˜äº†å“åº”é€Ÿåº¦</td><td>å¦‚çº¿ç¨‹å§‹ç»ˆå¾—ä¸åˆ°é”ç«äº‰çš„çº¿ç¨‹ï¼Œä½¿ç”¨è‡ªæ—‹ä¼šæ¶ˆè€—CPUæ€§èƒ½</td><td>è¿½æ±‚å“åº”æ—¶é—´ï¼ŒåŒæ­¥å—æ‰§è¡Œé€Ÿåº¦éå¸¸å¿«</td></tr><tr><td>é‡é‡çº§é”</td><td>çº¿ç¨‹ç«äº‰ä¸é€‚ç”¨è‡ªæ—‹ï¼Œä¸ä¼šæ¶ˆè€—CPU</td><td>çº¿ç¨‹é˜»å¡ï¼Œå“åº”æ—¶é—´ç¼“æ…¢ï¼Œåœ¨å¤šçº¿ç¨‹ä¸‹ï¼Œé¢‘ç¹çš„è·å–é‡Šæ”¾é”ï¼Œä¼šå¸¦æ¥å·¨å¤§çš„æ€§èƒ½æ¶ˆè€—</td><td>è¿½æ±‚ååé‡ï¼ŒåŒæ­¥å—æ‰§è¡Œé€Ÿåº¦è¾ƒé•¿</td></tr></tbody></table><h5 id="åå‘é”" tabindex="-1"><a class="header-anchor" href="#åå‘é”" aria-hidden="true">#</a> åå‘é”</h5><blockquote><p>å¼•å…¥èƒŒæ™¯ï¼šåœ¨å¤§å¤šå®é™…ç¯å¢ƒä¸‹ï¼Œé”ä¸ä»…ä¸å­˜åœ¨å¤šçº¿ç¨‹ç«äº‰ï¼Œè€Œä¸”æ€»æ˜¯ç”±åŒä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡è·å–ï¼Œé‚£ä¹ˆåœ¨åŒä¸€ä¸ªçº¿ç¨‹åå¤è·å–æ‰€é‡Šæ”¾é”ä¸­ï¼Œå…¶ä¸­å¹¶è¿˜æ²¡æœ‰é”çš„ç«äº‰ï¼Œé‚£ä¹ˆè¿™æ ·çœ‹ä¸Šå»ï¼Œå¤šæ¬¡çš„è·å–é”å’Œé‡Šæ”¾é”å¸¦æ¥äº†å¾ˆå¤šä¸å¿…è¦çš„æ€§èƒ½å¼€é”€å’Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</p><p><strong>åå‘é”</strong>ã€‚å½“ä¸€ä¸ªçº¿ç¨‹è®¿é—®åŒæ­¥å—å¹¶è·å–é”æ—¶ï¼Œä¼šåœ¨å¯¹è±¡å¤´å’Œæ ˆå¸§ä¸­çš„é”è®°å½•é‡Œå­˜å‚¨é”åå‘çš„çº¿ç¨‹IDï¼Œä»¥åè¯¥çº¿ç¨‹åœ¨è¿›å…¥å’Œé€€å‡ºåŒæ­¥å—æ—¶ä¸éœ€è¦è¿›è¡ŒCASæ“ä½œæ¥åŠ é”å’Œè§£é”ã€‚åªéœ€è¦ç®€å•çš„æµ‹è¯•ä¸€ä¸‹å¯¹è±¡å¤´çš„<code>Mark Word</code>é‡Œæ˜¯å¦å­˜å‚¨ç€æŒ‡å‘å½“å‰çº¿ç¨‹çš„åå‘é”ã€‚å¦‚æœæˆåŠŸï¼Œè¡¨ç¤ºçº¿ç¨‹å·²ç»è·å–åˆ°äº†é”ï¼›å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œåˆ™éœ€è¦å†æµ‹è¯•ä¸€ä¸‹Mark Wordä¸­åå‘é”çš„æ ‡è¯†æ˜¯å¦è®¾ç½®æˆ1ï¼ˆè¡¨ç¤ºå½“å‰æ˜¯åå‘é”ï¼‰ï¼šå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œåˆ™ä½¿ç”¨CASç«äº‰é”ï¼›å¦‚æœè®¾ç½®äº†ï¼Œåˆ™å°è¯•ä½¿ç”¨CASå°†å¯¹è±¡å¤´çš„åå‘é”æŒ‡å‘å½“å‰çº¿ç¨‹</p><p>å¤„äºåå‘é”çš„å¯¹è±¡è§£é”åï¼Œçº¿ç¨‹ id ä»å­˜å‚¨äºå¯¹è±¡å¤´ä¸­</p><p>åå‘æ˜¯ç±»åå‘ï¼ˆæ•´ä¸ªç±»çš„å¯¹è±¡å¯åå‘æˆ–æ•´ä¸ªç±»çš„å¯¹è±¡ä¸å¯åå‘ï¼‰</p><p><strong>åå‘é”çš„æ’¤é”€</strong></p><p>åå‘é”ä½¿ç”¨äº†ä¸€ç§ç­‰å¾…ç«äº‰å‡ºç°æ‰ä¼šé‡Šæ”¾é”çš„æœºåˆ¶ã€‚æ‰€ä»¥å½“å…¶ä»–çº¿ç¨‹å°è¯•è·å–åå‘é”æ—¶ï¼ŒæŒæœ‰åå‘é”çš„çº¿ç¨‹æ‰ä¼šé‡Šæ”¾é”ã€‚ä½†æ˜¯åå‘é”çš„æ’¤é”€éœ€è¦ç­‰åˆ°å…¨å±€å®‰å…¨ç‚¹(å°±æ˜¯å½“å‰çº¿ç¨‹æ²¡æœ‰æ­£åœ¨æ‰§è¡Œçš„å­—èŠ‚ç )ã€‚å®ƒä¼šé¦–å…ˆæš‚åœæ‹¥æœ‰åå‘é”çš„çº¿ç¨‹ï¼Œç„¶åæ£€æŸ¥æŒæœ‰åå‘é”çš„çº¿ç¨‹æ˜¯å¦æ´»ç€ã€‚å¦‚æœçº¿ç¨‹ä¸å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œç›´æ¥å°†å¯¹è±¡å¤´è®¾ç½®ä¸ºæ— é”çŠ¶æ€ã€‚å¦‚æœçº¿ç¨‹æ´»ç€ï¼ŒJVMä¼šéå†æ ˆå¸§ä¸­çš„é”è®°å½•ï¼Œæ ˆå¸§ä¸­çš„é”è®°å½•å’Œå¯¹è±¡å¤´è¦ä¹ˆåå‘äºå…¶ä»–çº¿ç¨‹ï¼Œè¦ä¹ˆæ¢å¤åˆ°æ— é”çŠ¶æ€æˆ–è€…æ ‡è®°å¯¹è±¡ä¸é€‚åˆä½œä¸ºåå‘é”ã€‚</p><p>åå‘é”æ˜¯é»˜è®¤æ˜¯å»¶è¿Ÿçš„ï¼Œä¸ä¼šåœ¨ç¨‹åºå¯åŠ¨æ—¶ç«‹å³ç”Ÿæ•ˆï¼Œå¦‚æœæƒ³é¿å…å»¶è¿Ÿï¼Œå¯ä»¥åŠ  VM å‚æ•° ã€-XX:BiasedLockingStartupDelay=0 ã€‘æ¥ç¦ç”¨å»¶è¿Ÿ</p><p><strong>å‡ ç§ä¼šä½¿åå‘é”å¤±æ•ˆï¼ˆæ’¤é”€ï¼‰çš„æƒ…å†µ</strong></p><ul><li>è°ƒç”¨å¯¹è±¡ hashCode</li><li>-XX:-UseBiasedLocking</li><li>å½“å…¶ä»–çº¿ç¨‹å°è¯•è·å–åå‘é”æ—¶ï¼›ç«äº‰å‡ºç°</li><li>è°ƒç”¨wait/notify</li></ul><p><strong>æ‰¹é‡é‡åå‘</strong></p><p>å¦‚æœå¯¹è±¡è™½ç„¶è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®ï¼Œä½†æ²¡æœ‰ç«äº‰ï¼Œè¿™æ—¶åå‘äº†çº¿ç¨‹ T1 çš„å¯¹è±¡ä»æœ‰æœºä¼šé‡æ–°åå‘ T2ï¼Œé‡åå‘ä¼šé‡ç½®å¯¹è±¡çš„ Thread IDå½“æ’¤é”€åå‘é”é˜ˆå€¼è¶…è¿‡ 20 æ¬¡åï¼Œjvm ä¼šè¿™æ ·è§‰å¾—ï¼Œæˆ‘æ˜¯ä¸æ˜¯åå‘é”™äº†å‘¢ï¼Œäºæ˜¯ä¼šåœ¨ç»™è¿™äº›å¯¹è±¡åŠ é”æ—¶é‡æ–°åå‘è‡³åŠ é”çº¿ç¨‹</p><p><strong>æ‰¹é‡æ’¤é”€</strong></p><p>å½“æ’¤é”€åå‘é”é˜ˆå€¼è¶…è¿‡ 40 æ¬¡åï¼Œjvm ä¼šè¿™æ ·è§‰å¾—ï¼Œè‡ªå·±ç¡®å®åå‘é”™äº†ï¼Œæ ¹æœ¬å°±ä¸è¯¥åå‘ã€‚äºæ˜¯<strong>æ•´ä¸ªç±»çš„æ‰€æœ‰å¯¹è±¡éƒ½ä¼šå˜ä¸ºä¸å¯åå‘çš„</strong>ï¼Œæ–°å»ºçš„å¯¹è±¡ä¹Ÿæ˜¯ä¸å¯åå‘çš„</p></blockquote><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230211204001023.png" alt="image-20230211204001023"></p><h5 id="è½»é‡çº§é”" tabindex="-1"><a class="header-anchor" href="#è½»é‡çº§é”" aria-hidden="true">#</a> è½»é‡çº§é”</h5><blockquote><p>å¦‚æœä¸€ä¸ªå¯¹è±¡è™½ç„¶æœ‰å¤šçº¿ç¨‹è¦åŠ é”ï¼Œä½†åŠ é”çš„æ—¶é—´æ˜¯é”™å¼€çš„ï¼ˆä¹Ÿå°±æ˜¯æ²¡æœ‰ç«äº‰ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨è½»é‡çº§é”æ¥ä¼˜åŒ–</p><p><strong>è½»é‡çº§é”åŠ é”</strong></p><p>åœ¨çº¿ç¨‹æ‰§è¡ŒåŒæ­¥å—ä¹‹å‰ï¼ŒJVMä¼šå…ˆåœ¨å½“å‰çº¿ç¨‹çš„æ ˆå¸§ä¸­åˆ›å»ºä¸€ä¸ªåä¸ºé”è®°å½•(<code>Lock Record</code>)çš„ç©ºé—´ï¼Œç”¨äºå­˜å‚¨é”å¯¹è±¡ç›®å‰çš„<code>Mark Word</code>çš„æ‹·è´(JVMä¼šå°†å¯¹è±¡å¤´ä¸­çš„<code>Mark Word</code>æ‹·è´åˆ°é”è®°å½•ä¸­ï¼Œå®˜æ–¹ç§°ä¸º<code>Displaced Mark Ward</code>)</p><p>åˆ›å»ºé”è®°å½•ï¼ˆLock Recordï¼‰å¯¹è±¡ï¼Œæ¯ä¸ªçº¿ç¨‹çš„æ ˆå¸§éƒ½ä¼šåŒ…å«ä¸€ä¸ªé”è®°å½•çš„ç»“æ„ï¼Œå†…éƒ¨å¯ä»¥å­˜å‚¨é”å®šå¯¹è±¡çš„ Mark Word è®©é”è®°å½•ä¸­ Object reference æŒ‡å‘é”å¯¹è±¡ï¼Œå¹¶å°è¯•ç”¨ cas æ›¿æ¢ Object çš„ Mark Wordï¼Œå°† Mark Word çš„å€¼å­˜å…¥é”è®°å½•</p><ul><li><p>æˆåŠŸï¼šcas æ›¿æ¢æˆåŠŸï¼Œå¯¹è±¡å¤´ä¸­å­˜å‚¨äº†é”è®°å½•åœ°å€å’ŒçŠ¶æ€ 00 ï¼Œè¡¨ç¤ºç”±è¯¥çº¿ç¨‹ç»™å¯¹è±¡åŠ é”</p></li><li><p>å¤±è´¥:</p><p>â‘ è‡ªå·±æ‰§è¡Œäº†synchronizedé”é‡å…¥ï¼Œæ·»åŠ ä¸€æ¡Lock Recordè®°å½•ä½œä¸ºé‡å…¥è®¡æ•°</p><p>â‘¡å…¶ä»–çº¿ç¨‹å·²ç»æŒæœ‰äº†è¯¥å¯¹è±¡Objectçš„è½»é‡çº§é”ï¼›è¡¨æ˜å­˜åœ¨ç«äº‰ï¼Œé”è¿›å…¥è†¨èƒ€çŠ¶æ€ï¼ˆé‡é‡çº§é”ï¼‰</p><p>â€‹ ä¸ºObjectå¯¹è±¡ç”³è¯·Monitoré”ï¼Œè®©Objectï¼ˆmark mordï¼‰æŒ‡å‘é‡é‡çº§é”åœ°å€ï¼ˆmonitorï¼‰ï¼›ç„¶åè‡ªå·±è¿›å…¥Monitorçš„Entry Seté˜Ÿåˆ—ä¸­é˜»å¡</p></li></ul><p><strong>è½»é‡çº§é”è§£é”</strong></p><ul><li><p>å½“é€€å‡º synchronized ä»£ç å—ï¼ˆè§£é”æ—¶ï¼‰å¦‚æœæœ‰å–å€¼ä¸º null çš„é”è®°å½•ï¼Œè¡¨ç¤ºæœ‰é‡å…¥ï¼Œè¿™æ—¶é‡ç½®é”è®°å½•ï¼Œè¡¨ç¤ºé‡å…¥è®¡æ•°å‡ä¸€</p></li><li><p>å½“é€€å‡º synchronized ä»£ç å—ï¼ˆè§£é”æ—¶ï¼‰é”è®°å½•çš„å€¼ä¸ä¸º nullï¼Œè¿™æ—¶ä½¿ç”¨ cas å°† Mark Word çš„å€¼æ¢å¤ç»™å¯¹è±¡å¤´</p><p>â‘ è§£é”æˆåŠŸ</p><p>â‘¡è½»é‡çº§é”è¿›è¡Œäº†é”è†¨èƒ€å‡çº§ä¸ºé‡é‡çº§é”ï¼›è¿›å…¥é‡é‡çº§é”çš„è§£é”æ–¹å¼ æŒ‰ç…§ Monitor åœ°å€æ‰¾åˆ° Monitor å¯¹è±¡ï¼Œè®¾ç½® Owner ä¸º nullï¼Œå”¤é†’ EntryList ä¸­ BLOCKED çº¿ç¨‹</p></li></ul></blockquote><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230211213238099.png" alt="image-20230211213238099"></p><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230211213902673.png" alt="image-20230211213902673"></p><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230211214340673.png" alt="image-20230211214340673"></p><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230211214535858.png" alt="image-20230211214535858"></p><h5 id="è‡ªæ—‹é”ä¸è‡ªé€‚åº”è‡ªæ—‹é”" tabindex="-1"><a class="header-anchor" href="#è‡ªæ—‹é”ä¸è‡ªé€‚åº”è‡ªæ—‹é”" aria-hidden="true">#</a> è‡ªæ—‹é”ä¸è‡ªé€‚åº”è‡ªæ—‹é”</h5><blockquote><p>==è‡ªæ—‹==</p><p>åœ¨<strong>æŒ‚èµ·çº¿ç¨‹å’Œæ¢å¤çº¿ç¨‹çš„æ“ä½œ</strong>éƒ½éœ€è¦è½¬å…¥<strong>å†…æ ¸æ€ä¸­å®Œæˆ</strong>ï¼Œè¿™äº›æ“ä½œå¯¹ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½å¸¦æ¥äº†å¾ˆå¤§çš„å‹åŠ›<strong>å½±å“å¹¶å‘æ€§</strong>ã€‚åŒæ—¶HotSpotå›¢é˜Ÿæ³¨æ„åˆ°åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œå…±äº«æ•°æ®çš„é”å®šçŠ¶æ€åªä¼šæŒç»­å¾ˆçŸ­çš„ä¸€æ®µæ—¶é—´ï¼Œä¸ºäº†è¿™æ®µæ—¶é—´å»æŒ‚èµ·å’Œå›å¤é˜»å¡çº¿ç¨‹å¹¶ä¸å€¼å¾—ã€‚åœ¨å¦‚ä»Šå¤šå¤„ç†å™¨ç¯å¢ƒä¸‹ï¼Œå®Œå…¨å¯ä»¥è®©å¦ä¸€ä¸ªæ²¡æœ‰è·å–åˆ°é”çš„çº¿ç¨‹åœ¨é—¨å¤–ç­‰å¾…ä¸€ä¼š(è‡ªæ—‹)ï¼Œä½†ä¸æ”¾å¼ƒCPUçš„æ‰§è¡Œæ—¶é—´ã€‚ç­‰å¾…æŒæœ‰é”çš„çº¿ç¨‹æ˜¯å¦å¾ˆå¿«å°±ä¼šé‡Šæ”¾é”ã€‚ä¸ºäº†è®©çº¿ç¨‹ç­‰å¾…ï¼Œæˆ‘ä»¬åªéœ€è¦è®©çº¿ç¨‹æ‰§è¡Œä¸€ä¸ªå¿™å¾ªç¯(è‡ªæ—‹)</p><ul><li><p><strong>è‡ªæ—‹ä¼˜åŠ¿</strong> è‡ªæ—‹é”æœ¬è´¨ä¸Šä¸é˜»å¡å¹¶ä¸ç›¸åŒï¼Œå…ˆä¸è€ƒè™‘å…¶å¯¹å¤šå¤„ç†å™¨çš„è¦æ±‚ï¼Œå¦‚æœé”å ç”¨çš„æ—¶é—´éå¸¸çš„çŸ­ï¼Œé‚£ä¹ˆè‡ªæ—‹é”çš„æ€§èƒ½ä¼šéå¸¸çš„å¥½</p></li><li><p><strong>è‡ªæ—‹å¼Šç«¯</strong> åœ¨çº¿ç¨‹è‡ªæ—‹æ—¶ï¼Œå§‹ç»ˆä¼šå ç”¨CPUçš„æ—¶é—´ç‰‡ï¼Œå¦‚æœé”å ç”¨çš„æ—¶é—´å¤ªé•¿ï¼Œé‚£ä¹ˆè‡ªæ—‹çš„çº¿ç¨‹ä¼šç™½ç™½æ¶ˆè€—æ‰CPUèµ„æº</p></li></ul><p>è‡ªæ—‹ç­‰å¾…çš„æ—¶é—´å¿…é¡»è¦æœ‰ä¸€å®šçš„é™åº¦ï¼Œå¦‚æœè‡ªæ—‹è¶…è¿‡äº†é™å®šçš„æ¬¡æ•°ä»ç„¶æ²¡æœ‰æˆåŠŸè·å–åˆ°é”ï¼Œå°±åº”è¯¥ä½¿ç”¨ä¼ ç»Ÿçš„æ–¹å¼å»æŒ‚èµ·çº¿ç¨‹äº†ï¼Œåœ¨JDKå®šä¹‰ä¸­ï¼Œè‡ªæ—‹é”é»˜è®¤çš„è‡ªæ—‹æ¬¡æ•°ä¸º10æ¬¡ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨å‚æ•°<code>-XX:PreBlockSpin</code>æ¥æ›´æ”¹</p><p>==è‡ªé€‚åº”è‡ªæ—‹==</p><p>åœ¨JDK 1.6ä¸­å¼•å…¥äº†è‡ªé€‚åº”è‡ªæ—‹é”ã€‚è¿™å°±æ„å‘³ç€<strong>è‡ªæ—‹çš„æ—¶é—´ä¸å†å›ºå®š</strong>äº†ï¼Œè€Œæ˜¯<strong>ç”±å‰ä¸€æ¬¡åœ¨åŒä¸€ä¸ªé”ä¸Šçš„è‡ªæ—‹ æ—¶é—´åŠé”çš„æ‹¥æœ‰è€…çš„çŠ¶æ€æ¥å†³å®š</strong>çš„ã€‚å¦‚æœåœ¨åŒä¸€ä¸ªé”å¯¹è±¡ä¸Šï¼Œè‡ªæ—‹ç­‰å¾…åˆšåˆšæˆåŠŸè·å–è¿‡é”ï¼Œå¹¶ä¸”æŒæœ‰é”çš„çº¿ç¨‹æ­£åœ¨è¿è¡Œä¸­ï¼Œé‚£ä¹ˆJVMä¼šè®¤ä¸ºè¯¥é”è‡ªæ—‹è·å–åˆ°é”çš„å¯èƒ½æ€§å¾ˆå¤§ï¼Œä¼šè‡ªåŠ¨å¢åŠ ç­‰å¾…æ—¶é—´ã€‚æ¯”å¦‚å¢åŠ åˆ°100æ­¤å¾ªç¯ã€‚ç›¸åï¼Œå¦‚æœå¯¹äºæŸä¸ªé”ï¼Œè‡ªæ—‹å¾ˆå°‘æˆåŠŸè·å–é”ã€‚é‚£å†ä»¥åè¦è·å–è¿™ä¸ªé”æ—¶å°†å¯èƒ½çœç•¥æ‰è‡ªæ—‹è¿‡ç¨‹ï¼Œä»¥é¿å…æµªè´¹å¤„ç†å™¨èµ„æºã€‚æœ‰äº†è‡ªé€‚åº”è‡ªæ—‹ï¼ŒJVMå¯¹ç¨‹åºçš„é”çš„çŠ¶æ€é¢„æµ‹ä¼šè¶Šæ¥è¶Šå‡†ç¡®ï¼ŒJVMä¹Ÿä¼šè¶Šæ¥è¶Šèªæ˜</p></blockquote><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230211220538224.png" alt="image-20230211220538224"></p><h5 id="é‡é‡çº§é”-é”è†¨èƒ€" tabindex="-1"><a class="header-anchor" href="#é‡é‡çº§é”-é”è†¨èƒ€" aria-hidden="true">#</a> é‡é‡çº§é”ï¼ˆé”è†¨èƒ€ï¼‰</h5><blockquote><p>ğŸ”’æ¯ä¸ª Java å¯¹è±¡éƒ½å¯ä»¥å…³è”ä¸€ä¸ª Monitor å¯¹è±¡ï¼Œå¦‚æœä½¿ç”¨ synchronized ç»™å¯¹è±¡ä¸Šé”ï¼ˆé‡é‡çº§ï¼‰ä¹‹åï¼Œè¯¥å¯¹è±¡å¤´çš„Mark Word ä¸­å°±è¢«è®¾ç½®æŒ‡å‘ Monitor å¯¹è±¡çš„æŒ‡é’ˆ</p><ul><li>åˆšå¼€å§‹ Monitor ä¸­ Owner ä¸º null</li><li>ï¼ˆ==ä¸Šé”==ï¼‰å½“ Thread-3 æ‰§è¡Œ synchronized(obj) å°±ä¼šå°† Monitor çš„æ‰€æœ‰è€… Owner ç½®ä¸º Thread-3ï¼ŒMonitorä¸­åªèƒ½æœ‰ä¸€ä¸ª Owner</li><li>åœ¨ Thread-3 ä¸Šé”çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœ Thread-4ï¼ŒThread-5ï¼ŒThread-6 ä¹Ÿæ¥æ‰§è¡Œ synchronized(ObjectA)ï¼Œå°±ä¼šè¿›å…¥ EntryList BLOCKED</li><li>ï¼ˆ==è§£é”==ï¼‰Thread-3 æ‰§è¡Œå®ŒåŒæ­¥ä»£ç å—çš„å†…å®¹ä¼šé‡Šæ”¾é”ï¼Œå°†Ownerç½®ä¸ºnullç„¶åå”¤é†’ EntryList ä¸­ç­‰å¾…çš„çº¿ç¨‹æ¥ç«äº‰é”ï¼Œç«äº‰çš„æ—¶æ˜¯éå…¬å¹³çš„</li><li>å›¾ä¸­ WaitSet ä¸­çš„ Thread-1ï¼ŒThread-2 æ˜¯ä¹‹å‰è·å¾—è¿‡é”ï¼Œä½†æ¡ä»¶ä¸æ»¡è¶³è¿›å…¥ WAITING çŠ¶æ€çš„çº¿ç¨‹</li></ul></blockquote><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230210222837992.png" alt="image-20230210222837992"></p><h5 id="é”æ¶ˆé™¤-åŒæ­¥çœç•¥" tabindex="-1"><a class="header-anchor" href="#é”æ¶ˆé™¤-åŒæ­¥çœç•¥" aria-hidden="true">#</a> é”æ¶ˆé™¤ï¼ˆåŒæ­¥çœç•¥ï¼‰</h5><blockquote><p>é”æ¶ˆé™¤æ˜¯æŒ‡è™šæ‹Ÿæœºå³æ—¶ç¼–è¯‘å™¨å†è¿è¡Œæ—¶ï¼Œå¯¹ä¸€äº›ä»£ç ä¸Šè¦æ±‚åŒæ­¥ï¼Œä½†æ˜¯è¢«æ£€æµ‹åˆ°ä¸å¯èƒ½å­˜åœ¨å…±äº«æ•°æ®ç«äº‰çš„é”è¿›è¡Œæ¶ˆé™¤ã€‚</p><p>é”æ¶ˆé™¤çš„ä¸»è¦åˆ¤å®šä¾æ®æ¥æºäº==é€ƒé€¸åˆ†æ==çš„æ•°æ®æ”¯æŒã€‚æ„æ€å°±æ˜¯ï¼šJVMä¼šåˆ¤æ–­å†ä¸€æ®µç¨‹åºä¸­çš„åŒæ­¥æ˜æ˜¾ä¸ä¼šé€ƒé€¸å‡ºå»ä»è€Œè¢«å…¶ä»–çº¿ç¨‹è®¿é—®åˆ°ï¼Œé‚£JVMå°±æŠŠå®ƒä»¬å½“ä½œæ ˆä¸Šæ•°æ®å¯¹å¾…ï¼Œ<strong>è®¤ä¸ºè¿™äº›æ•°æ®æ˜¯çº¿ç¨‹ç‹¬æœ‰çš„ï¼Œä¸éœ€è¦åŠ åŒæ­¥ã€‚æ­¤æ—¶å°±ä¼šè¿›è¡Œé”æ¶ˆé™¤</strong></p></blockquote><h3 id="volatile" tabindex="-1"><a class="header-anchor" href="#volatile" aria-hidden="true">#</a> volatile</h3><blockquote><p>å¦‚æœä¸€ä¸ªå­—æ®µè¢«å£°æ˜æˆvolatileï¼ŒJavaçº¿ç¨‹å†…å­˜æ¨¡å‹ç¡®ä¿æ‰€æœ‰çº¿ç¨‹çœ‹åˆ°è¿™ä¸ªå˜é‡çš„å€¼æ˜¯ä¸€è‡´çš„ã€‚</p><p><code>volatile</code> å…³é”®å­—å¯ä»¥<strong>ä¿è¯å˜é‡å¯è§æ€§</strong>.</p><p>å¦‚æœæˆ‘ä»¬å°†å˜é‡å£°æ˜ä¸º <strong><code>volatile</code></strong> ï¼Œè¿™å°±æŒ‡ç¤º JVMï¼Œè¿™ä¸ªå˜é‡æ˜¯å…±äº«ä¸”ä¸ç¨³å®šçš„ï¼Œ<strong>æ¯æ¬¡ä½¿ç”¨</strong>å®ƒ<strong>éƒ½åˆ°ä¸»å­˜ä¸­è¿›è¡Œè¯»å–</strong></p><p>æ¯”synchronizedçš„ä½¿ç”¨å’Œæ‰§è¡Œæˆæœ¬æ›´ä½ï¼Œå› ä¸ºå®ƒä¸ä¼šå¼•èµ·çº¿ç¨‹ä¸Šä¸‹æ–‡çš„åˆ‡æ¢å’Œè°ƒåº¦ã€‚</p><p>==å¯è§æ€§==volatile <strong>å˜é‡</strong>çš„å†…å­˜å¯è§æ€§æ˜¯åŸºäº<strong>å†…å­˜å±éšœ(Memory Barrier)</strong>:åˆç§°å†…å­˜æ …æ ï¼Œæ˜¯ä¸€ä¸ª CPU æŒ‡ä»¤ã€‚</p><ul><li>å¯¹ volatile å˜é‡çš„å†™æŒ‡ä»¤åä¼šåŠ å…¥å†™å±éšœ å†™å±éšœï¼ˆsfenceï¼‰ä¿è¯åœ¨è¯¥å±éšœä¹‹å‰çš„ï¼Œå¯¹å…±äº«å˜é‡çš„æ”¹åŠ¨ï¼Œéƒ½åŒæ­¥åˆ°ä¸»å­˜å½“ä¸­</li><li>å¯¹ volatile å˜é‡çš„è¯»æŒ‡ä»¤å‰ä¼šåŠ å…¥è¯»å±éšœ è¯»å±éšœï¼ˆlfenceï¼‰ä¿è¯åœ¨è¯¥å±éšœä¹‹åï¼Œå¯¹å…±äº«å˜é‡çš„è¯»å–ï¼ŒåŠ è½½çš„æ˜¯ä¸»å­˜ä¸­æœ€æ–°æ•°æ®</li></ul><p>==æœ‰åºæ€§==volatile æœ‰åºæ€§å®ç°volatile çš„ <strong>happens-before å…³ç³»</strong></p><ul><li>happens-before è§„åˆ™ä¸­æœ‰ä¸€æ¡æ˜¯ volatile å˜é‡è§„åˆ™ï¼šå¯¹ä¸€ä¸ª volatile åŸŸçš„å†™ï¼Œhappens-before äºä»»æ„åç»­å¯¹è¿™ä¸ª volatile åŸŸçš„è¯»ã€‚</li><li>volatile <strong>ç¦æ­¢é‡æ’åº</strong> å†™å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†å†™å±éšœä¹‹å‰çš„ä»£ç æ’åœ¨å†™å±éšœä¹‹å è¯»å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†è¯»å±éšœä¹‹åçš„ä»£ç æ’åœ¨è¯»å±éšœä¹‹å‰</li></ul></blockquote><h3 id="threadlocal" tabindex="-1"><a class="header-anchor" href="#threadlocal" aria-hidden="true">#</a> ThreadLocal</h3><blockquote><p>ThreadLocalæ˜¯ä¸€ä¸ªå°†<strong>åœ¨å¤šçº¿ç¨‹ä¸­ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹åˆ›å»ºå•ç‹¬çš„å˜é‡å‰¯æœ¬çš„ç±»</strong>; å½“ä½¿ç”¨ThreadLocalæ¥ç»´æŠ¤å˜é‡æ—¶, ThreadLocalä¼šä¸ºæ¯ä¸ªçº¿ç¨‹åˆ›å»ºå•ç‹¬çš„å˜é‡å‰¯æœ¬, <strong>åšåˆ°çº¿ç¨‹éš”ç¦»</strong>ï¼Œé¿å…å› å¤šçº¿ç¨‹æ“ä½œå…±äº«å˜é‡è€Œå¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚<strong>é¿å…äº†å‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜</strong>ã€‚</p><p>ä½¿ç”¨åè®°å¾—è°ƒç”¨ThreadLocalçš„(<code>remove(ThreadLocal&lt;?&gt; key)</code>)æ–¹æ³•æ¸…é™¤Entryå³å¯<strong>é¿å…å†…å­˜æ³„éœ²</strong>ã€‚</p><p>å¦‚æœä½ åˆ›å»ºäº†â¼€ä¸ªThreadLocal å˜é‡ï¼Œé‚£ä¹ˆè®¿é—®è¿™ä¸ªå˜é‡çš„æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰è¿™ä¸ªå˜é‡çš„æœ¬åœ°å‰¯æœ¬ã€‚å¯ä»¥å°†ThreadLocal ç±»å½¢è±¡çš„â½å–»æˆå­˜æ”¾æ•°æ®çš„ç›’â¼¦ï¼Œç›’â¼¦ä¸­å¯ä»¥å­˜å‚¨æ¯ä¸ªçº¿ç¨‹çš„ç§æœ‰æ•°æ®ã€‚</p><p>çœ‹è¿‡ä»£ç ä¹‹åå°±å¾ˆæ¸…æ™°çš„çŸ¥é“äº†ä¸ºä»€ä¹ˆThreadLocalèƒ½å¤Ÿå®ç°å˜é‡çš„å¤šçº¿ç¨‹éš”ç¦»äº†; å…¶å®å°±æ˜¯ç”¨äº†Mapçš„æ•°æ®ç»“æ„ç»™å½“å‰çº¿ç¨‹ç¼“å­˜äº†, è¦ä½¿ç”¨çš„æ—¶å€™å°±ä»æœ¬çº¿ç¨‹çš„threadLocalså¯¹è±¡ä¸­è·å–å°±å¯ä»¥äº†, keyå°±æ˜¯å½“å‰çº¿ç¨‹;</p><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230510090357356.png" alt="image-20230510090357356"></p><p>å½“ç„¶äº†åœ¨å½“å‰çº¿ç¨‹ä¸‹è·å–å½“å‰çº¿ç¨‹é‡Œé¢çš„Mapé‡Œé¢çš„å¯¹è±¡å¹¶æ“ä½œè‚¯å®šæ²¡æœ‰çº¿ç¨‹å¹¶å‘é—®é¢˜äº†, å½“ç„¶èƒ½åšåˆ°å˜é‡çš„çº¿ç¨‹é—´éš”ç¦»äº†;</p></blockquote><p><strong>å†…éƒ¨ç»´æŠ¤çš„æ˜¯â¼€ä¸ªç±»ä¼¼ Map çš„==ThreadLocalMap== æ•°æ®ç»“æ„</strong></p><blockquote><p>æœ¬è´¨ä¸Šæ¥è®², å®ƒå°±æ˜¯ä¸€ä¸ªMap, ä½†æ˜¯è¿™ä¸ªThreadLocalMapä¸æˆ‘ä»¬å¹³æ—¶è§åˆ°çš„Mapæœ‰ç‚¹ä¸ä¸€æ ·</p><ul><li>å®ƒæ²¡æœ‰å®ç°Mapæ¥å£;</li><li>å®ƒæ²¡æœ‰publicçš„æ–¹æ³•, æœ€å¤šæœ‰ä¸€ä¸ªdefaultçš„æ„é€ æ–¹æ³•, å› ä¸ºè¿™ä¸ªThreadLocalMapçš„æ–¹æ³•ä»…ä»…åœ¨ThreadLocalç±»ä¸­è°ƒç”¨, å±äºé™æ€å†…éƒ¨ç±»</li><li>ThreadLocalMapçš„Entryå®ç°ç»§æ‰¿äº†WeakReference&lt;ThreadLocal&lt;?&gt;&gt;</li><li>è¯¥æ–¹æ³•ä»…ä»…ç”¨äº†ä¸€ä¸ªEntryæ•°ç»„æ¥å­˜å‚¨Key, Value; Entryå¹¶ä¸æ˜¯é“¾è¡¨å½¢å¼, è€Œæ˜¯æ¯ä¸ªbucketé‡Œé¢ä»…ä»…æ”¾ä¸€ä¸ªEntry;</li></ul></blockquote><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230217100050423.png" alt="image-20230217100050423"></p><blockquote><p>ThreadLocal å†…éƒ¨ç»´æŠ¤çš„æ˜¯â¼€ä¸ªç±»ä¼¼ Map çš„ThreadLocalMap æ•°æ®ç»“æ„ï¼ˆThreadLocalMapæ˜¯ThreadLocalçš„é™æ€å†…éƒ¨ç±»ï¼‰ï¼Œ key ä¸ºå½“å‰å¯¹è±¡çš„ Thread å¯¹è±¡ï¼ˆå½“å‰çº¿ç¨‹å¯¹è±¡ï¼‰ï¼Œå€¼ä¸º Object å¯¹è±¡ã€‚</p></blockquote><blockquote><p>æœ€ç»ˆçš„å˜é‡æ˜¯æ”¾åœ¨äº†å½“å‰çº¿ç¨‹çš„ ThreadLocalMap ä¸­ï¼ˆç›¸å½“äºå½“å‰çº¿ç¨‹ç»´æŠ¤äº†ä¸€ä¸ªå•ç‹¬çš„å˜é‡å‰¯æœ¬ï¼Œåšåˆ°çº¿ç¨‹éš”ç¦»ï¼‰ï¼Œå¹¶ä¸æ˜¯å­˜åœ¨ ThreadLocal ä¸Šï¼ŒThreadLocal å¯ä»¥ç†è§£ä¸ºåªæ˜¯ThreadLocalMap çš„å°è£…ï¼Œä¼ é€’äº†å˜é‡å€¼ã€‚</p></blockquote><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230217095849182.png" alt="image-20230217095849182"></p><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230217095515091.png" alt="image-20230217095515091"></p><h4 id="threadlocalå†…å­˜æ³„éœ²" tabindex="-1"><a class="header-anchor" href="#threadlocalå†…å­˜æ³„éœ²" aria-hidden="true">#</a> ThreadLocalå†…å­˜æ³„éœ²</h4><blockquote><p><strong>ThreadLocalMapä½¿ç”¨ThreadLocalçš„å¼±å¼•ç”¨ä½œä¸ºkey</strong></p><p>å¦‚æœä¸€ä¸ªThreadLocalæ²¡æœ‰å¤–éƒ¨å¼ºå¼•ç”¨æ¥å¼•ç”¨å®ƒï¼Œé‚£ä¹ˆç³»ç»Ÿ GC çš„æ—¶å€™ï¼Œè¿™ä¸ªThreadLocalåŠ¿å¿…ä¼šè¢«å›æ”¶ï¼Œ<strong>è¿™æ ·ä¸€æ¥ï¼ŒThreadLocalMapä¸­å°±ä¼šå‡ºç°keyä¸ºnullçš„Entry</strong>ï¼Œå°±æ²¡æœ‰åŠæ³•è®¿é—®è¿™äº›keyä¸ºnullçš„Entryçš„valueï¼Œ<strong>å¦‚æœå½“å‰çº¿ç¨‹å†è¿Ÿè¿Ÿä¸ç»“æŸçš„è¯ï¼Œè¿™äº›keyä¸ºnullçš„Entryçš„valueå°±ä¼šä¸€ç›´å­˜åœ¨ä¸€æ¡å¼ºå¼•ç”¨é“¾ï¼šThread Ref -&gt; Thread -&gt; ThreaLocalMap -&gt; Entry -&gt; valueæ°¸è¿œæ— æ³•å›æ”¶ï¼Œé€ æˆå†…å­˜æ³„æ¼ã€‚</strong></p><ul><li><p>ä½¿ç”¨staticçš„ThreadLocalï¼Œå»¶é•¿äº†ThreadLocalçš„ç”Ÿå‘½å‘¨æœŸï¼Œå¯èƒ½å¯¼è‡´çš„å†…å­˜æ³„æ¼</p></li><li><p>åˆ†é…ä½¿ç”¨äº†ThreadLocalåˆä¸å†è°ƒç”¨get(),set(),remove()æ–¹æ³•ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´å†…å­˜æ³„æ¼</p></li></ul><p>å¯¹ç—‡ä¸‹è¯ï¼Œ<strong>æ¯æ¬¡ä½¿ç”¨å®ŒThreadLocalè°ƒç”¨<code>remove()</code>æ–¹æ³•æ¸…ç†æ‰</strong>å°±è¡Œäº†</p><h3 id="ä¸ºä»€ä¹ˆä½¿ç”¨å¼±å¼•ç”¨" tabindex="-1"><a class="header-anchor" href="#ä¸ºä»€ä¹ˆä½¿ç”¨å¼±å¼•ç”¨" aria-hidden="true">#</a> ä¸ºä»€ä¹ˆä½¿ç”¨å¼±å¼•ç”¨ï¼Ÿ</h3><ol><li>å¦‚æœä½¿ç”¨å¼ºå¼•ç”¨ï¼šæˆ‘ä»¬çŸ¥é“ï¼ŒThreadLocalMapçš„ç”Ÿå‘½å‘¨æœŸåŸºæœ¬å’ŒThreadçš„ç”Ÿå‘½å‘¨æœŸä¸€æ ·ï¼Œå½“å‰çº¿ç¨‹å¦‚æœæ²¡æœ‰ç»ˆæ­¢ï¼Œé‚£ä¹ˆThreadLocalMapå§‹ç»ˆä¸ä¼šè¢«GCå›æ”¶ï¼Œè€ŒThreadLocalMapæŒæœ‰å¯¹ThreadLocalçš„å¼ºå¼•ç”¨ï¼Œé‚£ä¹ˆThreadLocalä¹Ÿä¸ä¼šè¢«å›æ”¶ï¼Œå½“çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸé•¿ï¼Œå¦‚æœæ²¡æœ‰æ‰‹åŠ¨åˆ é™¤ï¼Œåˆ™ä¼šé€ æˆkvç´¯ç§¯ï¼Œä»è€Œå¯¼è‡´OOM</li><li>å¦‚æœä½¿ç”¨å¼±å¼•ç”¨ï¼šå¼±å¼•ç”¨ä¸­çš„å¯¹è±¡å…·æœ‰å¾ˆçŸ­çš„å£°æ˜å‘¨æœŸï¼Œå› ä¸ºåœ¨ç³»ç»ŸGCæ—¶ï¼Œåªè¦å‘ç°å¼±å¼•ç”¨ï¼Œä¸ç®¡å †ç©ºé—´æ˜¯å¦è¶³å¤Ÿï¼Œéƒ½ä¼šå°†å¯¹è±¡è¿›è¡Œå›æ”¶ã€‚è€Œå½“ThreadLocalçš„å¼ºå¼•ç”¨è¢«å›æ”¶æ—¶ï¼ŒThreadLocalMapæ‰€æŒæœ‰çš„å¼±å¼•ç”¨ä¹Ÿä¼šè¢«å›æ”¶ï¼Œå¦‚æœæ²¡æœ‰æ‰‹åŠ¨åˆ é™¤kvï¼Œé‚£ä¹ˆä¼šé€ æˆvalueç´¯ç§¯ï¼Œä¹Ÿä¼šå¯¼è‡´OOM</li></ol><p>å¯¹æ¯”å¯çŸ¥ï¼Œä½¿ç”¨<strong>å¼±å¼•ç”¨è‡³å°‘å¯ä»¥ä¿è¯ä¸ä¼šå› ä¸ºmapçš„keyç´¯ç§¯ä»è€Œå¯¼è‡´OOM</strong>ï¼Œè€Œ<strong>å¯¹åº”çš„valueå¯ä»¥é€šè¿‡removeï¼Œgetï¼Œsetæ–¹æ³•åœ¨ä¸‹ä¸€æ¬¡è°ƒç”¨æ—¶è¢«æ¸…é™¤</strong>ã€‚å¯è§ï¼Œå†…å­˜æ³„éœ²çš„æ ¹æºä¸æ˜¯å¼±å¼•ç”¨ï¼Œè€Œæ˜¯ThreadLocalMapçš„ç”Ÿå‘½å‘¨æœŸå’ŒThreadä¸€æ ·é•¿ï¼Œé€ æˆç´¯ç§¯å¯¼è‡´çš„</p></blockquote><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230414171941718.png" alt="image-20230414171941718"></p><h2 id="juc-java-util-concurrency" tabindex="-1"><a class="header-anchor" href="#juc-java-util-concurrency" aria-hidden="true">#</a> JUC(Java Util Concurrency)</h2><h3 id="abstractqueuedsynchronizer" tabindex="-1"><a class="header-anchor" href="#abstractqueuedsynchronizer" aria-hidden="true">#</a> AbstractQueuedSynchronizer</h3><blockquote><p>AQSæ˜¯ä¸€ä¸ªç”¨æ¥æ„å»ºé”å’ŒåŒæ­¥å™¨çš„æ¡†æ¶ï¼Œä½¿ç”¨AQSèƒ½ç®€å•ä¸”é«˜æ•ˆåœ°æ„é€ å‡ºåº”ç”¨å¹¿æ³›çš„å¤§é‡çš„åŒæ­¥å™¨ã€‚</p><p>ReentrantLockï¼ŒSemaphoreï¼ŒReentrantReadWriteLockï¼ŒSynchronousQueueï¼ŒFutureTaskç­‰ç­‰çš†æ˜¯åŸºäºAQSçš„.</p><p>ConcurrentåŒ…æ˜¯åŸºäºAQS (AbstractQueuedSynchronizer)æ¡†æ¶çš„ï¼ŒAQSæ¡†æ¶å€ŸåŠ©äºä¸¤ä¸ªç±»ï¼š</p><ul><li>Unsafeï¼ˆæä¾›CASæ“ä½œï¼‰</li><li>LockSupportï¼ˆæä¾›park/unparkæ“ä½œï¼‰</li></ul></blockquote><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230424135301680.png" alt="image-20230424135301680"></p><h4 id="aqsæ ¸å¿ƒæ€æƒ³" tabindex="-1"><a class="header-anchor" href="#aqsæ ¸å¿ƒæ€æƒ³" aria-hidden="true">#</a> <strong>AQSæ ¸å¿ƒæ€æƒ³</strong></h4><blockquote><p>å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºç©ºé—²ï¼Œåˆ™å°†å½“å‰è¯·æ±‚èµ„æºçš„çº¿ç¨‹è®¾ç½®ä¸ºæœ‰æ•ˆçš„å·¥ä½œçº¿ç¨‹ï¼Œå¹¶ä¸”å°†å…±äº«èµ„æºè®¾ç½®ä¸ºé”å®šçŠ¶æ€ã€‚</p><p>å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºè¢«å ç”¨ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸€å¥—çº¿ç¨‹é˜»å¡ç­‰å¾…ä»¥åŠè¢«å”¤é†’æ—¶é”åˆ†é…çš„æœºåˆ¶ã€‚</p><p>è¿™ä¸ªæœºåˆ¶AQSæ˜¯ç”¨CLHé˜Ÿåˆ—é”å®ç°çš„ï¼Œå³å°†æš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚</p></blockquote><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230424140729677.png" alt="image-20230424140729677"></p><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230424140337398.png" alt="image-20230424140337398"></p><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230801112058245.png" alt="image-20230801112058245"></p><h4 id="aqsç»“æ„" tabindex="-1"><a class="header-anchor" href="#aqsç»“æ„" aria-hidden="true">#</a> AQSç»“æ„</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// å¤´ç»“ç‚¹ï¼Œä½ ç›´æ¥æŠŠå®ƒå½“åš å½“å‰æŒæœ‰é”çš„çº¿ç¨‹ å¯èƒ½æ˜¯æœ€å¥½ç†è§£çš„</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token class-name">Node</span> head<span class="token punctuation">;</span>

<span class="token comment">// é˜»å¡çš„å°¾èŠ‚ç‚¹ï¼Œæ¯ä¸ªæ–°çš„èŠ‚ç‚¹è¿›æ¥ï¼Œéƒ½æ’å…¥åˆ°æœ€åï¼Œä¹Ÿå°±å½¢æˆäº†ä¸€ä¸ªé“¾è¡¨</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token class-name">Node</span> tail<span class="token punctuation">;</span>

<span class="token comment">// è¿™ä¸ªæ˜¯æœ€é‡è¦çš„ï¼Œä»£è¡¨å½“å‰é”çš„çŠ¶æ€ï¼Œ0ä»£è¡¨æ²¡æœ‰è¢«å ç”¨ï¼Œå¤§äº 0 ä»£è¡¨æœ‰çº¿ç¨‹æŒæœ‰å½“å‰é”</span>
<span class="token comment">// è¿™ä¸ªå€¼å¯ä»¥å¤§äº 1ï¼Œæ˜¯å› ä¸ºé”å¯ä»¥é‡å…¥ï¼Œæ¯æ¬¡é‡å…¥éƒ½åŠ ä¸Š 1</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> state<span class="token punctuation">;</span>

<span class="token comment">// ä»£è¡¨å½“å‰æŒæœ‰ç‹¬å é”çš„çº¿ç¨‹ï¼Œä¸¾ä¸ªæœ€é‡è¦çš„ä½¿ç”¨ä¾‹å­ï¼Œå› ä¸ºé”å¯ä»¥é‡å…¥</span>
<span class="token comment">// reentrantLock.lock()å¯ä»¥åµŒå¥—è°ƒç”¨å¤šæ¬¡ï¼Œæ‰€ä»¥æ¯æ¬¡ç”¨è¿™ä¸ªæ¥åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦å·²ç»æ‹¥æœ‰äº†é”</span>
<span class="token comment">// if (currentThread == getExclusiveOwnerThread()) {state++}</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">Thread</span> exclusiveOwnerThread<span class="token punctuation">;</span> <span class="token comment">//ç»§æ‰¿è‡ªAbstractOwnableSynchronizer</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="java-çº¿ç¨‹æ± " tabindex="-1"><a class="header-anchor" href="#java-çº¿ç¨‹æ± " aria-hidden="true">#</a> Java çº¿ç¨‹æ± </h3><p><strong>æ± åŒ–æŠ€æœ¯çš„æ€æƒ³</strong>ä¸»è¦æ˜¯ä¸ºäº†<strong>å‡å°‘æ¯æ¬¡è·å–èµ„æºçš„æ¶ˆè€—</strong>ï¼Œ<strong>æé«˜å¯¹èµ„æºçš„åˆ©ç”¨ç‡</strong></p><ul><li><p>==<strong>é™ä½èµ„æºæ¶ˆè€—</strong>==ã€‚é€šè¿‡é‡å¤åˆ©ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹é™ä½çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯é€ æˆçš„æ¶ˆè€—ã€‚</p></li><li><p>==<strong>æé«˜å“åº”é€Ÿåº¦</strong>==ã€‚å½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦ç­‰åˆ°çº¿ç¨‹åˆ›å»ºå°±èƒ½ç«‹å³æ‰§è¡Œã€‚</p></li><li><p>==<strong>æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§</strong>==ã€‚çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— é™åˆ¶çš„åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§ã€‚</p></li></ul><h3 id="çº¿ç¨‹æ± åŸç†åˆ†æ" tabindex="-1"><a class="header-anchor" href="#çº¿ç¨‹æ± åŸç†åˆ†æ" aria-hidden="true">#</a> çº¿ç¨‹æ± åŸç†åˆ†æ</h3><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230204232022514.png" alt="image-20230204232022514"></p><p><strong>çº¿ç¨‹æ± ä¸»è¦å¤„ç†æµç¨‹</strong></p><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230204231928198.png" alt="image-20230204231928198"></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>1ï¼‰å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹å°‘äºcorePoolSizeï¼Œåˆ™åˆ›å»ºæ–°çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼ˆæ³¨æ„ï¼Œæ‰§è¡Œè¿™ä¸€æ­¥éª¤
éœ€è¦è·å–å…¨å±€é”ï¼‰ã€‚
2ï¼‰å¦‚æœè¿è¡Œçš„çº¿ç¨‹ç­‰äºæˆ–å¤šäºcorePoolSizeï¼Œåˆ™å°†ä»»åŠ¡åŠ å…¥BlockingQueueã€‚
3ï¼‰å¦‚æœæ— æ³•å°†ä»»åŠ¡åŠ å…¥BlockingQueueï¼ˆé˜Ÿåˆ—å·²æ»¡ï¼‰ï¼Œåˆ™åˆ›å»ºæ–°çš„çº¿ç¨‹æ¥å¤„ç†ä»»åŠ¡ï¼ˆæ³¨æ„ï¼Œæ‰§
è¡Œè¿™ä¸€æ­¥éª¤éœ€è¦è·å–å…¨å±€é”ï¼‰ã€‚
4ï¼‰å¦‚æœåˆ›å»ºæ–°çº¿ç¨‹å°†ä½¿å½“å‰è¿è¡Œçš„çº¿ç¨‹è¶…å‡ºmaximumPoolSizeï¼Œä»»åŠ¡å°†è¢«æ‹’ç»ï¼Œå¹¶è°ƒç”¨
RejectedExecutionHandler.rejectedExecution()æ–¹æ³•ã€‚
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230204232431709.png" alt="image-20230204232431709"></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>   <span class="token comment">// å­˜æ”¾çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€ (runState) å’Œçº¿ç¨‹æ± å†…æœ‰æ•ˆçº¿ç¨‹çš„æ•°é‡ (workerCount)</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> ctl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token function">ctlOf</span><span class="token punctuation">(</span><span class="token constant">RUNNING</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> c <span class="token operator">&amp;</span> <span class="token constant">CAPACITY</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//ä»»åŠ¡é˜Ÿåˆ—</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> workQueue<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœä»»åŠ¡ä¸ºnullï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ctl ä¸­ä¿å­˜çš„çº¿ç¨‹æ± å½“å‰çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//  ä¸‹é¢ä¼šæ¶‰åŠåˆ° 3 æ­¥ æ“ä½œ</span>
        <span class="token comment">// 1.é¦–å…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹æ± ä¸­æ‰§è¡Œçš„ä»»åŠ¡æ•°é‡æ˜¯å¦å°äº corePoolSize</span>
        <span class="token comment">// å¦‚æœå°äºçš„è¯ï¼Œé€šè¿‡addWorker(command, true)æ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶å°†ä»»åŠ¡(command)æ·»åŠ åˆ°è¯¥çº¿ç¨‹ä¸­ï¼›ç„¶åï¼Œå¯åŠ¨è¯¥çº¿ç¨‹ä»è€Œæ‰§è¡Œä»»åŠ¡ã€‚</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&lt;</span> corePoolSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 2.å¦‚æœå½“å‰æ‰§è¡Œçš„ä»»åŠ¡æ•°é‡å¤§äºç­‰äº corePoolSize çš„æ—¶å€™å°±ä¼šèµ°åˆ°è¿™é‡Œ</span>
        <span class="token comment">// é€šè¿‡ isRunning æ–¹æ³•åˆ¤æ–­çº¿ç¨‹æ± çŠ¶æ€ï¼Œçº¿ç¨‹æ± å¤„äº RUNNING çŠ¶æ€å¹¶ä¸”é˜Ÿåˆ—å¯ä»¥åŠ å…¥ä»»åŠ¡ï¼Œè¯¥ä»»åŠ¡æ‰ä¼šè¢«åŠ å…¥è¿›å»</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRunning</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> workQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> recheck <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å†æ¬¡è·å–çº¿ç¨‹æ± çŠ¶æ€ï¼Œå¦‚æœçº¿ç¨‹æ± çŠ¶æ€ä¸æ˜¯ RUNNING çŠ¶æ€å°±éœ€è¦ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­ç§»é™¤ä»»åŠ¡ï¼Œå¹¶å°è¯•åˆ¤æ–­çº¿ç¨‹æ˜¯å¦å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ã€‚åŒæ—¶æ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isRunning</span><span class="token punctuation">(</span>recheck<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">remove</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// å¦‚æœå½“å‰çº¿ç¨‹æ± ä¸ºç©ºå°±æ–°åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¹¶æ‰§è¡Œã€‚</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>recheck<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token function">addWorker</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//3. é€šè¿‡addWorker(command, false)æ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶å°†ä»»åŠ¡(command)æ·»åŠ åˆ°è¯¥çº¿ç¨‹ä¸­ï¼›ç„¶åï¼Œå¯åŠ¨è¯¥çº¿ç¨‹ä»è€Œæ‰§è¡Œä»»åŠ¡ã€‚</span>
        <span class="token comment">//å¦‚æœaddWorker(command, false)æ‰§è¡Œå¤±è´¥ï¼Œåˆ™é€šè¿‡reject()æ‰§è¡Œç›¸åº”çš„æ‹’ç»ç­–ç•¥çš„å†…å®¹ã€‚</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="executor-æ¡†æ¶" tabindex="-1"><a class="header-anchor" href="#executor-æ¡†æ¶" aria-hidden="true">#</a> Executor æ¡†æ¶</h3><p><code>Executor</code> æ¡†æ¶æ˜¯ Java5 ä¹‹åå¼•è¿›çš„ï¼Œåœ¨ Java 5 ä¹‹åï¼Œé€šè¿‡ <code>Executor</code> æ¥å¯åŠ¨çº¿ç¨‹æ¯”ä½¿ç”¨ <code>Thread</code> çš„ <code>start</code> æ–¹æ³•æ›´å¥½ï¼Œé™¤äº†æ›´æ˜“ç®¡ç†ï¼Œæ•ˆç‡æ›´å¥½ï¼ˆç”¨çº¿ç¨‹æ± å®ç°ï¼ŒèŠ‚çº¦å¼€é”€ï¼‰å¤–ï¼Œè¿˜æœ‰å…³é”®çš„ä¸€ç‚¹ï¼šæœ‰åŠ©äºé¿å… this é€ƒé€¸é—®é¢˜ã€‚</p><blockquote><p>è¡¥å……ï¼šthis é€ƒé€¸æ˜¯æŒ‡åœ¨æ„é€ å‡½æ•°è¿”å›ä¹‹å‰å…¶ä»–çº¿ç¨‹å°±æŒæœ‰è¯¥å¯¹è±¡çš„å¼•ç”¨. è°ƒç”¨å°šæœªæ„é€ å®Œå…¨çš„å¯¹è±¡çš„æ–¹æ³•å¯èƒ½å¼•å‘ä»¤äººç–‘æƒ‘çš„é”™è¯¯ã€‚</p></blockquote><p><code>Executor</code> æ¡†æ¶ä¸ä»…åŒ…æ‹¬äº†çº¿ç¨‹æ± çš„ç®¡ç†ï¼Œè¿˜æä¾›äº†çº¿ç¨‹å·¥å‚ã€é˜Ÿåˆ—ä»¥åŠæ‹’ç»ç­–ç•¥ç­‰ï¼Œ<code>Executor</code> æ¡†æ¶è®©å¹¶å‘ç¼–ç¨‹å˜å¾—æ›´åŠ ç®€å•ã€‚</p><h4 id="executor-æ¡†æ¶ç»“æ„-ä¸‰å¤§éƒ¨åˆ†ç»„æˆ" tabindex="-1"><a class="header-anchor" href="#executor-æ¡†æ¶ç»“æ„-ä¸‰å¤§éƒ¨åˆ†ç»„æˆ" aria-hidden="true">#</a> Executor æ¡†æ¶ç»“æ„(ä¸‰å¤§éƒ¨åˆ†ç»„æˆ)</h4><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230205000128358.png" alt="image-20230205000128358"></p><ul><li>ä»»åŠ¡(<code>Runnable</code> /<code>Callable</code>)</li><li>ä»»åŠ¡çš„æ‰§è¡Œ(<code>Executor</code>)</li><li>å¼‚æ­¥è®¡ç®—çš„ç»“æœ(<code>Future</code>)</li></ul><ol><li><strong>ä¸»çº¿ç¨‹é¦–å…ˆè¦åˆ›å»ºå®ç° <code>Runnable</code> æˆ–è€… <code>Callable</code> æ¥å£çš„ä»»åŠ¡å¯¹è±¡ã€‚</strong></li><li><strong>æŠŠåˆ›å»ºå®Œæˆçš„å®ç° <code>Runnable</code>/<code>Callable</code>æ¥å£çš„ å¯¹è±¡ç›´æ¥äº¤ç»™ <code>ExecutorService</code> æ‰§è¡Œ</strong>: <code>ExecutorService.executeï¼ˆRunnable commandï¼‰</code>ï¼‰æˆ–è€…ä¹Ÿå¯ä»¥æŠŠ <code>Runnable</code> å¯¹è±¡æˆ–<code>Callable</code> å¯¹è±¡æäº¤ç»™ <code>ExecutorService</code> æ‰§è¡Œï¼ˆ<code>ExecutorService.submitï¼ˆRunnable taskï¼‰</code>æˆ– <code>ExecutorService.submitï¼ˆCallable &lt;T&gt; taskï¼‰</code>ï¼‰ã€‚</li><li><strong>å¦‚æœæ‰§è¡Œ <code>ExecutorService.submitï¼ˆâ€¦ï¼‰</code>ï¼Œ<code>ExecutorService</code> å°†è¿”å›ä¸€ä¸ªå®ç°<code>Future</code>æ¥å£çš„å¯¹è±¡</strong>ï¼ˆæˆ‘ä»¬åˆšåˆšä¹Ÿæåˆ°è¿‡äº†æ‰§è¡Œ <code>execute()</code>æ–¹æ³•å’Œ <code>submit()</code>æ–¹æ³•çš„åŒºåˆ«ï¼Œ<code>submit()</code>ä¼šè¿”å›ä¸€ä¸ª <code>FutureTask å¯¹è±¡ï¼‰ã€‚ç”±äº FutureTask</code> å®ç°äº† <code>Runnable</code>ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ›å»º <code>FutureTask</code>ï¼Œç„¶åç›´æ¥äº¤ç»™ <code>ExecutorService</code> æ‰§è¡Œã€‚</li><li><strong>æœ€åï¼Œä¸»çº¿ç¨‹å¯ä»¥æ‰§è¡Œ <code>FutureTask.get()</code>æ–¹æ³•æ¥ç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚ä¸»çº¿ç¨‹ä¹Ÿå¯ä»¥æ‰§è¡Œ <code>FutureTask.cancelï¼ˆboolean mayInterruptIfRunningï¼‰</code>æ¥å–æ¶ˆæ­¤ä»»åŠ¡çš„æ‰§è¡Œã€‚</strong></li></ol><h5 id="ä»»åŠ¡-runnable-callable" tabindex="-1"><a class="header-anchor" href="#ä»»åŠ¡-runnable-callable" aria-hidden="true">#</a> ä»»åŠ¡(<code>Runnable</code> /<code>Callable</code>)</h5><p>æ‰§è¡Œä»»åŠ¡éœ€è¦å®ç°çš„ <strong><code>Runnable</code> æ¥å£</strong> æˆ– <strong><code>Callable</code>æ¥å£</strong>ã€‚<strong><code>Runnable</code> æ¥å£</strong>æˆ– <strong><code>Callable</code> æ¥å£</strong> å®ç°ç±»éƒ½å¯ä»¥è¢« <strong><code>ThreadPoolExecutor</code></strong> æˆ– <strong><code>ScheduledThreadPoolExecutor</code></strong> æ‰§è¡Œã€‚</p><h5 id="ä»»åŠ¡çš„æ‰§è¡Œ-executor" tabindex="-1"><a class="header-anchor" href="#ä»»åŠ¡çš„æ‰§è¡Œ-executor" aria-hidden="true">#</a> ä»»åŠ¡çš„æ‰§è¡Œ(<code>Executor</code>)</h5><p>ä»»åŠ¡æ‰§è¡Œæœºåˆ¶çš„æ ¸å¿ƒæ¥å£ <strong><code>Executor</code></strong> ï¼Œä»¥åŠç»§æ‰¿è‡ª <code>Executor</code> æ¥å£çš„ <strong><code>ExecutorService</code> æ¥å£ã€‚</strong></p><p><strong><code>ThreadPoolExecutor</code></strong> å’Œ</p><p><strong><code>ScheduledThreadPoolExecutor</code></strong></p><p>è¿™ä¸¤ä¸ªå…³é”®ç±»å®ç°äº† <strong>ExecutorService æ¥å£</strong>ã€‚</p><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230205000754985.png" alt="image-20230205000754985"></p><h5 id="å¼‚æ­¥è®¡ç®—çš„ç»“æœ-future" tabindex="-1"><a class="header-anchor" href="#å¼‚æ­¥è®¡ç®—çš„ç»“æœ-future" aria-hidden="true">#</a> å¼‚æ­¥è®¡ç®—çš„ç»“æœ(<code>Future</code>)</h5><p><strong><code>Future</code></strong> æ¥å£ä»¥åŠ <code>Future</code> æ¥å£çš„å®ç°ç±» <strong><code>FutureTask</code></strong> ç±»éƒ½å¯ä»¥ä»£è¡¨å¼‚æ­¥è®¡ç®—çš„ç»“æœã€‚</p><p>å½“æˆ‘ä»¬æŠŠ <strong><code>Runnable</code>æ¥å£</strong> æˆ– <strong><code>Callable</code> æ¥å£</strong> çš„å®ç°ç±»æäº¤ç»™ <strong><code>ThreadPoolExecutor</code></strong> æˆ– <strong><code>ScheduledThreadPoolExecutor</code></strong> æ‰§è¡Œã€‚ï¼ˆè°ƒç”¨ <code>submit()</code> æ–¹æ³•æ—¶ä¼šè¿”å›ä¸€ä¸ª <strong><code>FutureTask</code></strong> å¯¹è±¡ï¼‰</p><h4 id="executorså·¥å…·ç±»" tabindex="-1"><a class="header-anchor" href="#executorså·¥å…·ç±»" aria-hidden="true">#</a> Executorså·¥å…·ç±»</h4><blockquote><p>ä½¿ç”¨çº¿ç¨‹æ± çš„å¥½å¤„æ˜¯å‡å°‘åœ¨åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ä¸Šæ‰€æ¶ˆè€—çš„æ—¶é—´ä»¥åŠç³»ç»Ÿèµ„æºå¼€é”€ï¼Œè§£å†³èµ„æºä¸è¶³çš„é—®é¢˜ã€‚å¦‚æœä¸ä½¿ç”¨çº¿ç¨‹æ± ï¼Œæœ‰å¯èƒ½ä¼šé€ æˆç³»ç»Ÿåˆ›å»ºå¤§é‡åŒç±»çº¿ç¨‹è€Œå¯¼è‡´æ¶ˆè€—å®Œå†…å­˜æˆ–è€…â€œè¿‡åº¦åˆ‡æ¢â€çš„é—®é¢˜ã€‚</p></blockquote><p>å¦å¤–ï¼Œã€Šé˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œã€‹ä¸­<strong>å¼ºåˆ¶</strong>çº¿ç¨‹æ± <strong>ä¸å…è®¸ä½¿ç”¨</strong> <code>Executors</code> å»åˆ›å»ºï¼Œè€Œæ˜¯é€šè¿‡ <code>ThreadPoolExecutor</code> æ„é€ å‡½æ•°çš„æ–¹å¼ï¼Œè¿™æ ·çš„å¤„ç†æ–¹å¼è®©å†™çš„åŒå­¦æ›´åŠ æ˜ç¡®çº¿ç¨‹æ± çš„è¿è¡Œè§„åˆ™ï¼Œè§„é¿èµ„æºè€—å°½çš„é£é™©</p><p><strong>é€šè¿‡ <code>Executor</code> æ¡†æ¶çš„å·¥å…·ç±» <code>Executors</code> æ¥å®ç°</strong> æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸‰ç§ç±»å‹çš„ <code>ThreadPoolExecutor</code>ï¼š</p><ul><li><code>FixedThreadPool</code></li><li><code>SingleThreadExecutor</code></li><li><code>CachedThreadPool</code></li></ul><h3 id="threadpoolexecutorâ˜…" tabindex="-1"><a class="header-anchor" href="#threadpoolexecutorâ˜…" aria-hidden="true">#</a> ThreadPoolExecutorâ˜…</h3><blockquote><p><strong>çº¿ç¨‹æ± å®ç°ç±» <code>ThreadPoolExecutor</code> æ˜¯ <code>Executor</code> æ¡†æ¶æœ€æ ¸å¿ƒçš„ç±»</strong></p><p><strong>æ¨èä½¿ç”¨ <code>ThreadPoolExecutor</code> æ„é€ å‡½æ•°åˆ›å»ºçº¿ç¨‹æ± </strong></p><p>Parametersï¼š</p><ul><li><strong>int corePoolSize,//æ ¸å¿ƒçº¿ç¨‹æ•°</strong></li><li><strong>int maximumPoolSize,//çº¿ç¨‹æ± ä¸­æœ€å¤§çº¿ç¨‹æ•°</strong></li><li><strong>long keepAliveTime,//çº¿ç¨‹æ± ä¸­éæ ¸å¿ƒç©ºé—²çº¿ç¨‹çš„å­˜æ´»æ—¶é—´</strong></li><li>TimeUnit unit,//å­˜æ´»æ—¶é—´å•ä½</li><li>BlockingQueue workQueue,//é˜»å¡é˜Ÿåˆ—</li><li>ThreadFactory threadFactory,//çº¿ç¨‹å·¥å‚</li><li>RejectedExecutionHandler handler//æ‹’æ¥ç­–ç•¥</li></ul></blockquote><p><strong><code>ThreadPoolExecutor</code> 3 ä¸ªæœ€é‡è¦çš„å‚æ•°ï¼š</strong></p><ul><li><p><strong><code>corePoolSize</code></strong> : æ ¸å¿ƒçº¿ç¨‹æ•°çº¿ç¨‹æ•°å®šä¹‰äº†æœ€å°å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡ã€‚</p></li><li><p><strong><code>maximumPoolSize</code> :</strong> å½“é˜Ÿåˆ—ä¸­å­˜æ”¾çš„ä»»åŠ¡è¾¾åˆ°é˜Ÿåˆ—å®¹é‡çš„æ—¶å€™ï¼Œå½“å‰å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡å˜ä¸ºæœ€å¤§çº¿ç¨‹æ•°ã€‚</p></li><li><p><strong><code>workQueue</code>:</strong> å½“æ–°ä»»åŠ¡æ¥çš„æ—¶å€™ä¼šå…ˆåˆ¤æ–­å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°é‡æ˜¯å¦è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¦‚æœè¾¾åˆ°çš„è¯ï¼Œæ–°ä»»åŠ¡å°±ä¼šè¢«å­˜æ”¾åœ¨é˜Ÿåˆ—ä¸­ã€‚<strong>é˜»å¡é˜Ÿåˆ—</strong></p><ul><li><code>ArrayBlockingQueue</code>ï¼šæ˜¯ä¸€ä¸ªåŸºäºæ•°ç»„ç»“æ„çš„<strong>æœ‰ç•Œ</strong>é˜»å¡é˜Ÿåˆ—ï¼Œæ­¤é˜Ÿåˆ—æŒ‰FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åº</li><li><code>LinkedBlockingQueue</code>ï¼šä¸€ä¸ªåŸºäºé“¾è¡¨ç»“æ„çš„<strong>é»˜è®¤æ— ç•Œ</strong>çš„ï¼ˆå¯é€‰æœ‰ç•Œï¼‰é˜»å¡é˜Ÿåˆ—ï¼Œæ­¤é˜Ÿåˆ—æŒ‰FIFOæ’åºå…ƒç´ ï¼Œ<strong>ååé‡é€šå¸¸è¦é«˜äºArrayBlockingQueue</strong>ã€‚é™æ€å·¥å‚æ–¹æ³•Executors.newFixedThreadPool()ä½¿ç”¨äº†è¿™ä¸ªé˜Ÿåˆ—ã€‚</li><li><code>SynchronousQueue</code>ï¼šä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ã€‚æ¯ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰åˆ°å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ç§»é™¤æ“ä½œï¼Œå¦åˆ™æ’å…¥æ“ä½œä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ï¼Œ<strong>ååé‡é€šå¸¸è¦é«˜äºLinked-BlockingQueue</strong>ï¼Œé™æ€å·¥å‚æ–¹æ³•Executors.newCachedThreadPoolä½¿ç”¨äº†è¿™ä¸ªé˜Ÿåˆ—ã€‚</li><li><code>PriorityBlockingQueue</code>ï¼šä¸€ä¸ªå…·<strong>æœ‰ä¼˜å…ˆçº§çš„æ— é™é˜»å¡é˜Ÿåˆ—</strong>ã€‚</li></ul><blockquote><p>åœ¨Javaçº¿ç¨‹æ± ä¸­ï¼Œä¸åŒçš„é˜»å¡é˜Ÿåˆ—æœ‰ä¸åŒçš„ä½¿ç”¨åœºæ™¯ã€‚ä¾‹å¦‚ï¼Œ</p><ul><li>ArrayBlockingQueueé€‚ç”¨äºä»»åŠ¡é‡æ¯”è¾ƒå°çš„æƒ…å†µï¼Œ</li><li>è€ŒLinkedBlockingQueueé€‚ç”¨äºä»»åŠ¡é‡æ¯”è¾ƒå¤§çš„æƒ…å†µï¼Œå› ä¸ºå®ƒå¯ä»¥è‡ªåŠ¨æ‰©å®¹ã€‚</li><li>SynchronousQueueé€‚ç”¨äºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é€Ÿåº¦ç›¸åŒçš„æƒ…å†µï¼Œ</li><li>è€ŒPriorityBlockingQueueåˆ™é€‚ç”¨äºéœ€è¦å¯¹ä»»åŠ¡è¿›è¡Œä¼˜å…ˆçº§æ’åºçš„æƒ…å†µã€‚</li></ul></blockquote></li></ul><p><code>ThreadPoolExecutor</code>å…¶ä»–å¸¸è§å‚æ•° :</p><ol><li><p><strong><code>keepAliveTime</code></strong>:å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å¤§äº <code>corePoolSize</code> çš„æ—¶å€™ï¼Œå¦‚æœè¿™æ—¶æ²¡æœ‰æ–°çš„ä»»åŠ¡æäº¤ï¼Œçº¿ç¨‹æ± ä¸­ä¸”æ ¸å¿ƒçº¿ç¨‹å¤–çš„çº¿ç¨‹ä¸ä¼šç«‹å³é”€æ¯ï¼Œè€Œæ˜¯ä¼šç­‰å¾…ï¼Œç›´åˆ°ç­‰å¾…çš„æ—¶é—´è¶…è¿‡äº† <code>keepAliveTime</code>æ‰ä¼šè¢«å›æ”¶é”€æ¯ï¼›(<strong>çº¿ç¨‹æ± ä¸­ä¸”æ ¸å¿ƒçº¿ç¨‹å¤–çš„çº¿ç¨‹ç©ºé—²åï¼Œä¿æŒå­˜æ´»çš„æ—¶é—´</strong>)</p></li><li><p><strong><code>unit</code></strong> : <code>keepAliveTime</code> å‚æ•°çš„æ—¶é—´å•ä½ã€‚</p></li><li><p><strong><code>threadFactory</code></strong> :executor åˆ›å»ºæ–°çº¿ç¨‹çš„æ—¶å€™ä¼šç”¨åˆ°ã€‚</p></li><li><p><strong><code>handler</code></strong> :é¥±å’Œ(æ‹’ç»)ç­–ç•¥ã€‚å…³äºé¥±å’Œç­–ç•¥ä¸‹é¢å•ç‹¬ä»‹ç»ä¸€ä¸‹ã€‚<strong><code>ThreadPoolExecutor</code> é¥±å’Œç­–ç•¥å®šä¹‰:</strong></p><p>å¦‚æœå½“å‰åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡è¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°é‡å¹¶ä¸”é˜Ÿåˆ—ä¹Ÿå·²ç»è¢«æ”¾æ»¡äº†ä»»åŠ¡æ—¶ï¼Œ<code>ThreadPoolTaskExecutor</code> å®šä¹‰ä¸€äº›ç­–ç•¥:</p><ul><li><code>ThreadPoolExecutor.AbortPolicy</code> ï¼šæŠ›å‡º <code>RejectedExecutionException</code>æ¥æ‹’ç»æ–°ä»»åŠ¡çš„å¤„ç†ã€‚(<strong>æŠ›å¼‚å¸¸</strong>)</li><li><code>ThreadPoolExecutor.CallerRunsPolicy</code> ï¼š<strong>ç”¨è°ƒç”¨è€…æ‰€åœ¨çº¿ç¨‹æ¥è¿è¡Œä»»åŠ¡(ç›´æ¥æ‰§è¡Œrunæ–¹æ³•ä¸å¯åŠ¨æ–°çº¿ç¨‹)</strong>;è°ƒç”¨æ‰§è¡Œè‡ªå·±çš„çº¿ç¨‹è¿è¡Œä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥åœ¨è°ƒç”¨<code>execute</code>æ–¹æ³•çš„çº¿ç¨‹ä¸­è¿è¡Œ(<code>run</code>)è¢«æ‹’ç»çš„ä»»åŠ¡ï¼Œå¦‚æœæ‰§è¡Œç¨‹åºå·²å…³é—­ï¼Œåˆ™ä¼šä¸¢å¼ƒè¯¥ä»»åŠ¡ã€‚å› æ­¤è¿™ç§ç­–ç•¥ä¼šé™ä½å¯¹äºæ–°ä»»åŠ¡æäº¤é€Ÿåº¦ï¼Œå½±å“ç¨‹åºçš„æ•´ä½“æ€§èƒ½ã€‚å¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºå¯ä»¥æ‰¿å—æ­¤å»¶è¿Ÿå¹¶ä¸”ä½ è¦æ±‚ä»»ä½•ä¸€ä¸ªä»»åŠ¡è¯·æ±‚éƒ½è¦è¢«æ‰§è¡Œçš„è¯ï¼Œä½ å¯ä»¥é€‰æ‹©è¿™ä¸ªç­–ç•¥ã€‚</li><li><code>ThreadPoolExecutor.DiscardPolicy</code> ï¼šä¸å¤„ç†æ–°ä»»åŠ¡ï¼Œç›´æ¥ä¸¢å¼ƒæ‰ã€‚(<strong>ä¸¢å¼ƒæ–°ä»»åŠ¡</strong>)</li><li><code>ThreadPoolExecutor.DiscardOldestPolicy</code> ï¼š æ­¤ç­–ç•¥å°†ä¸¢å¼ƒæœ€æ—©çš„æœªå¤„ç†çš„ä»»åŠ¡è¯·æ±‚ã€‚ï¼ˆ<strong>ä¸¢å¼ƒè€ä»»åŠ¡</strong>ï¼‰</li></ul></li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
     * ç”¨ç»™å®šçš„åˆå§‹å‚æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„ThreadPoolExecutorã€‚
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span><span class="token comment">//çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°é‡</span>
                              <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span><span class="token comment">//çº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°</span>
                              <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span><span class="token comment">//å½“çº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°æ—¶ï¼Œå¤šä½™çš„ç©ºé—²çº¿ç¨‹å­˜æ´»çš„æœ€é•¿æ—¶é—´</span>
                              <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span><span class="token comment">//æ—¶é—´å•ä½</span>
                              <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> workQueue<span class="token punctuation">,</span><span class="token comment">//ä»»åŠ¡é˜Ÿåˆ—ï¼Œç”¨æ¥å‚¨å­˜ç­‰å¾…æ‰§è¡Œä»»åŠ¡çš„é˜Ÿåˆ—</span>
                              <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">,</span><span class="token comment">//çº¿ç¨‹å·¥å‚ï¼Œç”¨æ¥åˆ›å»ºçº¿ç¨‹ï¼Œä¸€èˆ¬é»˜è®¤å³å¯</span>
                              <span class="token class-name">RejectedExecutionHandler</span> handler<span class="token comment">//æ‹’ç»ç­–ç•¥ï¼Œå½“æäº¤çš„ä»»åŠ¡è¿‡å¤šè€Œä¸èƒ½åŠæ—¶å¤„ç†æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å®šåˆ¶ç­–ç•¥æ¥å¤„ç†ä»»åŠ¡</span>
                               <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>corePoolSize <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>
            maximumPoolSize <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span>
            maximumPoolSize <span class="token operator">&lt;</span> corePoolSize <span class="token operator">||</span>
            keepAliveTime <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>workQueue <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> threadFactory <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> handler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>corePoolSize <span class="token operator">=</span> corePoolSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maximumPoolSize <span class="token operator">=</span> maximumPoolSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>workQueue <span class="token operator">=</span> workQueue<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>keepAliveTime <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>keepAliveTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>threadFactory <span class="token operator">=</span> threadFactory<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>handler <span class="token operator">=</span> handler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230204232022514.png" alt="image-20230204232022514"></p><h4 id="åˆ›å»ºçº¿ç¨‹æ± " tabindex="-1"><a class="header-anchor" href="#åˆ›å»ºçº¿ç¨‹æ± " aria-hidden="true">#</a> åˆ›å»ºçº¿ç¨‹æ± </h4><h5 id="æ–¹å¼ä¸€-é€šè¿‡threadpoolexecutoræ„é€ å‡½æ•°å®ç°-æ¨è" tabindex="-1"><a class="header-anchor" href="#æ–¹å¼ä¸€-é€šè¿‡threadpoolexecutoræ„é€ å‡½æ•°å®ç°-æ¨è" aria-hidden="true">#</a> <strong>æ–¹å¼ä¸€ï¼šé€šè¿‡<code>ThreadPoolExecutor</code>æ„é€ å‡½æ•°å®ç°ï¼ˆæ¨èï¼‰</strong></h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 <span class="token keyword">@author</span> EddieZhang
 @create 2023-02-05 12:36 AM
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolExecutorTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CORE_POOL_SIZE</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span><span class="token comment">//æ ¸å¿ƒçº¿ç¨‹æ•°</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MAX_POOL_SIZE</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token comment">//çº¿ç¨‹æ± ä¸­æœ€å¤§çº¿ç¨‹æ•°</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">QUEUE_CAPACITY</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span><span class="token comment">//é˜»å¡é˜Ÿåˆ—çš„æœ€å¤§å®¹é‡</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Long</span> <span class="token constant">KEEP_ALIVE_TIME</span> <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span><span class="token comment">//çº¿ç¨‹æ± ä¸­éæ ¸å¿ƒç©ºé—²çº¿ç¨‹çš„å­˜æ´»æ—¶é—´</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * (
         *  int corePoolSize,//æ ¸å¿ƒçº¿ç¨‹æ•°
         *  int maximumPoolSize,//çº¿ç¨‹æ± ä¸­æœ€å¤§çº¿ç¨‹æ•°
         *  long keepAliveTime,//çº¿ç¨‹æ± ä¸­éæ ¸å¿ƒç©ºé—²çº¿ç¨‹çš„å­˜æ´»æ—¶é—´
         *  TimeUnit unit,//å­˜æ´»æ—¶é—´å•ä½
         *  BlockingQueue<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Runnable</span><span class="token punctuation">&gt;</span></span> workQueue,//é˜»å¡é˜Ÿåˆ—
         *  ThreadFactory threadFactory,//çº¿ç¨‹å·¥å‚
         *  RejectedExecutionHandler handler//æ‹’æ¥ç­–ç•¥
         *  )
         */</span>
        <span class="token comment">//é€šè¿‡ThreadPoolExecutoræ„é€ å‡½æ•°è‡ªå®šä¹‰å‚æ•°åˆ›å»º</span>
        <span class="token class-name">ThreadPoolExecutor</span> threadPoolExecutor<span class="token punctuation">;</span>
        threadPoolExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
                <span class="token constant">CORE_POOL_SIZE</span><span class="token punctuation">,</span>
                <span class="token constant">MAX_POOL_SIZE</span><span class="token punctuation">,</span>
                <span class="token number">5</span><span class="token punctuation">,</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token constant">QUEUE_CAPACITY</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>CallerRunsPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Runnable</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;è¿™é‡Œæ˜¯é€šè¿‡å®ç°Runnableæ¥å£å¯åŠ¨çš„æ–°çº¿ç¨‹:&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            threadPoolExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//å…³é—­çº¿ç¨‹æ± </span>
        threadPoolExecutor<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//æœªå°†çº¿ç¨‹æ± å…³é—­åˆ™æ­»å¾ªç¯ç›´è‡³çº¿ç¨‹æ± å…³é—­æˆåŠŸ</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>threadPoolExecutor<span class="token punctuation">.</span><span class="token function">isTerminated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Finished all threads&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="æ–¹å¼äºŒ-é€šè¿‡-executor-æ¡†æ¶çš„å·¥å…·ç±»-executors-æ¥å®ç°-æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸‰ç§ç±»å‹çš„-threadpoolexecutor-ä¸æ¨è-å­˜åœ¨èµ„æºè€—å°½çš„é£é™©" tabindex="-1"><a class="header-anchor" href="#æ–¹å¼äºŒ-é€šè¿‡-executor-æ¡†æ¶çš„å·¥å…·ç±»-executors-æ¥å®ç°-æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸‰ç§ç±»å‹çš„-threadpoolexecutor-ä¸æ¨è-å­˜åœ¨èµ„æºè€—å°½çš„é£é™©" aria-hidden="true">#</a> <strong>æ–¹å¼äºŒï¼šé€šè¿‡ <code>Executor</code> æ¡†æ¶çš„å·¥å…·ç±» <code>Executors</code> æ¥å®ç°</strong> æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸‰ç§ç±»å‹çš„ <code>ThreadPoolExecutor</code>ï¼ˆ<strong>ä¸æ¨è</strong>ï¼›å­˜åœ¨èµ„æºè€—å°½çš„é£é™©ï¼‰</h5><h4 id="å‘çº¿ç¨‹æ± ä¸­æäº¤ä»»åŠ¡" tabindex="-1"><a class="header-anchor" href="#å‘çº¿ç¨‹æ± ä¸­æäº¤ä»»åŠ¡" aria-hidden="true">#</a> å‘çº¿ç¨‹æ± ä¸­æäº¤ä»»åŠ¡</h4><p>å¯ä»¥ä½¿ç”¨ä¸¤ä¸ªæ–¹æ³•å‘çº¿ç¨‹æ± æäº¤ä»»åŠ¡ï¼Œåˆ†åˆ«ä¸º<code>execute()</code>å’Œ<code>submit()</code>æ–¹æ³•ã€‚</p><p><code>execute()</code>æ–¹æ³•<strong>ç”¨äºæäº¤ä¸éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡</strong>ï¼Œæ‰€ä»¥<strong>æ— æ³•åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¢«çº¿ç¨‹æ± æ‰§è¡ŒæˆåŠŸ</strong>ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>submit()</code>æ–¹æ³•ç”¨äº<strong>æäº¤éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡</strong>ã€‚çº¿ç¨‹æ± <strong>ä¼šè¿”å›ä¸€ä¸ª<code>future</code>ç±»å‹çš„å¯¹è±¡</strong>ï¼Œé€šè¿‡è¿™ä¸ªfutureå¯¹è±¡å¯ä»¥åˆ¤æ–­ä»»åŠ¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸï¼Œå¹¶ä¸”<strong>å¯ä»¥é€šè¿‡futureçš„get()æ–¹æ³•æ¥è·å–è¿”å›å€¼</strong>ï¼Œ<strong><code>get()</code>æ–¹æ³•ä¼šé˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°ä»»åŠ¡å®Œæˆ</strong>ï¼Œè€Œä½¿ç”¨getï¼ˆlong timeoutï¼ŒTimeUnit unitï¼‰æ–¹æ³•åˆ™ä¼šé˜»å¡å½“å‰çº¿ç¨‹ä¸€æ®µæ—¶é—´åç«‹å³è¿”å›ï¼Œè¿™æ—¶å€™æœ‰å¯èƒ½ä»»åŠ¡æ²¡æœ‰æ‰§è¡Œå®Œã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">submit</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="å…³é—­çº¿ç¨‹æ± " tabindex="-1"><a class="header-anchor" href="#å…³é—­çº¿ç¨‹æ± " aria-hidden="true">#</a> å…³é—­çº¿ç¨‹æ± </h4><p>å¯ä»¥é€šè¿‡è°ƒç”¨çº¿ç¨‹æ± çš„<code>shutdown()</code>æˆ–<code>shutdownNow()</code>æ–¹æ³•æ¥å…³é—­çº¿ç¨‹æ± </p><ul><li><p><strong><code>shutdownï¼ˆï¼‰</code></strong> :å…³é—­çº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ± çš„çŠ¶æ€å˜ä¸º <code>SHUTDOWN</code>ã€‚çº¿ç¨‹æ± ä¸å†æ¥å—æ–°ä»»åŠ¡äº†ï¼Œä½†æ˜¯é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡å¾—æ‰§è¡Œå®Œæ¯•ã€‚</p></li><li><p><strong><code>shutdownNowï¼ˆï¼‰</code></strong> :å…³é—­çº¿ç¨‹æ± ï¼Œçº¿ç¨‹çš„çŠ¶æ€å˜ä¸º <code>STOP</code>ã€‚çº¿ç¨‹æ± ä¼šç»ˆæ­¢å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œå¹¶åœæ­¢å¤„ç†æ’é˜Ÿçš„ä»»åŠ¡å¹¶è¿”å›æ­£åœ¨ç­‰å¾…æ‰§è¡Œçš„ Listã€‚</p></li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> <span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token comment">//çº¿ç¨‹æ± ä¼šç»ˆæ­¢å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œå¹¶åœæ­¢å¤„ç†æ’é˜Ÿçš„ä»»åŠ¡å¹¶è¿”å›æ­£åœ¨ç­‰å¾…æ‰§è¡Œçš„ Listã€‚</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token comment">//çº¿ç¨‹æ± ä¸å†æ¥å—æ–°ä»»åŠ¡äº†ï¼Œä½†æ˜¯é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡å¾—æ‰§è¡Œå®Œæ¯•ã€‚</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®ƒä»¬çš„<strong>åŸç†</strong>æ˜¯<strong>éå†çº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹</strong>ï¼Œç„¶å<strong>é€ä¸ªè°ƒç”¨çº¿ç¨‹çš„interruptæ–¹æ³•æ¥ä¸­æ–­çº¿ç¨‹</strong>ï¼Œæ‰€ä»¥<strong>æ— æ³•å“åº”ä¸­æ–­çš„ä»»åŠ¡å¯èƒ½æ°¸è¿œæ— æ³•ç»ˆæ­¢</strong>ã€‚</p><p>åªè¦è°ƒç”¨äº†è¿™ä¸¤ä¸ªå…³é—­æ–¹æ³•ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œ<code>isShutdown()</code>æ–¹æ³•å°±ä¼š<strong>è¿”å›true</strong>ã€‚</p><p>å½“<strong>æ‰€æœ‰çš„ä»»åŠ¡éƒ½å·²å…³é—­å</strong>ï¼Œæ‰è¡¨ç¤º<strong>çº¿ç¨‹æ± å…³é—­æˆåŠŸ</strong>ï¼Œè¿™æ—¶è°ƒç”¨<code>isTerminaed()</code>æ–¹æ³•ä¼š<strong>è¿”å›true</strong>ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>		<span class="token comment">//å…³é—­çº¿ç¨‹æ± </span>
        threadPoolExecutor<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//æœªå°†çº¿ç¨‹æ± å…³é—­åˆ™æ­»å¾ªç¯ç›´è‡³çº¿ç¨‹æ± å…³é—­æˆåŠŸ</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>threadPoolExecutor<span class="token punctuation">.</span><span class="token function">isTerminated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Finished all threads&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å‡ ç§å¸¸è§çš„çº¿ç¨‹æ± " tabindex="-1"><a class="header-anchor" href="#å‡ ç§å¸¸è§çš„çº¿ç¨‹æ± " aria-hidden="true">#</a> å‡ ç§å¸¸è§çš„çº¿ç¨‹æ± </h4><h5 id="fixedthreadpool" tabindex="-1"><a class="header-anchor" href="#fixedthreadpool" aria-hidden="true">#</a> FixedThreadPool</h5><p><code>FixedThreadPool</code> è¢«ç§°ä¸º<strong>å¯é‡ç”¨å›ºå®šçº¿ç¨‹æ•°</strong>çš„çº¿ç¨‹æ± ã€‚</p><p>æºç å¯ä»¥çœ‹å‡ºæ–°åˆ›å»ºçš„ <code>FixedThreadPool</code> çš„ <code>corePoolSize</code> å’Œ <code>maximumPoolSize</code> éƒ½è¢«è®¾ç½®ä¸º <strong>nThreads</strong>ï¼Œè¿™ä¸ª nThreads å‚æ•°æ˜¯æˆ‘ä»¬ä½¿ç”¨çš„æ—¶å€™è‡ªå·±ä¼ é€’çš„ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>	<span class="token doc-comment comment">/**
     * åˆ›å»ºä¸€ä¸ªå¯é‡ç”¨å›ºå®šæ•°é‡çº¿ç¨‹çš„çº¿ç¨‹æ± 
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token keyword">int</span> nThreads<span class="token punctuation">,</span> <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>nThreads<span class="token punctuation">,</span> nThreads<span class="token punctuation">,</span>
                                      <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">,</span>
                                      <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                      threadFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°å°äº corePoolSizeï¼Œ å¦‚æœå†æ¥æ–°ä»»åŠ¡çš„è¯ï¼Œå°±åˆ›å»ºæ–°çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼›</p></li><li><p>å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°ç­‰äº corePoolSize åï¼Œ å¦‚æœå†æ¥æ–°ä»»åŠ¡çš„è¯ï¼Œä¼šå°†ä»»åŠ¡åŠ å…¥ <code>LinkedBlockingQueue</code>ï¼›</p></li><li><p>çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ‰§è¡Œå®Œ æ‰‹å¤´çš„ä»»åŠ¡åï¼Œä¼šåœ¨å¾ªç¯ä¸­åå¤ä» <code>LinkedBlockingQueue</code> ä¸­è·å–ä»»åŠ¡æ¥æ‰§è¡Œï¼›</p></li></ul><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230205144649029.png" alt="image-20230205144649029"></p><p><strong>ä¸ºä»€ä¹ˆä¸æ¨èä½¿ç”¨<code>FixedThreadPool</code>ï¼Ÿ</strong></p><p><strong><code>FixedThreadPool</code> ä½¿ç”¨æ— ç•Œé˜Ÿåˆ— <code>LinkedBlockingQueue</code>ï¼ˆé˜Ÿåˆ—çš„å®¹é‡ä¸º Integer.MAX_VALUEï¼‰ä½œä¸ºçº¿ç¨‹æ± çš„å·¥ä½œé˜Ÿåˆ—ä¼šå¯¹çº¿ç¨‹æ± å¸¦æ¥å¦‚ä¸‹å½±å“ ï¼š</strong></p><ol><li>å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°è¾¾åˆ° <code>corePoolSize</code> åï¼Œæ–°ä»»åŠ¡å°†åœ¨æ— ç•Œé˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œå› æ­¤çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸ä¼šè¶…è¿‡ corePoolSizeï¼›</li><li>ç”±äºä½¿ç”¨æ— ç•Œé˜Ÿåˆ—æ—¶ <code>maximumPoolSize</code> å°†æ˜¯ä¸€ä¸ªæ— æ•ˆå‚æ•°ï¼Œå› ä¸ºä¸å¯èƒ½å­˜åœ¨ä»»åŠ¡é˜Ÿåˆ—æ»¡çš„æƒ…å†µã€‚æ‰€ä»¥ï¼Œé€šè¿‡åˆ›å»º <code>FixedThreadPool</code>çš„æºç å¯ä»¥çœ‹å‡ºåˆ›å»ºçš„ <code>FixedThreadPool</code> çš„ <code>corePoolSize</code> å’Œ <code>maximumPoolSize</code> è¢«è®¾ç½®ä¸ºåŒä¸€ä¸ªå€¼ã€‚</li><li>ç”±äº 1 å’Œ 2ï¼Œä½¿ç”¨æ— ç•Œé˜Ÿåˆ—æ—¶ <code>keepAliveTime</code> å°†æ˜¯ä¸€ä¸ªæ— æ•ˆå‚æ•°ï¼›</li><li>è¿è¡Œä¸­çš„ <code>FixedThreadPool</code>ï¼ˆæœªæ‰§è¡Œ <code>shutdown()</code>æˆ– <code>shutdownNow()</code>ï¼‰ä¸ä¼šæ‹’ç»ä»»åŠ¡ï¼Œåœ¨ä»»åŠ¡æ¯”è¾ƒå¤šçš„æ—¶å€™<strong>ä¼šå¯¼è‡´ OOMï¼ˆå†…å­˜æº¢å‡ºï¼‰</strong>ã€‚</li></ol><h5 id="singlethreadexecutor" tabindex="-1"><a class="header-anchor" href="#singlethreadexecutor" aria-hidden="true">#</a> SingleThreadExecutor</h5><p><code>SingleThreadExecutor</code> æ˜¯<strong>åªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± </strong></p><p>æºä»£ç å¯ä»¥çœ‹å‡ºæ–°åˆ›å»ºçš„ <code>SingleThreadExecutor</code> çš„ <code>corePoolSize</code> å’Œ <code>maximumPoolSize</code> <strong>éƒ½è¢«è®¾ç½®ä¸º 1</strong>.å…¶ä»–å‚æ•°å’Œ <code>FixedThreadPool</code> ç›¸åŒ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>	<span class="token doc-comment comment">/**
     *è¿”å›åªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± 
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FinalizableDelegatedExecutorService</span>
            <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
                                    <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">,</span>
                                    <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    threadFactory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°å°‘äº <code>corePoolSize</code>ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼›</p></li><li><p>å½“å‰çº¿ç¨‹æ± ä¸­æœ‰ä¸€ä¸ªè¿è¡Œçš„çº¿ç¨‹åï¼Œå°†ä»»åŠ¡åŠ å…¥ <code>LinkedBlockingQueue</code></p></li><li><p>çº¿ç¨‹æ‰§è¡Œå®Œå½“å‰çš„ä»»åŠ¡åï¼Œä¼šåœ¨å¾ªç¯ä¸­åå¤ä»<code>LinkedBlockingQueue</code> ä¸­è·å–ä»»åŠ¡æ¥æ‰§è¡Œ</p></li></ul><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230205144906373.png" alt="image-20230205144906373"></p><p><strong>ä¸ºä»€ä¹ˆä¸æ¨èä½¿ç”¨<code>SingleThreadExecutor</code>ï¼Ÿ</strong></p><p><code>SingleThreadExecutor</code> <strong>ä½¿ç”¨æ— ç•Œé˜Ÿåˆ—</strong> <code>LinkedBlockingQueue</code> ä½œä¸ºçº¿ç¨‹æ± çš„å·¥ä½œé˜Ÿåˆ—ï¼ˆé˜Ÿåˆ—çš„å®¹é‡ä¸º Intger.MAX_VALUEï¼‰ã€‚<code>SingleThreadExecutor</code> ä½¿ç”¨æ— ç•Œé˜Ÿåˆ—ä½œä¸ºçº¿ç¨‹æ± çš„å·¥ä½œé˜Ÿåˆ—ä¼šå¯¹çº¿ç¨‹æ± å¸¦æ¥çš„å½±å“ä¸ <code>FixedThreadPool</code> ç›¸åŒã€‚è¯´ç®€å•ç‚¹å°±æ˜¯<strong>å¯èƒ½ä¼šå¯¼è‡´ OOM</strong>ï¼Œ</p><h5 id="cachedthreadpool" tabindex="-1"><a class="header-anchor" href="#cachedthreadpool" aria-hidden="true">#</a> CachedThreadPool</h5><p><code>CachedThreadPool</code> æ˜¯ä¸€ä¸ªä¼šæ ¹<strong>æ®éœ€è¦åˆ›å»ºæ–°çº¿ç¨‹</strong>çš„çº¿ç¨‹æ± </p><p><code>CachedThreadPool</code> çš„<code>corePoolSize</code> è¢«è®¾ç½®ä¸ºç©ºï¼ˆ0ï¼‰ï¼Œ<code>maximumPoolSize</code>è¢«è®¾ç½®ä¸º <code>Integer.MAX.VALUE</code>ï¼Œå³<strong>æœ€å¤§çº¿ç¨‹æ•°æ˜¯æ— ç•Œ</strong>çš„ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€å¦‚æœä¸»çº¿ç¨‹æäº¤ä»»åŠ¡çš„é€Ÿåº¦é«˜äº <code>maximumPool</code> ä¸­çº¿ç¨‹å¤„ç†ä»»åŠ¡çš„é€Ÿåº¦æ—¶ï¼Œ<code>CachedThreadPool</code> ä¼šä¸æ–­åˆ›å»ºæ–°çš„çº¿ç¨‹ã€‚æç«¯æƒ…å†µä¸‹ï¼Œè¿™æ ·ä¼šå¯¼è‡´è€—å°½ cpu å’Œå†…å­˜èµ„æº</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>	<span class="token doc-comment comment">/**
     * åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œæ ¹æ®éœ€è¦åˆ›å»ºæ–°çº¿ç¨‹ï¼Œä½†ä¼šåœ¨å…ˆå‰æ„å»ºçš„çº¿ç¨‹å¯ç”¨æ—¶é‡ç”¨å®ƒã€‚
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">,</span>
                                      <span class="token number">60L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span>
                                      <span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                      threadFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>é¦–å…ˆæ‰§è¡Œ <code>SynchronousQueue.offer(Runnable task)</code> æäº¤ä»»åŠ¡åˆ°ä»»åŠ¡é˜Ÿåˆ—ã€‚å¦‚æœå½“å‰ <code>maximumPool</code> ä¸­æœ‰é—²çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ <code>SynchronousQueue.poll(keepAliveTime,TimeUnit.NANOSECONDS)</code>ï¼Œé‚£ä¹ˆä¸»çº¿ç¨‹æ‰§è¡Œ offer æ“ä½œä¸ç©ºé—²çº¿ç¨‹æ‰§è¡Œçš„ <code>poll</code> æ“ä½œé…å¯¹æˆåŠŸï¼Œä¸»çº¿ç¨‹æŠŠä»»åŠ¡äº¤ç»™ç©ºé—²çº¿ç¨‹æ‰§è¡Œï¼Œ<code>execute()</code>æ–¹æ³•æ‰§è¡Œå®Œæˆï¼Œå¦åˆ™æ‰§è¡Œä¸‹é¢çš„æ­¥éª¤ 2ï¼›</li><li>å½“åˆå§‹ <code>maximumPool</code> ä¸ºç©ºï¼Œæˆ–è€… <code>maximumPool</code> ä¸­æ²¡æœ‰ç©ºé—²çº¿ç¨‹æ—¶ï¼Œå°†æ²¡æœ‰çº¿ç¨‹æ‰§è¡Œ <code>SynchronousQueue.poll(keepAliveTime,TimeUnit.NANOSECONDS)</code>ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæ­¥éª¤ 1 å°†å¤±è´¥ï¼Œæ­¤æ—¶ <code>CachedThreadPool</code> ä¼šåˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œexecute æ–¹æ³•æ‰§è¡Œå®Œæˆï¼›</li></ol><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230205145227932.png" alt="image-20230205145227932"></p><p><strong>ä¸ºä»€ä¹ˆä¸æ¨èä½¿ç”¨<code>CachedThreadPool</code>ï¼Ÿ</strong></p><p><code>CachedThreadPool</code>å…è®¸åˆ›å»ºçš„çº¿ç¨‹æ•°é‡ä¸º <code>Integer.MAX_VALUE</code> ï¼Œ<strong>å¯èƒ½ä¼šåˆ›å»ºå¤§é‡çº¿ç¨‹</strong>ï¼Œä»è€Œ<strong>å¯¼è‡´ OOM</strong></p><h5 id="scheduledthreadpoolexecutor" tabindex="-1"><a class="header-anchor" href="#scheduledthreadpoolexecutor" aria-hidden="true">#</a> ScheduledThreadPoolExecutor</h5><p><strong><code>ScheduledThreadPoolExecutor</code> ä¸»è¦ç”¨æ¥åœ¨ç»™å®šçš„å»¶è¿Ÿåè¿è¡Œä»»åŠ¡ï¼Œæˆ–è€…å®šæœŸæ‰§è¡Œä»»åŠ¡ã€‚</strong> è¿™ä¸ªåœ¨å®é™…é¡¹ç›®ä¸­åŸºæœ¬ä¸ä¼šè¢«ç”¨åˆ°ï¼Œ<strong>ä¹Ÿä¸æ¨èä½¿ç”¨</strong>ï¼Œå¤§å®¶åªéœ€è¦ç®€å•äº†è§£ä¸€ä¸‹å®ƒçš„æ€æƒ³å³å¯</p><h4 id="åˆç†åœ°é…ç½®çº¿ç¨‹æ± " tabindex="-1"><a class="header-anchor" href="#åˆç†åœ°é…ç½®çº¿ç¨‹æ± " aria-hidden="true">#</a> åˆç†åœ°é…ç½®çº¿ç¨‹æ± </h4><p>è¦æƒ³åˆç†åœ°é…ç½®çº¿ç¨‹æ± ï¼Œå°±å¿…é¡»é¦–å…ˆåˆ†æä»»åŠ¡ç‰¹æ€§ï¼Œå¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªè§’åº¦æ¥åˆ†æã€‚</p><ul><li>ä»»åŠ¡çš„æ€§è´¨ï¼š<strong>CPUå¯†é›†å‹ä»»åŠ¡</strong>ã€<strong>IOå¯†é›†å‹ä»»åŠ¡</strong>å’Œæ··åˆå‹ä»»åŠ¡ã€‚</li><li>ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼šé«˜ã€ä¸­å’Œä½ã€‚</li><li>ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ï¼šé•¿ã€ä¸­å’ŒçŸ­ã€‚</li><li>ä»»åŠ¡çš„ä¾èµ–æ€§ï¼šæ˜¯å¦ä¾èµ–å…¶ä»–ç³»ç»Ÿèµ„æºï¼Œå¦‚æ•°æ®åº“è¿æ¥ã€‚</li></ul><p>æœ‰ä¸€ä¸ªç®€å•å¹¶ä¸”é€‚ç”¨é¢æ¯”è¾ƒå¹¿çš„<strong>ç»éªŒä¹‹è°ˆ</strong>ï¼š</p><ul><li><strong>CPU å¯†é›†å‹ä»»åŠ¡(N+1)ï¼š</strong> è¿™ç§ä»»åŠ¡æ¶ˆè€—çš„ä¸»è¦æ˜¯ CPU èµ„æºï¼Œå¯ä»¥å°†çº¿ç¨‹æ•°è®¾ç½®ä¸º Nï¼ˆCPU æ ¸å¿ƒæ•°ï¼‰+1ï¼Œæ¯” CPU æ ¸å¿ƒæ•°å¤šå‡ºæ¥çš„ä¸€ä¸ªçº¿ç¨‹æ˜¯ä¸ºäº†é˜²æ­¢çº¿ç¨‹å¶å‘çš„ç¼ºé¡µä¸­æ–­ï¼Œæˆ–è€…å…¶å®ƒåŸå› å¯¼è‡´çš„ä»»åŠ¡æš‚åœè€Œå¸¦æ¥çš„å½±å“ã€‚ä¸€æ—¦ä»»åŠ¡æš‚åœï¼ŒCPU å°±ä¼šå¤„äºç©ºé—²çŠ¶æ€ï¼Œè€Œåœ¨è¿™ç§æƒ…å†µä¸‹å¤šå‡ºæ¥çš„ä¸€ä¸ªçº¿ç¨‹å°±å¯ä»¥å……åˆ†åˆ©ç”¨ CPU çš„ç©ºé—²æ—¶é—´ã€‚</li><li><strong>I/O å¯†é›†å‹ä»»åŠ¡(2N)ï¼š</strong> è¿™ç§ä»»åŠ¡åº”ç”¨èµ·æ¥ï¼Œç³»ç»Ÿä¼šç”¨å¤§éƒ¨åˆ†çš„æ—¶é—´æ¥å¤„ç† I/O äº¤äº’ï¼Œè€Œçº¿ç¨‹åœ¨å¤„ç† I/O çš„æ—¶é—´æ®µå†…ä¸ä¼šå ç”¨ CPU æ¥å¤„ç†ï¼Œè¿™æ—¶å°±å¯ä»¥å°† CPU äº¤å‡ºç»™å…¶å®ƒçº¿ç¨‹ä½¿ç”¨ã€‚å› æ­¤åœ¨ I/O å¯†é›†å‹ä»»åŠ¡çš„åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¤šé…ç½®ä¸€äº›çº¿ç¨‹ï¼Œå…·ä½“çš„è®¡ç®—æ–¹æ³•æ˜¯ 2Nã€‚</li></ul><p><strong>å¦‚ä½•åˆ¤æ–­æ˜¯ CPU å¯†é›†ä»»åŠ¡è¿˜æ˜¯ IO å¯†é›†ä»»åŠ¡ï¼Ÿ</strong></p><p>CPU å¯†é›†å‹ç®€å•ç†è§£å°±æ˜¯åˆ©ç”¨ CPU è®¡ç®—èƒ½åŠ›çš„ä»»åŠ¡æ¯”å¦‚ä½ åœ¨å†…å­˜ä¸­å¯¹å¤§é‡æ•°æ®è¿›è¡Œæ’åºã€‚ä½†å‡¡æ¶‰åŠåˆ°ç½‘ç»œè¯»å–ï¼Œæ–‡ä»¶è¯»å–è¿™ç±»éƒ½æ˜¯ IO å¯†é›†å‹ï¼Œè¿™ç±»ä»»åŠ¡çš„ç‰¹ç‚¹æ˜¯ CPU è®¡ç®—è€—è´¹æ—¶é—´ç›¸æ¯”äºç­‰å¾… IO æ“ä½œå®Œæˆçš„æ—¶é—´æ¥è¯´å¾ˆå°‘ï¼Œå¤§éƒ¨åˆ†æ—¶é—´éƒ½èŠ±åœ¨äº†ç­‰å¾… IO æ“ä½œå®Œæˆä¸Šã€‚</p><h4 id="çº¿ç¨‹æ± çš„ç›‘æ§" tabindex="-1"><a class="header-anchor" href="#çº¿ç¨‹æ± çš„ç›‘æ§" aria-hidden="true">#</a> çº¿ç¨‹æ± çš„ç›‘æ§</h4><p>ç›‘æ§çº¿ç¨‹æ± çš„æ—¶å€™å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å±æ€§ã€‚</p><ul><li><code>taskCount</code>ï¼šçº¿ç¨‹æ± éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡æ•°é‡ã€‚</li><li><code>completedTaskCount</code>ï¼šçº¿ç¨‹æ± åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å·²å®Œæˆçš„ä»»åŠ¡æ•°é‡ï¼Œå°äºæˆ–ç­‰äºtaskCountã€‚</li><li><code>largestPoolSize</code>ï¼šçº¿ç¨‹æ± é‡Œæ›¾ç»åˆ›å»ºè¿‡çš„æœ€å¤§çº¿ç¨‹æ•°é‡ã€‚é€šè¿‡è¿™ä¸ªæ•°æ®å¯ä»¥çŸ¥é“çº¿ç¨‹æ± æ˜¯å¦æ›¾ç»æ»¡è¿‡ã€‚å¦‚è¯¥æ•°å€¼ç­‰äºçº¿ç¨‹æ± çš„æœ€å¤§å¤§å°ï¼Œåˆ™è¡¨ç¤ºçº¿ç¨‹æ± æ›¾ç»æ»¡è¿‡ã€‚</li><li><code>getPoolSize</code>ï¼šçº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡ã€‚å¦‚æœçº¿ç¨‹æ± ä¸é”€æ¯çš„è¯ï¼Œçº¿ç¨‹æ± é‡Œçš„çº¿ç¨‹ä¸ä¼šè‡ªåŠ¨é”€æ¯ï¼Œæ‰€ä»¥è¿™ä¸ªå¤§å°åªå¢ä¸å‡ã€‚</li><li><code>getActiveCount</code>ï¼šè·å–æ´»åŠ¨çš„çº¿ç¨‹æ•°ã€‚</li></ul><p>é€šè¿‡æ‰©å±•çº¿ç¨‹æ± è¿›è¡Œç›‘æ§ã€‚å¯ä»¥é€šè¿‡<strong>ç»§æ‰¿çº¿ç¨‹æ± æ¥è‡ªå®šä¹‰çº¿ç¨‹æ± </strong>ï¼Œ<strong>é‡å†™çº¿ç¨‹æ± </strong>çš„<code>beforeExecute</code>ã€<code>afterExecute</code>å’Œ<code>terminated</code>æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥åœ¨ä»»åŠ¡æ‰§è¡Œå‰ã€æ‰§è¡Œåå’Œçº¿ç¨‹æ± å…³é—­å‰æ‰§è¡Œä¸€äº›ä»£ç æ¥è¿›è¡Œç›‘æ§ã€‚ä¾‹å¦‚ï¼Œç›‘æ§ä»»åŠ¡çš„å¹³å‡æ‰§è¡Œæ—¶é—´ã€æœ€å¤§æ‰§è¡Œæ—¶é—´å’Œæœ€å°æ‰§è¡Œæ—¶é—´ç­‰ã€‚è¿™å‡ ä¸ªæ–¹æ³•åœ¨çº¿ç¨‹æ± é‡Œæ˜¯ç©ºæ–¹æ³•ã€‚</p><h3 id="completablefutureå¼‚æ­¥ç¼–ç¨‹" tabindex="-1"><a class="header-anchor" href="#completablefutureå¼‚æ­¥ç¼–ç¨‹" aria-hidden="true">#</a> CompletableFutureå¼‚æ­¥ç¼–ç¨‹</h3><p>Java 8 æ‰è¢«å¼•å…¥çš„ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„ç”¨äº<strong>å¼‚æ­¥ç¼–ç¨‹çš„ç±»</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">CompletionStage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>Futureæ¥å£</strong></p><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230204223419774.png" alt="image-20230204223419774"></p><ul><li><p>boolean <code>cancel(boolean mayInterruptIfRunning)</code> ï¼šå°è¯•å–æ¶ˆæ‰§è¡Œä»»åŠ¡ã€‚</p></li><li><p>boolean <code>isCancelled()</code> ï¼šåˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆã€‚</p></li><li><p>boolean <code>isDone()</code> ï¼š åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å·²ç»è¢«æ‰§è¡Œå®Œæˆã€‚</p></li><li><p><code>get()</code> ï¼šç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆå¹¶è·å–è¿ç®—ç»“æœã€‚ä¼šé˜»å¡ä¸»çº¿ç¨‹</p></li><li><p><code>get(long timeout, TimeUnit unit)</code> ï¼šå¤šäº†ä¸€ä¸ªè¶…æ—¶æ—¶é—´ã€‚</p></li></ul><p><strong>CompletionStageæ¥å£</strong></p><p><img src="https://eddie-typora-image.oss-cn-shenzhen.aliyuncs.com/typora-user-images/image-20230204223644600.png" alt="image-20230204223644600"></p><p><code>CompletionStage&lt;T&gt;</code> æ¥å£ä¸­çš„æ–¹æ³•æ¯”è¾ƒå¤šï¼Œ<code>CompletableFuture</code> çš„å‡½æ•°å¼èƒ½åŠ›å°±æ˜¯è¿™ä¸ªæ¥å£èµ‹äºˆçš„ã€‚</p><p><strong>å¤§é‡ä½¿ç”¨äº† Java8 å¼•å…¥çš„å‡½æ•°å¼ç¼–ç¨‹</strong></p><h4 id="åˆ›å»º-completablefuture" tabindex="-1"><a class="header-anchor" href="#åˆ›å»º-completablefuture" aria-hidden="true">#</a> åˆ›å»º CompletableFuture</h4><h5 id="ä¸€-é€šè¿‡-new-å…³é”®å­—ã€‚" tabindex="-1"><a class="header-anchor" href="#ä¸€-é€šè¿‡-new-å…³é”®å­—ã€‚" aria-hidden="true">#</a> <strong>ä¸€ï¼Œé€šè¿‡ new å…³é”®å­—ã€‚</strong></h5><p>é€šè¿‡ new å…³é”®å­—åˆ›å»º <code>CompletableFuture</code> å¯¹è±¡è¿™ç§ä½¿ç”¨æ–¹å¼å¯ä»¥çœ‹ä½œæ˜¯å°† <code>CompletableFuture</code> å½“åš <code>Future</code> æ¥ä½¿ç”¨ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">CompletableFuture</span> completableFuture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h5 id="äºŒ-é™æ€å·¥å‚æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#äºŒ-é™æ€å·¥å‚æ–¹æ³•" aria-hidden="true">#</a> <strong>äºŒï¼Œ</strong> é™æ€å·¥å‚æ–¹æ³•</h5><p><strong>åŸºäº <code>CompletableFuture</code> è‡ªå¸¦çš„é™æ€å·¥å‚æ–¹æ³•ï¼š<code>runAsync()</code> ã€<code>supplyAsync()</code> ã€‚</strong></p><h6 id="runasync-æ— è¿”å›ç»“æœ" tabindex="-1"><a class="header-anchor" href="#runasync-æ— è¿”å›ç»“æœ" aria-hidden="true">#</a> <code>runAsync()</code> æ— è¿”å›ç»“æœ</h6><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> runnable<span class="token punctuation">,</span>
                                                   <span class="token class-name">Executor</span> executor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">asyncRunStage</span><span class="token punctuation">(</span><span class="token function">screenExecutor</span><span class="token punctuation">(</span>executor<span class="token punctuation">)</span><span class="token punctuation">,</span> runnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æŒ‡å®šçº¿ç¨‹æ± </span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;è¿™é‡Œæ˜¯é€šè¿‡CompletableFutureçš„é™æ€æ–¹æ³•runAsyncå¯åŠ¨çš„çº¿ç¨‹:&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>threadPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        threadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>threadPool<span class="token punctuation">.</span><span class="token function">isTerminated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment">//å¾ªç¯ç­‰å¾…ç›´åˆ°çº¿ç¨‹æ± å…³é—­å®Œæˆ</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Finished all threads&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="supplyasync-æœ‰è¿”å›ç»“æœ" tabindex="-1"><a class="header-anchor" href="#supplyasync-æœ‰è¿”å›ç»“æœ" aria-hidden="true">#</a> <code>supplyAsync()</code> æœ‰è¿”å›ç»“æœ</h6><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> <span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> supplier<span class="token punctuation">,</span>
                                                       <span class="token class-name">Executor</span> executor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> <span class="token function">asyncSupplyStage</span><span class="token punctuation">(</span><span class="token function">screenExecutor</span><span class="token punctuation">(</span>executor<span class="token punctuation">)</span><span class="token punctuation">,</span> supplier<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span><span class="token comment">//æœ‰è¿”å›å€¼çš„</span>

    <span class="token doc-comment comment">/**
     * Gets a result.
     *
     * <span class="token keyword">@return</span> a result
     */</span>
    <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æŒ‡å®šçº¿ç¨‹æ± </span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> supplyAsync <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">;</span><span class="token comment">//æœ‰è¿”å›å€¼</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> threadPool<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> result <span class="token operator">=</span> supplyAsync<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–çº¿ç¨‹æ‰§è¡Œåçš„è¿”å›å€¼</span>

        <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>threadPool<span class="token punctuation">)</span><span class="token punctuation">;</span>

        threadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>threadPool<span class="token punctuation">.</span><span class="token function">isTerminated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment">//å¾ªç¯ç­‰å¾…æŒ‡å¯¼çº¿ç¨‹æ± å…³é—­å®Œæˆ</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Finished all threads&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å¤„ç†å¼‚æ­¥ç»“ç®—çš„ç»“æœ" tabindex="-1"><a class="header-anchor" href="#å¤„ç†å¼‚æ­¥ç»“ç®—çš„ç»“æœ" aria-hidden="true">#</a> å¤„ç†å¼‚æ­¥ç»“ç®—çš„ç»“æœ</h4><ul><li><code>thenApply()</code>è¿›ä¸€æ­¥å¤„ç†å¼‚æ­¥å®Œæˆåçš„ç»“æœå¹¶è¿”å›å¤„ç†ç»“æœ</li><li><code>thenAccept()</code>è¿›ä¸€æ­¥å¤„ç†å¼‚æ­¥å®Œæˆåçš„ç»“æœ æ— è¿”å›ç»“æœ</li><li><code>thenRun()</code>è¿›ä¸€æ­¥æ“ä½œ æ— æ³•è·å–å¼‚æ­¥å®Œæˆåçš„ç»“æœ æ— è¿”å›ç»“æœ</li><li><code>whenComplete()</code>è¿›ä¸€æ­¥å¤„ç†å¼‚æ­¥å®Œæˆåçš„ç»“æœ æ— æ³•å¤„ç†ç»“æœæ•°æ®èƒ½å¤Ÿæ„ŸçŸ¥å¼‚å¸¸ï¼ˆ<code>exceptionally()</code>å¯ä»¥æ„ŸçŸ¥åˆ°å¼‚å¸¸å¹¶å¯¹å¼‚å¸¸è¿›è¡Œå¤„ç†ã€å½“å‡ºç°å¼‚å¸¸è®¾ç½®é»˜è®¤è¿”å›å€¼ã€‘ï¼‰å¹¶è¿”å›å¤„ç†ç»“æœ</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">-</span> `<span class="token function">thenApply</span><span class="token punctuation">(</span><span class="token punctuation">)</span>`è¿›ä¸€æ­¥å¤„ç†å¼‚æ­¥å®Œæˆåçš„ç»“æœå¹¶è¿”å›å¤„ç†ç»“æœ
<span class="token operator">-</span> `<span class="token function">thenAccept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>`è¿›ä¸€æ­¥å¤„ç†å¼‚æ­¥å®Œæˆåçš„ç»“æœ æ— è¿”å›ç»“æœ
<span class="token operator">-</span> `<span class="token function">thenRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span>`è¿›ä¸€æ­¥æ“ä½œ æ— æ³•è·å–å¼‚æ­¥å®Œæˆåçš„ç»“æœ æ— è¿”å›ç»“æœ
    
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æŒ‡å®šçº¿ç¨‹æ± </span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> supplyAsync <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">&quot;Hello &quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> threadPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
        supplyAsync<span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span><span class="token keyword">return</span> result <span class="token operator">+</span> <span class="token string">&quot;World&quot;</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment">//è¿›ä¸€æ­¥å¤„ç†å¼‚æ­¥å®Œæˆåçš„ç»“æœå¹¶è¿”å›å¤„ç†ç»“æœ</span>
                <span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span><span class="token keyword">return</span> result <span class="token operator">+</span> <span class="token string">&quot;--Eddie&quot;</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment">//è¿›ä¸€æ­¥å¤„ç†å¼‚æ­¥å®Œæˆåçš„ç»“æœå¹¶è¿”å›å¤„ç†ç»“æœ</span>
                
                <span class="token punctuation">.</span><span class="token function">thenAccept</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token comment">//è¿›ä¸€æ­¥å¤„ç†å¼‚æ­¥å®Œæˆåçš„ç»“æœ æ— è¿”å›ç»“æœ</span>
                
                <span class="token punctuation">.</span><span class="token function">thenRun</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span><span class="token comment">//è¿›ä¸€æ­¥æ“ä½œ æ— æ³•è·å–å¼‚æ­¥å®Œæˆåçš„ç»“æœ æ— è¿”å›ç»“æœ</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æˆ‘æ„ŸçŸ¥ä¸åˆ°å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œçš„ä»»ä½•ç»“æœ&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        threadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>threadPool<span class="token punctuation">.</span><span class="token function">isTerminated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment">//å¾ªç¯ç­‰å¾…ç›´åˆ°çº¿ç¨‹æ± å…³é—­å®Œæˆ</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Finished all threads&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">-</span> `<span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>`è¿›ä¸€æ­¥å¤„ç†å¼‚æ­¥å®Œæˆåçš„ç»“æœ
æ— æ³•å¤„ç†ç»“æœæ•°æ®èƒ½å¤Ÿæ„ŸçŸ¥å¼‚å¸¸ï¼ˆ`<span class="token function">exceptionally</span><span class="token punctuation">(</span><span class="token punctuation">)</span>`å¯ä»¥æ„ŸçŸ¥åˆ°å¼‚å¸¸å¹¶å¯¹å¼‚å¸¸è¿›è¡Œå¤„ç†ã€å½“å‡ºç°å¼‚å¸¸è®¾ç½®é»˜è®¤è¿”å›å€¼ã€‘ï¼‰å¹¶è¿”å›å¤„ç†ç»“æœ
    
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æŒ‡å®šçº¿ç¨‹æ± </span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> supplyAsync <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//æ¨¡æ‹Ÿå‡ºç°å¼‚å¸¸</span>
            <span class="token keyword">return</span> <span class="token string">&quot;Hello &quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> threadPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
        supplyAsync<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span>exception<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span><span class="token comment">//å½“å¼‚æ­¥ä»»åŠ¡å®Œæˆå</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ä¸Šä¸€æ­¥å¼‚æ­¥æ‰§è¡Œçš„ç»“æœæ˜¯:&quot;</span> <span class="token operator">+</span> result <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;ä¸Šå¼‚æ­¥å‡ºç°çš„å¼‚å¸¸æ˜¯&quot;</span> <span class="token operator">+</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//ä¸Šä¸€æ­¥å¼‚æ­¥æ‰§è¡Œçš„ç»“æœæ˜¯:null	ä¸Šå¼‚æ­¥å‡ºç°çš„å¼‚å¸¸æ˜¯java.util.concurrent.CompletionException: java.lang.ArithmeticException: / by zero</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exceptionally</span><span class="token punctuation">(</span>throwable <span class="token operator">-&gt;</span> <span class="token punctuation">{</span><span class="token comment">//è‹¥å¼‚æ­¥ä»»åŠ¡å®Œæˆæ—¶å‡ºç°äº†å¼‚å¸¸</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å‡ºç°çš„å¼‚å¸¸æ˜¯&quot;</span> <span class="token operator">+</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//å‡ºç°çš„å¼‚å¸¸æ˜¯java.util.concurrent.CompletionException: java.lang.ArithmeticException: / by zero</span>
            <span class="token keyword">return</span> <span class="token string">&quot;å¦‚æœå‡ºç°å¼‚å¸¸çš„è¯ è¿™é‡Œè¿”å›ä¸€ä¸ªé»˜è®¤å€¼&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenAccept</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¦‚æœå‡ºç°å¼‚å¸¸çš„è¯ è¿™é‡Œè¿”å›ä¸€ä¸ªé»˜è®¤å€¼</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        threadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>threadPool<span class="token punctuation">.</span><span class="token function">isTerminated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment">//å¾ªç¯ç­‰å¾…æŒ‡å¯¼çº¿ç¨‹æ± å…³é—­å®Œæˆ</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Finished all threads&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å¼‚æ­¥çº¿ç¨‹ä¸²è¡ŒåŒ–" tabindex="-1"><a class="header-anchor" href="#å¼‚æ­¥çº¿ç¨‹ä¸²è¡ŒåŒ–" aria-hidden="true">#</a> å¼‚æ­¥çº¿ç¨‹ä¸²è¡ŒåŒ–</h4><ul><li><code>thenRunAsync</code>å¯åŠ¨ä¸€ä¸ªæ–°çš„å¼‚æ­¥çº¿ç¨‹ ä¸²è¡Œä¸Šä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹ æ— æ„ŸçŸ¥ä¸Šä¸ªçº¿ç¨‹çš„ç»“æœ æ— è¿”å›ç»“æœ</li><li><code>thenAcceptAsync</code>å¯åŠ¨ä¸€ä¸ªæ–°çš„å¼‚æ­¥çº¿ç¨‹ ä¸²è¡Œå¹¶å¤„ç†ä¸Šä¸ªå¼‚æ­¥çº¿ç¨‹å®Œæˆåçš„ç»“æœ æ— è¿”å›ç»“æœ</li><li><code>thenApplyAsync</code>å¯åŠ¨ä¸€ä¸ªæ–°çš„å¼‚æ­¥çº¿ç¨‹ ä¸²è¡Œå¹¶å¤„ç†ä¸Šä¸ªå¼‚æ­¥çº¿ç¨‹å®Œæˆåçš„ç»“æœå¹¶è¿”å›å¤„ç†ç»“æœ</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>ä¸€ï¼š`<span class="token function">thenApplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>`å¯åŠ¨ä¸€ä¸ªæ–°çš„å¼‚æ­¥çº¿ç¨‹ ä¸²è¡Œå¹¶å¤„ç†ä¸Šä¸ªå¼‚æ­¥çº¿ç¨‹å®Œæˆåçš„ç»“æœå¹¶è¿”å›å¤„ç†ç»“æœ
<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">CompletionStage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> thenApplyAsync
        <span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">,</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> fn<span class="token punctuation">,</span>
         <span class="token class-name">Executor</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
         
äºŒï¼š`<span class="token function">thenAcceptAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>`å¯åŠ¨ä¸€ä¸ªæ–°çš„å¼‚æ­¥çº¿ç¨‹ ä¸²è¡Œå¹¶å¤„ç†ä¸Šä¸ªå¼‚æ­¥çº¿ç¨‹å®Œæˆåçš„ç»“æœ æ— è¿”å›ç»“æœ
<span class="token keyword">public</span> <span class="token class-name">CompletionStage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">thenAcceptAsync</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> action<span class="token punctuation">,</span>
                                                 <span class="token class-name">Executor</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
ä¸‰ï¼š`<span class="token function">thenRunAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>`å¯åŠ¨ä¸€ä¸ªæ–°çš„å¼‚æ­¥çº¿ç¨‹ ä¸²è¡Œä¸Šä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹ æ— æ„ŸçŸ¥ä¸Šä¸ªçº¿ç¨‹çš„ç»“æœ æ— è¿”å›ç»“æœ
<span class="token keyword">public</span> <span class="token class-name">CompletionStage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">thenRunAsync</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> action<span class="token punctuation">,</span>
                                              <span class="token class-name">Executor</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>                                                 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å¼‚å¸¸å¤„ç†" tabindex="-1"><a class="header-anchor" href="#å¼‚å¸¸å¤„ç†" aria-hidden="true">#</a> å¼‚å¸¸å¤„ç†</h4><ul><li><code>handle()</code>å¤„ç†ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°çš„æŠ›å‡ºå¼‚å¸¸çš„æƒ…å†µ</li><li><code>exceptionally()</code>å¯ä»¥æ„ŸçŸ¥åˆ°å¼‚å¸¸å¹¶å¯¹å¼‚å¸¸è¿›è¡Œå¤„ç†ã€å½“å‡ºç°å¼‚å¸¸è®¾ç½®é»˜è®¤è¿”å›å€¼ã€‘ï¼‰å¹¶è¿”å›å¤„ç†ç»“æœ</li><li><code>completeExceptionally()</code>è®©ç»“æœå°±æ˜¯å¼‚å¸¸</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>ä¸€ï¼š`<span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>`å¤„ç†ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°çš„æŠ›å‡ºå¼‚å¸¸çš„æƒ…å†µ
    å¯ä»¥æ„ŸçŸ¥åˆ°å¼‚å¸¸å¹¶å¯¹å¼‚å¸¸è¿›è¡Œå¤„ç†ã€å½“å‡ºç°å¼‚å¸¸è®¾ç½®é»˜è®¤è¿”å›å€¼ã€‘ï¼‰å¹¶è¿”å›å¤„ç†ç»“æœ
    
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> future
        <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Computation error!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">&quot;hello!&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> ex<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// res ä»£è¡¨è¿”å›çš„ç»“æœ</span>
    <span class="token comment">// ex çš„ç±»å‹ä¸º Throwable ï¼Œä»£è¡¨æŠ›å‡ºçš„å¼‚å¸¸</span>
    <span class="token keyword">return</span> res <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> res <span class="token operator">:</span> <span class="token string">&quot;world!&quot;</span><span class="token punctuation">;</span><span class="token comment">//è‹¥æœªå‡ºç°å¼‚å¸¸åˆ™ è¿”å›æ­£å¸¸è¿”å›ç»“æœ åä¹‹æŒ‡å®šå¼‚å¸¸åè¿”å›çš„é»˜è®¤å€¼</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

äºŒï¼š`<span class="token function">exceptionally</span><span class="token punctuation">(</span><span class="token punctuation">)</span>`å¯ä»¥æ„ŸçŸ¥åˆ°å¼‚å¸¸å¹¶å¯¹å¼‚å¸¸è¿›è¡Œå¤„ç†ã€å½“å‡ºç°å¼‚å¸¸è®¾ç½®é»˜è®¤è¿”å›å€¼ã€‘ï¼‰å¹¶è¿”å›å¤„ç†ç»“æœ
    
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> supplyAsync <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//æ¨¡æ‹Ÿå‡ºç°å¼‚å¸¸</span>
            <span class="token keyword">return</span> <span class="token string">&quot;Hello &quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> threadPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
        supplyAsync<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span>exception<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span><span class="token comment">//å½“å¼‚æ­¥ä»»åŠ¡å®Œæˆå</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ä¸Šä¸€æ­¥å¼‚æ­¥æ‰§è¡Œçš„ç»“æœæ˜¯:&quot;</span> <span class="token operator">+</span> result <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;ä¸Šå¼‚æ­¥å‡ºç°çš„å¼‚å¸¸æ˜¯&quot;</span> <span class="token operator">+</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//ä¸Šä¸€æ­¥å¼‚æ­¥æ‰§è¡Œçš„ç»“æœæ˜¯:null	ä¸Šå¼‚æ­¥å‡ºç°çš„å¼‚å¸¸æ˜¯java.util.concurrent.CompletionException: java.lang.ArithmeticException: / by zero</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exceptionally</span><span class="token punctuation">(</span>throwable <span class="token operator">-&gt;</span> <span class="token punctuation">{</span><span class="token comment">//è‹¥å¼‚æ­¥ä»»åŠ¡å®Œæˆæ—¶å‡ºç°äº†å¼‚å¸¸</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å‡ºç°çš„å¼‚å¸¸æ˜¯&quot;</span> <span class="token operator">+</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//å‡ºç°çš„å¼‚å¸¸æ˜¯java.util.concurrent.CompletionException: java.lang.ArithmeticException: / by zero</span>
            <span class="token keyword">return</span> <span class="token string">&quot;å¦‚æœå‡ºç°å¼‚å¸¸çš„è¯ è¿™é‡Œè¿”å›ä¸€ä¸ªé»˜è®¤å€¼&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenAccept</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¦‚æœå‡ºç°å¼‚å¸¸çš„è¯ è¿™é‡Œè¿”å›ä¸€ä¸ªé»˜è®¤å€¼</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

ä¸‰ï¼š`<span class="token function">completeExceptionally</span><span class="token punctuation">(</span><span class="token punctuation">)</span>`è®©ç»“æœå°±æ˜¯å¼‚å¸¸
    
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> completableFuture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
completableFuture<span class="token punctuation">.</span><span class="token function">completeExceptionally</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Calculation failed!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
completableFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ExecutionException</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç»„åˆä¸¤ä¸ªcompletablefuture" tabindex="-1"><a class="header-anchor" href="#ç»„åˆä¸¤ä¸ªcompletablefuture" aria-hidden="true">#</a> ç»„åˆä¸¤ä¸ªCompletableFuture</h4><ul><li><code>thenComposeAsync</code><strong>æŒ‰é¡ºåºé“¾æ¥</strong>ä¸¤ä¸ª <code>CompletableFuture</code> å¯¹è±¡;<strong>å°†å‰ä¸€ä¸ªä»»åŠ¡çš„è¿”å›ç»“æœä½œä¸ºä¸‹ä¸€ä¸ªä»»åŠ¡çš„å‚æ•°</strong>ï¼Œå®ƒä»¬ä¹‹é—´å­˜åœ¨ç€å…ˆåé¡ºåº</li><li><code>thenCombineAsync</code>ä¼š<strong>åœ¨ä¸¤ä¸ªä»»åŠ¡éƒ½æ‰§è¡Œå®Œæˆå</strong>ï¼ŒæŠŠ<strong>ä¸¤ä¸ªä»»åŠ¡çš„ç»“æœå¤„ç†åè¿”å›ä¸€ä¸ªç»“æœ</strong>ã€‚ä¸¤ä¸ªä»»åŠ¡æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œå®ƒä»¬ä¹‹é—´å¹¶<strong>æ²¡æœ‰å…ˆåä¾èµ–é¡ºåº</strong></li></ul><p><strong>ä¸¤ä¸ªéƒ½å®Œæˆ</strong></p><ul><li><code>runAfterBothAsync</code>ä¸¤ä¸ªå¼‚æ­¥çº¿ç¨‹éƒ½æ‰§è¡Œå®Œåè¿›è¡Œä¸€äº›æ“ä½œå¤„ç† <strong>æ— æ³•æ„ŸçŸ¥</strong>ä¸¤ä¸ªçº¿ç¨‹çš„<strong>æ‰§è¡Œç»“æœ</strong> <strong>æ— è¿”å›å€¼</strong></li><li><code>thenAcceptBothAsync</code>ä¸¤ä¸ªå¼‚æ­¥çº¿ç¨‹éƒ½æ‰§è¡Œå®Œåè¿›è¡Œä¸€äº›æ“ä½œå¤„ç† <strong>èƒ½å¤Ÿæ„ŸçŸ¥</strong>ä¸¤ä¸ªçº¿ç¨‹çš„<strong>æ‰§è¡Œç»“æœ</strong> <strong>æ— è¿”å›å€¼</strong></li></ul><p><strong>ä»»ä¸€å®Œæˆ</strong></p><ul><li><code>applyToEitherAsync</code>ä»»æ„ä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹æ‰§è¡Œå®Œæˆåè¿›è¡Œä¸€äº›æ“ä½œå¤„ç† <strong>èƒ½å¤Ÿæ„ŸçŸ¥</strong>ä¸¤ä¸ªçº¿ç¨‹çš„<strong>æ‰§è¡Œç»“æœ</strong> <strong>è¿”å›ä¸€ä¸ªç»“æœ</strong></li><li><code>acceptEitherAsync</code>ä»»æ„ä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹æ‰§è¡Œå®Œæˆåè¿›è¡Œä¸€äº›æ“ä½œå¤„ç† <strong>èƒ½å¤Ÿæ„ŸçŸ¥</strong>ä¸¤ä¸ªçº¿ç¨‹çš„<strong>æ‰§è¡Œç»“æœ</strong> <strong>æ— è¿”å›å€¼</strong></li><li><code>runAfterEitherAsync</code>ä»»æ„ä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹æ‰§è¡Œå®Œæˆåè¿›è¡Œä¸€äº›æ“ä½œå¤„ç† <strong>æ— æ³•æ„ŸçŸ¥</strong>ä¸¤ä¸ªçº¿ç¨‹çš„<strong>æ‰§è¡Œç»“æœ</strong> <strong>æ— è¿”å›å€¼</strong></li></ul><h4 id="å¹¶è¡Œè¿è¡Œå¤šä¸ª-completablefuture" tabindex="-1"><a class="header-anchor" href="#å¹¶è¡Œè¿è¡Œå¤šä¸ª-completablefuture" aria-hidden="true">#</a> å¹¶è¡Œè¿è¡Œå¤šä¸ª CompletableFuture</h4><p>å¯ä»¥é€šè¿‡ <code>CompletableFuture</code> çš„ <code>allOf()</code>/<code>anyOf()</code>é™æ€æ–¹æ³•æ¥å¹¶è¡Œè¿è¡Œå¤šä¸ª <code>CompletableFuture</code></p><ul><li><code>allOf()</code><strong>ç­‰åˆ°æ‰€æœ‰çš„ <code>CompletableFuture</code> éƒ½è¿è¡Œå®Œæˆä¹‹åå†è¿”å›</strong></li><li>è‹¥çº¿ç¨‹Aå’ŒBè°ƒç”¨ <code>join()</code> å¯ä»¥è®©ç¨‹åºç­‰Aå’ŒBçº¿ç¨‹ éƒ½è¿è¡Œå®Œäº†ä¹‹åå†ç»§ç»­æ‰§è¡Œ</li><li><code>anyOf()</code><strong>ä¸ä¼šç­‰å¾…æ‰€æœ‰çš„ <code>CompletableFuture</code> éƒ½è¿è¡Œå®Œæˆä¹‹åå†è¿”å›ï¼Œåªè¦æœ‰ä¸€ä¸ªæ‰§è¡Œå®Œæˆå³å¯ï¼</strong></li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">-</span> è°ƒç”¨ `<span class="token function">allOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>`<span class="token operator">*</span><span class="token operator">*</span>ç­‰åˆ°æ‰€æœ‰çš„ `<span class="token class-name">CompletableFuture</span>` éƒ½è¿è¡Œå®Œæˆä¹‹åå†è¿”å›<span class="token operator">*</span><span class="token operator">*</span>
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> task1 <span class="token operator">=</span>
  <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
    <span class="token comment">//è‡ªå®šä¹‰ä¸šåŠ¡æ“ä½œ</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> task6 <span class="token operator">=</span>
  <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
    <span class="token comment">//è‡ªå®šä¹‰ä¸šåŠ¡æ“ä½œ</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> headerFuture<span class="token operator">=</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>task1<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>task6<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æŒ‡å®šå¤šä¸ªå¼‚æ­¥çº¿ç¨‹</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    headerFuture<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;all done. &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">-</span> è°ƒç”¨ `<span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>` å¯ä»¥è®©ç¨‹åºç­‰`future1` å’Œ `future2` éƒ½è¿è¡Œå®Œäº†ä¹‹åå†ç»§ç»­æ‰§è¡Œ
    
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> completableFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>future1<span class="token punctuation">,</span> future2<span class="token punctuation">)</span><span class="token punctuation">;</span>
completableFuture<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">assertTrue</span><span class="token punctuation">(</span>completableFuture<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;all futures done...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">-</span> è°ƒç”¨ `<span class="token function">anyOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>`<span class="token operator">*</span><span class="token operator">*</span>ä¸ä¼šç­‰å¾…æ‰€æœ‰çš„ `<span class="token class-name">CompletableFuture</span>` éƒ½è¿è¡Œå®Œæˆä¹‹åå†è¿”å›ï¼Œåªè¦æœ‰ä¸€ä¸ªæ‰§è¡Œå®Œæˆå³å¯ï¼<span class="token operator">*</span><span class="token operator">*</span>
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> f <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">anyOf</span><span class="token punctuation">(</span>future1<span class="token punctuation">,</span> future2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/EddieZturbo/Eddie-Tech-Blog.github.io/edit/main/docs/backend/java/java_concurrency_programming.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page on GitHub" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->Edit this page on GitHub<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><!----><!----></div></footer><nav class="page-nav"><!----><a href="/backend/java/Java.html" class="nav-link next" aria-label="Java Start"><div class="hint">Next<span class="arrow end"></span></div><div class="link">Java Start<!----></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer">Default footer</div><div class="copyright">Copyright Â© 2023 EddieZ</div></footer></div><!--]--><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-7117916c.js" defer></script>
  </body>
</html>
